(()=>{const __INJECTIONS__={tagVersion:"v2.3.7",stackHost:"https://geows.sitelabweb.com",isDemo:0},globals={},scriptLetter="W",snapshotFileSuffix=scriptLetter+"-config.json",FetchConfigs={GET:{method:"GET",mode:"no-cors",cache:"no-cache",headers:{"Content-Type":"application/json"}},POST:{method:"POST",mode:"cors",cache:"no-cache",headers:{"Content-Type":"application/json"}}},COLORS={Red:"#FF0000",Green:"#00FF00",Blue:"#0000FF",White:"#FFFFFF",Black:"#000000",Purple:"#800080",Pink:"#FFC0CB",Orange:"#FFA500",Yellow:"#FFFF00",Brown:"#A52A2A",Grey:"#808080",Gold:"#FFD700",Silver:"#C0C0C0"},Devices={TABLET:"tablet",MOB:"mobile",PC:"pc",TV:"tv"},BOT_DEVICE="bot",SESSION_PERIOD=18e5,QUICK_PV_THRESHOLD=350,browsers=[{values:["yandexbot"],displayName:"Yandex Search"},{values:["yabrowser"],displayName:"Yandex Browser"},{values:["apple mail"],displayName:"Apple Mail"},{values:["snapchat"],displayName:"Snapchat"},{values:["snapchat"],displayName:"Snapchat"},{values:["fbav/","fban/"],displayName:"Facebook"},{values:["pinterest"],displayName:"Pinterest"},{values:["instagram"],displayName:"Instagram"},{values:["gsa/"],displayName:"Google"}],SiteSections={home:"Homepage",cart:"Cart",checkout:"Checkout",product:"Product",category:"Category",orderConfirmation:"Order Confirmation",default:"defaultSiteSection"},EventsTopics={error:"wandz_js_errors",stack:"wandz_stack",prediction_times:"prediction_times"},Channels={DIRECT:"direct",GOOGLE:"google",GOOGLE_ADS:"googleAds",EMAIL:"email",FB:"facebook",FB_ADS:"facebookAds",INST:"instagram",TIKTOK:"tiktok",YOUTUBE:"youtube",TWITTER:"twitter",BING:"bing",OTHER:"other"},OLD_ATTRIBUTES_NAME="aiFeatures",OLD_WANDZ_ATTRIBUTES_NAME="wandzAiFeatures",OLD_CUSTOM_ATTRIBUTES_NAME="customAiFeatures",ATTRIBUTES_NAME="attributes",WANDZ_ATTRIBUTES_NAME="wandzAttributes",CUSTOM_ATTRIBUTES_NAME="customAttributes",_=(()=>{const e="device",t="journey",i="visitor",r="environment",n="installs",s="shopping",a="audiences";return[[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,e,r],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,e,r,"battery"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,e,r,"resolution"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,e,"general"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,e,n],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,e,n,s,"installed"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,e,n,s,"interacted"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,e,n,s,"popped"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,e,"languages"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,e,"settings"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,t,"accessibility"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,t,"flow"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,t,"interactions"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,t,"languages"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,t,"performance"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,t,"time"],["affinity"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,i,"general"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,i,"history"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,i,"location"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,t,"privacy"],[a],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,i,"time"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,i,"weather"],["events"],[ATTRIBUTES_NAME,CUSTOM_ATTRIBUTES_NAME],["predictions"],[a,"customAudiences"],[a,"wandzAudiences"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,t,"memory"],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,i],[ATTRIBUTES_NAME,WANDZ_ATTRIBUTES_NAME,e,n,s],["affinity","customAffinities"]]})(),EVENT_PATH=_[24],EVENT_PATH_DOTTED=EVENT_PATH.join("."),AUDIENCES_PATH=_[28],AUDIENCES_PATH_DOTTED=AUDIENCES_PATH.join("."),CUSTOM_AUDIENCES_PATH=_[27],CUSTOM_AUDIENCES_PATH_DOTTED=CUSTOM_AUDIENCES_PATH.join("."),PREDICTIONS_PATH=_[26],PREDICTIONS_PATH_DOTTED=PREDICTIONS_PATH.join("."),CUSTOM_AI_FEATURES_PATH=_[25],CUSTOM_AI_FEATURES_PATH_DOTTED=CUSTOM_AI_FEATURES_PATH.join("."),CUSTOM_AFFINITIES_PATH=_[32],CUSTOM_AFFINITIES_PATH_DOTTED=CUSTOM_AFFINITIES_PATH.join("."),INSTALLS_SHOPPING_FEATURES_PATH=_[31],INSTALLS_SHOPPING_FEATURES_PATH_DOTTED=INSTALLS_SHOPPING_FEATURES_PATH.join("."),AFFINITY_PATH=_[16],AFFINITY_PATH_DOTTED=AFFINITY_PATH.join("."),FeatureNameToPath={DOMProcessingTime:_[14],TimeToFirstByte:_[14],accessibilityExtensions:_[4],affiliate:_[11],affinityInteractionsWithBlack:_[16],affinityInteractionsWithBlue:_[16],affinityInteractionsWithBrown:_[16],affinityInteractionsWithGold:_[16],affinityInteractionsWithGreen:_[16],affinityInteractionsWithGrey:_[16],affinityInteractionsWithOrange:_[16],affinityInteractionsWithPink:_[16],affinityInteractionsWithPurple:_[16],affinityInteractionsWithRed:_[16],affinityInteractionsWithSilver:_[16],affinityInteractionsWithWhite:_[16],affinityInteractionsWithYellow:_[16],affinityToBrands:_[16],affinityToCategories:_[16],arabicBrowserLanguage:_[8],areMultipleTabsOpen:_[11],areNotificationsApproved:_[9],batteryIsCharging:_[1],batteryPercentageScore:_[1],batteryPercentageValue:_[1],blockThirdPartyCookies:_[20],brandAffinity:_[16],browser:_[3],browserLanguages:_[8],browserVersion:_[3],browsingWithShoppingAffiliate:_[9],browsingWithSocialMediaAffiliate:_[9],browsingWithVideoConferencingAffiliate:_[9],categoryName:_[11],channel:_[11],chineseBrowserLanguage:_[8],city:_[19],clickOnAcceptCookies:_[20],clickOnOuterUrl:_[24],clicksInSessionScore:_[12],clicksInSessionValue:_[12],connectEnd:_[14],connectStart:_[14],connectionTime:_[14],contentLoadTime:_[14],continent:_[19],country:_[19],cpuStrengthScore:_[0],cpuStrengthValue:_[0],cryptoExtensions:_[4],curiousBrowsers:_[28],currency:_[17],dayOfSession:_[15],deviceLayout:_[2],devicePixelRatio:_[2],deviceType:_[3],dnsResolutionTime:_[14],doNotTrackEnabled:_[9],domContentLoadedEventEnd:_[14],domContentLoadedEventStart:_[14],domContentLoadedTime:_[14],domInteractive:_[14],domLoading:_[14],domainLookupEnd:_[14],domainLookupStart:_[14],dutchBrowserLanguage:_[8],engagedVisitor:_[28],engagementWithExtension:_[24],englishBrowserLanguage:_[8],fetchStart:_[14],frenchBrowserLanguage:_[8],germanBrowserLanguage:_[8],hasAdBlocker:_[4],HasAffinityToBrand:_[16],HasAffinityToCategory:_[16],HasAffinityToColor:_[16],hasCameraApproved:_[9],hasForceDarkModeExtensions:_[9],hasLocationApproved:_[9],hasPasswordSaver:_[4],hebrewBrowserLanguage:_[8],hourInDay:_[15],inAppBrowsing:_[11],inAppBrowsingPackage:_[11],inCart:_[11],inCheckout:_[11],inConfirmationPage:_[11],innerHeight:_[2],innerWidth:_[2],interestInsales:_[16],isBot:_[17],isBotEnhanced:_[17],isCopiedText:_[12],isCustomer:_[28],isDarkMode:_[9],isDay:_[15],isDiscountSearched:_[12],isForceDarkMode:_[9],isEngagedUser:_[11],isHostingProvider:_[9],isIncognitoSession:_[9],isOtherBrowserLanguage:_[8],isPageAutoTranslated:_[13],isProxy:_[9],isReturningVisitor:_[28],isTabInFocus:_[11],isTechSavvy:_[28],isTor:_[9],isUndisclosed:_[9],isUserInteractionOccurred:_[12],isUserFrustrated:_[28],isVpn:_[20],italianBrowserLanguage:_[8],jsHeapSizeLimit:_[29],landingPage:_[11],landingSection:_[11],loadEventEnd:_[14],loadEventStart:_[14],locale:_[30],luxuryAffinity:_[16],navigationStart:_[14],navigationType:_[14],networkStrengthScore:_[0],networkStrengthValue:_[0],numberApplyCouponsOnPage:_[24],numberOfCreditCardTriesOnPage:_[24],numberOfLoginTriesOnPage:_[24],numberOfSubmitOrdersOnPage:_[24],numOfCategoryPageViews:_[11],numOfCookieKeys:_[29],numOfDomProperties:_[29],numOfLocalStorageKeys:_[29],numOfOpenTabsScore:_[11],numOfOpenTabsValue:_[11],numOfProductViews:_[11],numOfPurchases:_[18],numOfSessionStorageKeys:_[29],numOfSessions:_[18],numOfWindowObjectKeys:_[29],numberOfBrowserLanguages:_[8],os:_[3],outerHeight:_[2],outerWidth:_[2],pageAccessibilityScore:_[10],pageAccessibilityValue:_[10],pageCategory:_[11],pageCount:_[11],pageDownloadTime:_[14],pageLanguage:_[13],pageLoadScore:_[14],pageLoadTime:_[14],pageLoadValue:_[14],pageRenderTime:_[14],pageTitle:_[11],pageType:_[11],pagesUntilReachedSite:_[11],pageZoom:_[2],polishBrowserLanguage:_[8],prefLanguage:_[8],priceConsciousVisitor:_[28],privacySensitiveVisitor:_[28],productName:_[11],purchase:_[24],pxHeight:_[2],pxWidth:_[2],reachedBottomOfFunnel:_[11],redirectCount:_[14],redirectEnd:_[14],redirectStart:_[14],redirectionTime:_[14],referrer:_[11],requestStart:_[14],responseEnd:_[14],responseStart:_[14],russianBrowserLanguage:_[8],scrollBelowTheFold:_[12],scrollSpeed:_[12],secureConnectionStart:_[14],serverResponseTime:_[14],shopperExtensionsInstalled:_[5],shopperExtensionsInteracted:_[6],shopperExtensionsPopped:_[7],spanishBrowserLanguage:_[8],stateProvince:_[19],tempCRange:_[23],tempCValue:_[23],tempFRange:_[23],tempFValue:_[23],timeOffTabScore:_[11],timeOffTabValue:_[11],timeOnPageScore:_[11],timeOnPageValue:_[11],timeOnSiteScore:_[11],timeOnSiteValue:_[11],timeSinceLastVisitScore:_[18],timeSinceLastVisitValue:_[18],timeToInteractionScore:_[14],timeToInteractionValue:_[14],timeZone:_[15],totalPageCountForVisitor:_[11],ukrainianBrowserLanguage:_[8],unloadEventEnd:_[14],unloadEventStart:_[14],unloadEventTime:_[14],utm_campaign:_[11],utmContent:_[11],utm_source:_[11],vpnProbability:_[20],weatherCondition:_[23],zipcode:_[19],isAmericanAirlines:_[5],isBravoBestPrice:_[5],isCapitalone:_[5],isCoupert:_[5],isDontPayFull:_[5],isHoney:_[5],isKarma:_[5],isKlarna:_[5],isPouch:_[5],isRakuten:_[5],isRetailMeNot:_[5],isSimplyCodes:_[5],numOfInstalled:_[31],numOfInteracted:_[31],numOfPopped:_[31],isAppFbMessengerInstalled:_[4],isBitmojiInstalled:_[4],isGoogleMeetAttendanceListInstalled:_[4],isInssistInstalled:_[4],isPinterestInstalled:_[4],isSkypeInstalled:_[4],isTiktokPixelHelperInstalled:_[4],isTubeBlockInstalled:_[4],isWebexInstalled:_[4],isWeherebyInstalled:_[4],isZoomInstalled:_[4]},BrowserPermissions={Geolocation:"geolocation",Notifications:"notifications",Camera:"camera"},BrowserPermissionToDataPoint={[BrowserPermissions.Geolocation]:"hasLocationApproved",[BrowserPermissions.Notifications]:"areNotificationsApproved",[BrowserPermissions.Camera]:"hasCameraApproved"},WDLStorageKeys={MAIN_STORAGE:"wdlObject",FEATURE_LAST_UPDATED:"featureLastUpdated",CUSTOM_FEATURE_LAST_UPDATED:"customFeatureLastUpdated",PURCHASE_MADE:"wndzPurchaseHasMade",OPEN_TABS:"wndz_openTabsObj"},PopupPositions={TopLeft:"TopLeft",TopCenter:"TopCenter",TopRight:"TopRight",MiddleLeft:"MiddleLeft",MiddleCenter:"MiddleCenter",MiddleRight:"MiddleRight",BottomLeft:"BottomLeft",BottomCenter:"BottomCenter",BottomRight:"BottomRight"},ReminderPositions={TopLeft:"TopLeft",TopCenter:"TopCenter",TopRight:"TopRight",RightTop:"RightTop",RightCenter:"RightCenter",RightBottom:"RightBottom",LeftTop:"LeftTop",LeftCenter:"LeftCenter",LeftBottom:"LeftBottom",BottomLeft:"BottomLeft",BottomCenter:"BottomCenter",BottomRight:"BottomRight"},StringComparisonOperators={EXACT_MATCH:"exactMatch",REGEX_MATCH:"regexMatch",STARTS_WITH:"startsWith",ENDS_WITH:"endsWith",HAS_VALUE:"hasValue",HAS_NO_VALUE:"hasNoValue",CONTAINS:"contains",NOT_CONTAINS:"notContains"},MAX_SIZE_STRING_CHECKING=1e3,AFFINITY_MAX_SIZE_STRING_CHECKING=250,SHOPPING_EXTENSIONS=["isAmericanAirlines","isBravoBestPrice","isCapitalone","isCoupert","isDontPayFull","isHoney","isKarma","isKlarna","isPouch","isRakuten","isRetailMeNot","isSimplyCodes"],SOCIAL_MEDIA_EXTENSIONS=["isInssistInstalled","isTiktokPixelHelperInstalled","isBitmojiInstalled","isPinterestInstalled","isAppFbMessengerInstalled"],VIDEO_CONFERENCING_EXTENSIONS=["isWebexInstalled","isSkypeInstalled","isZoomInstalled","isGoogleMeetAttendanceListInstalled","isWeherebyInstalled"],DARK_MODE_EXTENSIONS={"Dark Reader":{mode:"probe",value:()=>document.querySelector("html").getAttribute("data-darkreader-mode")},"Super Dark Mode":{mode:"url",value:()=>"bkmemecbbfhmgcmfhkjlmdkodfbfponb/data/content_script/general/dark_1.css"},"Dark Mode":{mode:"url",value:()=>"dmghijelimhndkbmpgbldicpogfkceaj/data/content_script/general/dark_1.css"},"Night Eye":{mode:"url",value:()=>"alncdjedloppbablonallfbkeiknmkdi/css/home.css"},"Midnight Lizard":{mode:"url",value:()=>"pbnndmlekkboofhnbonilimejonapojg/js/page-script.js"},"Turn Off the Lights":{mode:"url",value:()=>"bfbmjmiodbnnpllbbbfblcplfjjepjdn/js/video-player-status.js"}},DAYS_OF_WEEK=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],LanguageToFeatureName={zh:"chineseBrowserLanguage",nl:"dutchBrowserLanguage",en:"englishBrowserLanguage",fr:"frenchBrowserLanguage",de:"germanBrowserLanguage",it:"italianBrowserLanguage",pl:"polishBrowserLanguage",ru:"russianBrowserLanguage",es:"spanishBrowserLanguage",uk:"ukrainianBrowserLanguage",he:"hebrewBrowserLanguage",ar:"arabicBrowserLanguage"},SourceTypes={URL:"u",WDL:"wdl",AI_FEATURE:"ai",CUSTOM_AI_FEATURE:"cai",AFFINITY_TO_CATEGORY:"ac",AFFINITY_TO_BRAND:"ab",AFFINITY_TO_COLOR:"c",AFFINITY_TO_CUSTOM:"aca",SECTION:"s",AUDIENCE:"a",CUSTOM_AUDIENCE:"ca",EVENT:"e",PAGE_TITLE:"pt"},{coreLoggerManager:coreLoggerManager,aiLoggerManager:aiLoggerManager}=(()=>{const e="error",t="warn",i="info",r="log";class n{constructor(e="WANDZ",t=!1){this.storageName="_uubsx",this.isEnabled=!1,this.product=e,this.getLogLevel()&&(this.isEnabled=!0,this.logTime=!!sessionStorage&&"1"===sessionStorage.getItem(this.storageName),t&&console.log("%cğŸ… ğŸ… ğŸ…œ ğŸ…-ğŸ…–-ğŸ…-ğŸ…%c  ğŸ…¦ ğŸ… ğŸ… ğŸ…“ ğŸ…©","font-size:30px; color: #ffdf5a; margin: 10px 0;","font-size:30px; color: #0075e1; margin: 10px 0;"))}static getStyle(e,t){return`display: inline-block;border-radius: 25px;padding: 1px 8px;color: white;weight: bold;margin: 2px 0;font-size:10px;background: ${e};border: 2px solid ${e};${t||""}`}static getCallerFunctionName(){try{throw Error()}catch(e){try{return e.stack.split("at ")[4].split(" ")[0]}catch(e){return""}}}info(e,t){this.consoleAction(i,e,t)}warn(e,i){this.consoleAction(t,e,i)}log(e,t){this.consoleAction(r,e,t)}error(t,i){this.consoleAction(e,t,i)}getLogLevel(){return+((localStorage?localStorage.getItem(this.storageName):0)||0)}shouldShowLog(n){if(!this.isEnabled)return!1;const s=this.getLogLevel();switch(n){case e:return s>=1;case t:return s>=2;case i:return s>=3;case r:return s>=4}}getTypeInfo(n){const s=this.product.toUpperCase();return{[e]:{tag:`[${s}-ERROR]`,color:"#c92e2c"},[t]:{tag:`[${s}-WARNING]`,color:"#ffdf5a",additionalStyle:"color: black;"},[i]:{tag:`[${s}-INFO]`,color:"#1078b5"},[r]:{tag:`[${s}-EXTRA-INFO]`,color:"#41B510FF"}}[n]}consoleAction(e,t,i){if(!this.shouldShowLog(e))return;i||(i=n.getCallerFunctionName()+":");const{tag:r,color:s,additionalStyle:a}=this.getTypeInfo(e),o=this.logTime?Math.round(performance.now())/1e3+" ":"",c=n.getStyle(s,a);console[e](`${o}%c ${r}`,c,""+(i||""),t)}}return{coreLoggerManager:new n("WANDZ",!0),aiLoggerManager:new n("AiFeatures")}})(),configurationsGetters=(()=>{const e=new class{constructor(){}init(e){this.snapshot=e,this._currentDomain="",this._runningDomain="",this._mappedDomain="",this._keywords=null,this._params=null,this._aiFeatures=null,this._customAiFeatures=null,this._userEvents=null,this._audiences=null,this._customAudiences=null,this._interactions=null,this._specialColorNameMapping=null}get runningDomain(){return this._runningDomain||""}set runningDomain(e){this._runningDomain=e}get domain(){return this._currentDomain||this._runningDomain||""}get mappedDomain(){return this._mappedDomain||(this._mappedDomain=this.initMappedDomain()),this._mappedDomain}recalculateMappedDomain(){this._mappedDomain=this.initMappedDomain()}initMappedDomain(){let e=window.location.href.toLowerCase(),t="";return Object.keys(this.snapshot.domainsMapping||{}).forEach(i=>{!t&&e.includes(i)&&(t=this.snapshot.domainsMapping[i])}),t}get params(){return this._params||(this._params=this.initParams()),this._params}get aiFeatures(){return this._aiFeatures||(this._aiFeatures=this.initAiFeatures()),this._aiFeatures}get customAiFeatures(){return this._customAiFeatures||(this._customAiFeatures=this.initCustomAiFeatures()),this._customAiFeatures}get userEvents(){return this._userEvents||(this._userEvents=this.initUserEvents()),this._userEvents}get audiences(){return this._audiences||(this._audiences=this.initAudiences()),this._audiences}get customAudiences(){return this._customAudiences||(this._customAudiences=this.initCustomAudiences()),this._customAudiences}get interactions(){return this._interactions||(this._interactions=this.initInteractions()),this._interactions}get specialColorNameMapping(){return this._specialColorNameMapping||(this._specialColorNameMapping=this.initSpecialColorNameMapping()),this._specialColorNameMapping}initSpecialColorNameMapping(){const e=Object.keys(COLORS).reduce((e,t)=>(e[t]=t,e),{});return this.snapshot.colorMapping&&Object.keys(this.snapshot.colorMapping).forEach(t=>{e[t]=this.snapshot.colorMapping[t].c}),this.snapshot.colorTranslations&&Object.keys(this.snapshot.colorTranslations).forEach(t=>{const i=this.snapshot.colorTranslations[t];Object.keys(i).forEach(t=>{e[i[t]]=t})}),Object.keys(e).forEach(t=>{e[t.toLowerCase()]=e[t]}),e}get configurations(){return this.snapshot}get currentDomain(){return this._currentDomain||""}set currentDomain(e){this._currentDomain=e}get versions(){return{js_version:this.snapshot.version,snapshot_version:this.snapshot.snapshotVersion,snapshot_timestamp:this.snapshot.snapshotTimestamp}}get useHangTimeMeasurer(){return!1}initParams(){let e={...this.snapshot.params._||{},...this.snapshot.params._tag||{}};const t=this.domain.toLowerCase();t&&this.snapshot.params[t]&&(e={...e,...this.snapshot.params[t]});const i=this.mappedDomain.toLowerCase();return i&&t!==i&&this.snapshot.params[i]&&(e={...e,...this.snapshot.params[i]}),e}initCustomAiFeatures(){let e=this.snapshot.customAiFeaturesConfig._;const t=this.domain.toLowerCase();this.snapshot.customAiFeaturesConfig[t]&&(e={...e,...this.snapshot.customAiFeaturesConfig[t]});const i=this.mappedDomain.toLowerCase();return i&&t!==i&&this.snapshot.customAiFeaturesConfig[i]&&(e={...e,...this.snapshot.customAiFeaturesConfig[i]}),e||{}}initUserEvents(){let e=this.snapshot.userEvents._;const t=this.domain.toLowerCase();this.snapshot.userEvents[t]&&(e={...e,...this.snapshot.userEvents[t]});const i=this.mappedDomain.toLowerCase();return i&&t!==i&&this.snapshot.userEvents[i]&&(e={...e,...this.snapshot.userEvents[i]}),e||{}}initCustomAudiences(){let e=this.snapshot.customAudiences._;const t=this.domain.toLowerCase();this.snapshot.customAudiences[t]&&(e={...e,...this.snapshot.customAudiences[t]});const i=this.mappedDomain.toLowerCase();return i&&t!==i&&this.snapshot.customAudiences[i]&&(e={...e,...this.snapshot.customAudiences[i]}),e||{}}initInteractions(){if(!this.snapshot.interactions)return[];const e=this.domain.toLowerCase(),t=this.mappedDomain.toLowerCase();return this.snapshot.interactions[e]||this.snapshot.interactions[t]||this.snapshot.interactions._}__initEntityOverrides(e,t){const i=this.domain.toLowerCase(),r=this.mappedDomain.toLowerCase();if(this.snapshot.entityOverrides.inactive&&this.snapshot.entityOverrides.inactive[t]){const n=this.snapshot.entityOverrides.inactive[t][i]||this.snapshot.entityOverrides.inactive[t][r];n&&n.forEach(t=>{delete e[t]})}if(this.snapshot.entityOverrides.active&&this.snapshot.entityOverrides.active[t]){const n=this.snapshot.entityOverrides.active[t][i]||this.snapshot.entityOverrides.active[t][r];n&&Object.keys(n).forEach(t=>{e[t]=n[t]})}return e}initAiFeatures(){let e=this.snapshot.aiFeaturesConfig;return this.snapshot.entityOverrides&&(e=this.__initEntityOverrides(e,"features")),e}initAudiences(){let e=this.snapshot.audiences;return this.snapshot.entityOverrides&&(e=this.__initEntityOverrides(e,"audiences")),e}getCode(e){return this.snapshot.code&&this.snapshot.code[e]||e}isNotLanguageKeyword(e,t="English"){if(!e)return!1;this._keywords||(this._keywords=this.__initKeywords());for(let i in this._keywords)if(i!==t){if(this._keywords[i][e])return!0;if("English"===i&&(this._keywords[i][aiUtils.singularToPlural(e)]||this._keywords[i][aiUtils.pluralToSingular(e)]))return!0}return!1}getKeywordLanguage(e){if(!e)return null;this._keywords||(this._keywords=this.__initKeywords());for(let t in this._keywords)if(this._keywords.hasOwnProperty(t)){if(this._keywords[t][e])return t;if("English"===t&&(this._keywords[t][aiUtils.singularToPlural(e)]||this._keywords[t][aiUtils.pluralToSingular(e)]))return t}return null}__initKeywords(){const e={};if(!this.snapshot.keywordsLang||!Object.keys(this.snapshot.keywordsLang).length)return e;const t=this.domain.toLowerCase(),i=this.mappedDomain.toLowerCase(),r=t=>{t&&Object.keys(t).forEach(i=>{e[i]=e[i]||{},t[i].forEach(t=>{e[i][t]=!0})})};return r(this.snapshot.keywordsLang[t]),i&&t!==i&&r(this.snapshot.keywordsLang[i]),r(this.snapshot.keywordsLang._),e}getFallbackList(e){let t=this.snapshot.fallbackLists[this.domain]||this.snapshot.fallbackLists[this.mappedDomain||this.domain]||this.snapshot.fallbackLists._||[];const i=[],r={};return e&&(t=t.filter(t=>e[t.t])),t.forEach(e=>{const t=e.n;i.push(t);const n=e.language||"English";r[n]||(r[n]=[]),r[n].push(t)}),Object.keys(r).forEach(e=>{r[e]=coreUtils.uniqueArray(r[e])}),{fallbackList:coreUtils.uniqueArray(i),fallbackListByLanguage:r}}};return e})(),{overrides:overrides,setTimeout:setTimeout,setInterval:setInterval}=(()=>{const e=new class{constructor(){}callbackTryCatchWrapper(e){return function(){try{return e.apply(this,arguments)}catch(e){globals.coreTracker&&globals.coreTracker.isReady()&&globals.coreTracker.reportEventsError("sendGetEventViaWebWorker",{message:e.message,stack:e.stack})}}}},t=(Object.getOwnPropertyDescriptor(window,"setTimeout")||Object.getOwnPropertyDescriptor(Window.prototype,"setTimeout")||{}).value,i=(Object.getOwnPropertyDescriptor(window,"setInterval")||Object.getOwnPropertyDescriptor(Window.prototype,"setInterval")||{}).value,r=t?function(i){return i=e.callbackTryCatchWrapper(i),t.apply(this,arguments)}:function(t,i){return window.setTimeout(e.callbackTryCatchWrapper(t),i)},n=i?function(t){return t=e.callbackTryCatchWrapper(t),i.apply(this,arguments)}:function(t,i){return window.setInterval(e.callbackTryCatchWrapper(t),i)};return{overrides:e,setTimeout:r,setInterval:n}})(),coreUtils=(()=>{const e=function(e){function t(r){if(i[r])return i[r].exports;var n=i[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var i={};return t.m=e,t.c=i,t.d=function(e,i,r){t.o(e,i)||Object.defineProperty(e,i,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,i){var r,n;if(1&i&&(e=t(e)),8&i)return e;if(4&i&&"object"==typeof e&&e&&e.__esModule)return e;if(r=Object.create(null),t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&i&&"string"!=typeof e)for(n in e)t.d(r,n,function(t){return e[t]}.bind(null,n));return r},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return{}.hasOwnProperty.call(e,t)},t.p="",t(t.s=90)}({17:function(e,t,i){"use strict";t.__esModule=!0,t.default=void 0;var r=i(18),n=function(){function e(){}return e.getFirstMatch=function(e,t){var i=t.match(e);return i&&i.length>0&&i[1]||""},e.getSecondMatch=function(e,t){var i=t.match(e);return i&&i.length>1&&i[2]||""},e.matchAndReturnConst=function(e,t,i){if(e.test(t))return i},e.getWindowsVersionName=function(e){switch(e){case"NT":return"NT";case"XP":case"NT 5.1":return"XP";case"NT 5.0":return"2000";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}},e.getMacOSVersionName=function(e){var t=e.split(".").splice(0,2).map(function(e){return parseInt(e,10)||0});if(t.push(0),10===t[0])switch(t[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}},e.getAndroidVersionName=function(e){var t=e.split(".").splice(0,2).map(function(e){return parseInt(e,10)||0});if(t.push(0),1!==t[0]||t[1]>=5)return 1===t[0]&&6>t[1]?"Cupcake":1!==t[0]||6>t[1]?2===t[0]&&2>t[1]?"Eclair":2===t[0]&&2===t[1]?"Froyo":2===t[0]&&t[1]>2?"Gingerbread":3===t[0]?"Honeycomb":4===t[0]&&1>t[1]?"Ice Cream Sandwich":4===t[0]&&4>t[1]?"Jelly Bean":4!==t[0]||4>t[1]?5===t[0]?"Lollipop":6===t[0]?"Marshmallow":7===t[0]?"Nougat":8===t[0]?"Oreo":9===t[0]?"Pie":void 0:"KitKat":"Donut"},e.getVersionPrecision=function(e){return e.split(".").length},e.compareVersions=function(t,i,r){void 0===r&&(r=!1);var n=e.getVersionPrecision(t),s=e.getVersionPrecision(i),a=Math.max(n,s),o=0,c=e.map([t,i],function(t){var i=a-e.getVersionPrecision(t),r=t+Array(i+1).join(".0");return e.map(r.split("."),function(e){return Array(20-e.length).join("0")+e}).reverse()});for(r&&(o=a-Math.min(n,s)),a-=1;a>=o;){if(c[0][a]>c[1][a])return 1;if(c[0][a]===c[1][a]){if(a===o)return 0;a-=1}else if(c[0][a]<c[1][a])return-1}},e.map=function(e,t){var i,r=[];if([].map)return[].map.call(e,t);for(i=0;i<e.length;i+=1)r.push(t(e[i]));return r},e.find=function(e,t){var i,r,n;if([].find)return[].find.call(e,t);for(i=0,r=e.length;r>i;i+=1)if(t(n=e[i],i))return n},e.assign=function(e){var t,i,r,n,s,a,o;for(r=e,s=Array((n=arguments.length)>1?n-1:0),a=1;n>a;a++)s[a-1]=arguments[a];if(Object.assign)return Object.assign.apply(Object,[e].concat(s));for(o=function(){var e=s[t];"object"==typeof e&&null!==e&&Object.keys(e).forEach(function(t){r[t]=e[t]})},t=0,i=s.length;i>t;t+=1)o();return e},e.getBrowserAlias=function(e){return r.BROWSER_ALIASES_MAP[e]},e.getBrowserTypeByAlias=function(e){return r.BROWSER_MAP[e]||""},e}();t.default=n,e.exports=t.default},18:function(e,t){"use strict";t.__esModule=!0,t.ENGINE_MAP=t.OS_MAP=t.PLATFORMS_MAP=t.BROWSER_MAP=t.BROWSER_ALIASES_MAP=void 0,t.BROWSER_ALIASES_MAP={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"},t.BROWSER_MAP={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"},t.PLATFORMS_MAP={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"},t.OS_MAP={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"},t.ENGINE_MAP={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"}},90:function(e,t,i){"use strict";var r,n,s,a;t.__esModule=!0,t.default=void 0,n=(r=i(91))&&r.__esModule?r:{default:r},s=i(18),a=function(){function e(){}var t;return e.getParser=function(e,t){if(void 0===t&&(t=!1),"string"!=typeof e)throw Error("UserAgent should be a string");return new n.default(e,t)},e.parse=function(e){return new n.default(e).getResult()},(t=[{key:"BROWSER_MAP",get:function(){return s.BROWSER_MAP}},{key:"ENGINE_MAP",get:function(){return s.ENGINE_MAP}},{key:"OS_MAP",get:function(){return s.OS_MAP}},{key:"PLATFORMS_MAP",get:function(){return s.PLATFORMS_MAP}}])&&function(e,t){var i,r;for(i=0;t.length>i;i++)(r=t[i]).enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}(e,t),e}(),t.default=a,e.exports=t.default},91:function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}var n,s,a,o,c,l;t.__esModule=!0,t.default=void 0,n=r(i(92)),s=r(i(93)),a=r(i(94)),o=r(i(95)),c=r(i(17)),l=function(){function e(e,t){if(void 0===t&&(t=!1),null==e||""===e)throw Error("UserAgent parameter can't be empty");this._ua=e,this.parsedResult={},!0!==t&&this.parse()}var t=e.prototype;return t.getUA=function(){return this._ua},t.test=function(e){return e.test(this._ua)},t.parseBrowser=function(){var e,t=this;return this.parsedResult.browser={},(e=c.default.find(n.default,function(e){if("function"==typeof e.test)return e.test(t);if(e.test instanceof Array)return e.test.some(function(e){return t.test(e)});throw Error("Browser's test function is not valid")}))&&(this.parsedResult.browser=e.describe(this.getUA())),this.parsedResult.browser},t.getBrowser=function(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()},t.getBrowserName=function(e){return e?(this.getBrowser().name+"").toLowerCase()||"":this.getBrowser().name||""},t.getBrowserVersion=function(){return this.getBrowser().version},t.getOS=function(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()},t.parseOS=function(){var e,t=this;return this.parsedResult.os={},(e=c.default.find(s.default,function(e){if("function"==typeof e.test)return e.test(t);if(e.test instanceof Array)return e.test.some(function(e){return t.test(e)});throw Error("Browser's test function is not valid")}))&&(this.parsedResult.os=e.describe(this.getUA())),this.parsedResult.os},t.getOSName=function(e){var t=this.getOS().name;return e?(t+"").toLowerCase()||"":t||""},t.getOSVersion=function(){return this.getOS().version},t.getPlatform=function(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()},t.getPlatformType=function(e){void 0===e&&(e=!1);var t=this.getPlatform().type;return e?(t+"").toLowerCase()||"":t||""},t.parsePlatform=function(){var e,t=this;return this.parsedResult.platform={},(e=c.default.find(a.default,function(e){if("function"==typeof e.test)return e.test(t);if(e.test instanceof Array)return e.test.some(function(e){return t.test(e)});throw Error("Browser's test function is not valid")}))&&(this.parsedResult.platform=e.describe(this.getUA())),this.parsedResult.platform},t.getEngine=function(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()},t.getEngineName=function(e){return e?(this.getEngine().name+"").toLowerCase()||"":this.getEngine().name||""},t.parseEngine=function(){var e,t=this;return this.parsedResult.engine={},(e=c.default.find(o.default,function(e){if("function"==typeof e.test)return e.test(t);if(e.test instanceof Array)return e.test.some(function(e){return t.test(e)});throw Error("Browser's test function is not valid")}))&&(this.parsedResult.engine=e.describe(this.getUA())),this.parsedResult.engine},t.parse=function(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this},t.getResult=function(){return c.default.assign({},this.parsedResult)},t.satisfies=function(e){var t,i,r,n,s,a,o,l=this,d={},u=0,g={},h=0;if(Object.keys(e).forEach(function(t){var i=e[t];"string"==typeof i?(g[t]=i,h+=1):"object"==typeof i&&(d[t]=i,u+=1)}),u>0){if(t=Object.keys(d),i=c.default.find(t,function(e){return l.isOS(e)}),i&&void 0!==(r=this.satisfies(d[i])))return r;if(n=c.default.find(t,function(e){return l.isPlatform(e)}),n&&void 0!==(s=this.satisfies(d[n])))return s}if(h>0&&(a=Object.keys(g),o=c.default.find(a,function(e){return l.isBrowser(e,!0)}),void 0!==o))return this.compareVersion(g[o])},t.isBrowser=function(e,t){void 0===t&&(t=!1);var i=this.getBrowserName().toLowerCase(),r=e.toLowerCase(),n=c.default.getBrowserTypeByAlias(r);return t&&n&&(r=n.toLowerCase()),r===i},t.compareVersion=function(e){var t=[0],i=e,r=!1,n=this.getBrowserVersion();if("string"==typeof n)return">"===e[0]||"<"===e[0]?(i=e.substr(1),"="===e[1]?(r=!0,i=e.substr(2)):t=[],">"===e[0]?t.push(1):t.push(-1)):"="===e[0]?i=e.substr(1):"~"===e[0]&&(r=!0,i=e.substr(1)),t.indexOf(c.default.compareVersions(n,i,r))>-1},t.isOS=function(e){return this.getOSName(!0)===(e+"").toLowerCase()},t.isPlatform=function(e){return this.getPlatformType(!0)===(e+"").toLowerCase()},t.isEngine=function(e){return this.getEngineName(!0)===(e+"").toLowerCase()},t.is=function(e,t){return void 0===t&&(t=!1),this.isBrowser(e,t)||this.isOS(e)||this.isPlatform(e)},t.some=function(e){var t=this;return void 0===e&&(e=[]),e.some(function(e){return t.is(e)})},e}(),t.default=l,e.exports=t.default},92:function(e,t,i){"use strict";var r,n,s,a;t.__esModule=!0,t.default=void 0,n=(r=i(17))&&r.__esModule?r:{default:r},s=/version\/(\d+(\.?_?\d+)+)/i,a=[{test:[/googlebot/i],describe:function(e){var t={name:"Googlebot"},i=n.default.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,e)||n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/opera/i],describe:function(e){var t={name:"Opera"},i=n.default.getFirstMatch(s,e)||n.default.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/opr\/|opios/i],describe:function(e){var t={name:"Opera"},i=n.default.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,e)||n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/SamsungBrowser/i],describe:function(e){var t={name:"Samsung Internet for Android"},i=n.default.getFirstMatch(s,e)||n.default.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/Whale/i],describe:function(e){var t={name:"NAVER Whale Browser"},i=n.default.getFirstMatch(s,e)||n.default.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/MZBrowser/i],describe:function(e){var t={name:"MZ Browser"},i=n.default.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,e)||n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/focus/i],describe:function(e){var t={name:"Focus"},i=n.default.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,e)||n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/swing/i],describe:function(e){var t={name:"Swing"},i=n.default.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,e)||n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/coast/i],describe:function(e){var t={name:"Opera Coast"},i=n.default.getFirstMatch(s,e)||n.default.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe:function(e){var t={name:"Opera Touch"},i=n.default.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,e)||n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/yabrowser/i],describe:function(e){var t={name:"Yandex Browser"},i=n.default.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,e)||n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/ucbrowser/i],describe:function(e){var t={name:"UC Browser"},i=n.default.getFirstMatch(s,e)||n.default.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/Maxthon|mxios/i],describe:function(e){var t={name:"Maxthon"},i=n.default.getFirstMatch(s,e)||n.default.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/epiphany/i],describe:function(e){var t={name:"Epiphany"},i=n.default.getFirstMatch(s,e)||n.default.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/puffin/i],describe:function(e){var t={name:"Puffin"},i=n.default.getFirstMatch(s,e)||n.default.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/sleipnir/i],describe:function(e){var t={name:"Sleipnir"},i=n.default.getFirstMatch(s,e)||n.default.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/k-meleon/i],describe:function(e){var t={name:"K-Meleon"},i=n.default.getFirstMatch(s,e)||n.default.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/micromessenger/i],describe:function(e){var t={name:"WeChat"},i=n.default.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,e)||n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/qqbrowser/i],describe:function(e){var t={name:/qqbrowserlite/i.test(e)?"QQ Browser Lite":"QQ Browser"},i=n.default.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,e)||n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/msie|trident/i],describe:function(e){var t={name:"Internet Explorer"},i=n.default.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/\sedg\//i],describe:function(e){var t={name:"Microsoft Edge"},i=n.default.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/edg([ea]|ios)/i],describe:function(e){var t={name:"Microsoft Edge"},i=n.default.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/vivaldi/i],describe:function(e){var t={name:"Vivaldi"},i=n.default.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/seamonkey/i],describe:function(e){var t={name:"SeaMonkey"},i=n.default.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/sailfish/i],describe:function(e){var t={name:"Sailfish"},i=n.default.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,e);return i&&(t.version=i),t}},{test:[/silk/i],describe:function(e){var t={name:"Amazon Silk"},i=n.default.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/phantom/i],describe:function(e){var t={name:"PhantomJS"},i=n.default.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/slimerjs/i],describe:function(e){var t={name:"SlimerJS"},i=n.default.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e){var t={name:"BlackBerry"},i=n.default.getFirstMatch(s,e)||n.default.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/(web|hpw)[o0]s/i],describe:function(e){var t={name:"WebOS Browser"},i=n.default.getFirstMatch(s,e)||n.default.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/bada/i],describe:function(e){var t={name:"Bada"},i=n.default.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/tizen/i],describe:function(e){var t={name:"Tizen"},i=n.default.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,e)||n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/qupzilla/i],describe:function(e){var t={name:"QupZilla"},i=n.default.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,e)||n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/firefox|iceweasel|fxios/i],describe:function(e){var t={name:"Firefox"},i=n.default.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/electron/i],describe:function(e){var t={name:"Electron"},i=n.default.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/MiuiBrowser/i],describe:function(e){var t={name:"Miui"},i=n.default.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/chromium/i],describe:function(e){var t={name:"Chromium"},i=n.default.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,e)||n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/chrome|crios|crmo/i],describe:function(e){var t={name:"Chrome"},i=n.default.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/GSA/i],describe:function(e){var t={name:"Google Search"},i=n.default.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:function(e){var t=!e.test(/like android/i),i=e.test(/android/i);return t&&i},describe:function(e){var t={name:"Android Browser"},i=n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/playstation 4/i],describe:function(e){var t={name:"PlayStation 4"},i=n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/safari|applewebkit/i],describe:function(e){var t={name:"Safari"},i=n.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/.*/i],describe:function(e){var t=-1!==e.search("\\(")?/^(.*)\/(.*)[ \t]\((.*)/:/^(.*)\/(.*) /;return{name:n.default.getFirstMatch(t,e),version:n.default.getSecondMatch(t,e)}}}],t.default=a,e.exports=t.default},93:function(e,t,i){"use strict";var r,n,s,a;t.__esModule=!0,t.default=void 0,n=(r=i(17))&&r.__esModule?r:{default:r},s=i(18),a=[{test:[/Roku\/DVP/],describe:function(e){var t=n.default.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,e);return{name:s.OS_MAP.Roku,version:t}}},{test:[/windows phone/i],describe:function(e){var t=n.default.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,e);return{name:s.OS_MAP.WindowsPhone,version:t}}},{test:[/windows /i],describe:function(e){var t=n.default.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,e),i=n.default.getWindowsVersionName(t);return{name:s.OS_MAP.Windows,version:t,versionName:i}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(e){var t={name:s.OS_MAP.iOS},i=n.default.getSecondMatch(/(Version\/)(\d[\d.]+)/,e);return i&&(t.version=i),t}},{test:[/macintosh/i],describe:function(e){var t=n.default.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,e).replace(/[_\s]/g,"."),i=n.default.getMacOSVersionName(t),r={name:s.OS_MAP.MacOS,version:t};return i&&(r.versionName=i),r}},{test:[/(ipod|iphone|ipad)/i],describe:function(e){var t=n.default.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,e).replace(/[_\s]/g,".");return{name:s.OS_MAP.iOS,version:t}}},{test:function(e){var t=!e.test(/like android/i),i=e.test(/android/i);return t&&i},describe:function(e){var t=n.default.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,e),i=n.default.getAndroidVersionName(t),r={name:s.OS_MAP.Android,version:t};return i&&(r.versionName=i),r}},{test:[/(web|hpw)[o0]s/i],describe:function(e){var t=n.default.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,e),i={name:s.OS_MAP.WebOS};return t&&t.length&&(i.version=t),i}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e){var t=n.default.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,e)||n.default.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,e)||n.default.getFirstMatch(/\bbb(\d+)/i,e);return{name:s.OS_MAP.BlackBerry,version:t}}},{test:[/bada/i],describe:function(e){var t=n.default.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,e);return{name:s.OS_MAP.Bada,version:t}}},{test:[/tizen/i],describe:function(e){var t=n.default.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,e);return{name:s.OS_MAP.Tizen,version:t}}},{test:[/linux/i],describe:function(){return{name:s.OS_MAP.Linux}}},{test:[/CrOS/],describe:function(){return{name:s.OS_MAP.ChromeOS}}},{test:[/PlayStation 4/],describe:function(e){var t=n.default.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,e);return{name:s.OS_MAP.PlayStation4,version:t}}}],t.default=a,e.exports=t.default},94:function(e,t,i){"use strict";var r,n,s,a;t.__esModule=!0,t.default=void 0,n=(r=i(17))&&r.__esModule?r:{default:r},s=i(18),a=[{test:[/googlebot/i],describe:function(){return{type:"bot",vendor:"Google"}}},{test:[/huawei/i],describe:function(e){var t=n.default.getFirstMatch(/(can-l01)/i,e)&&"Nova",i={type:s.PLATFORMS_MAP.mobile,vendor:"Huawei"};return t&&(i.model=t),i}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Nexus"}}},{test:[/ipad/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/kftt build/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"}}},{test:[/silk/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Amazon"}}},{test:[/tablet(?! pc)/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet}}},{test:function(e){var t=e.test(/ipod|iphone/i),i=e.test(/like (ipod|iphone)/i);return t&&!i},describe:function(e){var t=n.default.getFirstMatch(/(ipod|iphone)/i,e);return{type:s.PLATFORMS_MAP.mobile,vendor:"Apple",model:t}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe:function(){return{type:s.PLATFORMS_MAP.mobile,vendor:"Nexus"}}},{test:[/[^-]mobi/i],describe:function(){return{type:s.PLATFORMS_MAP.mobile}}},{test:function(e){return"blackberry"===e.getBrowserName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.mobile,vendor:"BlackBerry"}}},{test:function(e){return"bada"===e.getBrowserName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.mobile}}},{test:function(e){return"windows phone"===e.getBrowserName()},describe:function(){return{type:s.PLATFORMS_MAP.mobile,vendor:"Microsoft"}}},{test:function(e){var t=+(e.getOSVersion()+"").split(".")[0];return"android"===e.getOSName(!0)&&t>=3},describe:function(){return{type:s.PLATFORMS_MAP.tablet}}},{test:function(e){return"android"===e.getOSName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.mobile}}},{test:function(e){return"macos"===e.getOSName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.desktop,vendor:"Apple"}}},{test:function(e){return"windows"===e.getOSName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.desktop}}},{test:function(e){return"linux"===e.getOSName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.desktop}}},{test:function(e){return"playstation 4"===e.getOSName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.tv}}},{test:function(e){return"roku"===e.getOSName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.tv}}}],t.default=a,e.exports=t.default},95:function(e,t,i){"use strict";var r,n,s,a;t.__esModule=!0,t.default=void 0,n=(r=i(17))&&r.__esModule?r:{default:r},s=i(18),a=[{test:function(e){return"microsoft edge"===e.getBrowserName(!0)},describe:function(e){if(/\sedg\//i.test(e))return{name:s.ENGINE_MAP.Blink};var t=n.default.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,e);return{name:s.ENGINE_MAP.EdgeHTML,version:t}}},{test:[/trident/i],describe:function(e){var t={name:s.ENGINE_MAP.Trident},i=n.default.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:function(e){return e.test(/presto/i)},describe:function(e){var t={name:s.ENGINE_MAP.Presto},i=n.default.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:function(e){var t=e.test(/gecko/i),i=e.test(/like gecko/i);return t&&!i},describe:function(e){var t={name:s.ENGINE_MAP.Gecko},i=n.default.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/(apple)?webkit\/537\.36/i],describe:function(){return{name:s.ENGINE_MAP.Blink}}},{test:[/(apple)?webkit/i],describe:function(e){var t={name:s.ENGINE_MAP.WebKit},i=n.default.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}}],t.default=a,e.exports=t.default}}).getParser(window.navigator.userAgent),t=e=>e&&"NaN"!==e||0===e||!1===e,i=e=>null===e?"null":void 0===e?"undefined":e===window?"global":{}.toString.call(e).match(/\s([a-z|A-Z]+)/)[1].toLowerCase(),r=e=>"undefined"===i(e),n=e=>{const t=e.match(/^(([^:\/?#]+:)?(?:\/\/((?:([^\/?#:]*):([^\/?#:]*)@)?([^\/?#:]*)(?::([^\/?#:]*))?)))?([^?#]*)(\?[^#]*)?(#.*)?$/),i={hash:t[10]||"",host:t[3]||"",hostname:t[6]||"",domainname:s(t[6]),href:decodeURI(t[0]||""),origin:t[1]||"",pathname:decodeURI(t[8]||(t[1]?"/":"")),port:t[7]||"",protocol:t[2]||"",search:t[9]||"",username:t[4]||"",password:t[5]||""};return 2===i.protocol.length&&(i.protocol="file:///"+i.protocol.toUpperCase(),i.origin=i.protocol+"//"+i.host),i.href=i.origin+i.pathname+i.search+i.hash,i},s=e=>{let t=e||"";const i=["www.","https://www.","http://www."];for(let r=0,n=i.length;n>r;r++){const n=i[r];if(t.startsWith(n)){t=e.slice(n.length);break}}return t},a=e=>e.replace(/^\.?|\.?$/g,""),o=()=>n(window.location.href).domainname,c=RegExp("(WebView|(iPhone|iPod|iPad)(?!.*Safari)|Android.*(;\\s+wv|Version/\\d.\\d\\s+Chrome/\\d+(\\.0){3})|Linux; U; Android)","ig"),l=e=>e?e.charAt(0).toUpperCase()+e.slice(1):"",d=e=>(e&&""!==e&&(e=l(e).replace(/\+/g," "),e=decodeURIComponent(e)),e),u=/[^a-z0-9&]/gi,g=(e,t)=>{if(e===t)return!1;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!0;const i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!0;for(let n of i)if(!r.includes(n)||g(e[n],t[n]))return!0;return!1},h=e=>e.toLowerCase().replace(u,"").replaceAll(" ","").trim();let f={};const p=new WeakMap,m=(e,t)=>{if(!e.target)return;if(e.type.startsWith("pointer")&&0!==e.button)return!1;const i=e.timeStamp;return i-(f[t]||0)>=200&&(f[t]=i,!0)},y=(e,t,i)=>{const r=p.get(t);if(!r)return;const{onClick:n,onPointerDown:s,onPointerMove:a,onPointerUp:o}=r;e.removeEventListener("click",n,i),e.removeEventListener("pointerdown",s,{passive:!0}),e.removeEventListener("pointermove",a,{passive:!0}),e.removeEventListener("pointerup",o,{passive:!0}),p.delete(t)},T=e=>{try{const t=e.getBoundingClientRect();return t.width*t.height}catch(e){return aiLoggerManager.error(e,"user-interactions: Error calculating area"),0}};return{bowser:e,throttle:(e,t)=>{let i,r;return function(...n){r?(clearTimeout(i),i=setTimeout(()=>{Date.now()-r<t||(e.apply(this,n),r=Date.now())},t-(Date.now()-r))):(e.apply(this,n),r=Date.now())}},yieldToMain:()=>new Promise(e=>{setTimeout(e,0)}),reformatJsonToKeysAndValues:(e,i)=>{const n=Object.keys(e).length;let s=0,a="",o="",c="";const l=i?t:e=>!r(e);return Object.keys(e).forEach(t=>{const i=e[t];l(i)&&(o=encodeURIComponent(t.replace(/[^\x00-\x7F]/g,"")),c=encodeURIComponent(null===i?i:"null"===i?null:"object"==typeof i?JSON.stringify(i):i.toString()),a+=`${o}=${c}${n>s?"&":""}`),s++}),a.endsWith("&")&&(a=a.slice(0,-1)),a},clone:e=>{try{if(!(e instanceof HTMLElement)&&"function"==typeof structuredClone)return structuredClone(e)}catch(e){coreLoggerManager.error(e,"coreUtils.clone")}return JSON.parse(JSON.stringify(e))},isUndefined:r,isNumber:e=>"number"===i(e)&&!isNaN(e),isString:e=>"string"===i(e),isBoolean:e=>"boolean"===i(e),isObject:e=>"object"===i(e),isArray:e=>"array"===i(e),isFunction:e=>["function","asyncfunction"].indexOf(i(e))>=0,isNullish:e=>[null,void 0].some(t=>e===t),parseUrl:n,getBrowser:()=>{const t=e.getBrowserName(!0);return t===window.navigator.userAgent.toLowerCase()?"Unknown":t},getOS:()=>e.getOSName(!0),getDevice:()=>e.getPlatformType(!0).replace("desktop",Devices.PC),getDeviceName:()=>e.getPlatform().model||"",findRelevantDomain:(e,t)=>{const i=o();try{return"exact"===e?t.indexOf(i)>-1?(coreLoggerManager.info(`'${i}' found the exact domain: '${i}'`,"findRelevantDomain"),i):(coreLoggerManager.info(`'${i}' didn't match (exact) to any of the domains'`,"findRelevantDomain"),null):(()=>{const e=a(i).split("."),r=t.sort((e,t)=>e.split(".").length>t.split(".").length?-1:1);for(let t=0,n=r.length;n>t;t++){const n=r[t],s=a(n).split(".");let o=!0;for(let t=s.length-1,i=e.length-1;t>=0;t--,i--)if(s[t]!==e[i]){o=!1;break}if(o)return coreLoggerManager.info(`'${i}' found the most specific (includes) domain: '${n}'`,"findRelevantDomain"),n}return coreLoggerManager.info(`'${i}' didn't match (includes) to any of the domains'`,"findRelevantDomain"),null})()}catch(e){return coreLoggerManager.error("Failed to find relevant domain with error "+e,"findRelevantDomain"),null}},getCurrentDomain:o,generateRandomString:e=>{let t=e||5,i="";for(;t--;)i+="ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz".charAt(Math.floor(51*Math.random()));return i},getCookie:(e,t)=>{if(t||(t=document.cookie),!t)return"";const i=t.split(/;\s*/),r={};let n,s;for(let t=0,a=i.length;a>t;t++){const a=i[t];n=a.indexOf("=");try{-1!==n&&(s=decodeURIComponent(a.slice(0,n).trim())),s&&(r[s]=decodeURIComponent((a.slice(n+1)||"").trim()))}catch(e){-1!==n&&(s=a.slice(0,n).trim()),s&&(r[s]=(a.slice(n+1)||"").trim())}if(e&&s===e)return r[s]}return e?"":r},generateUUID:()=>{const e=[];for(let t=0;256>t;t++)e[t]=(16>t?"0":"")+t.toString(16);const t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,r=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]+e[255&i]+e[i>>8&255]+e[i>>16&255]+e[i>>24&255]+e[255&r]+e[r>>8&255]+e[r>>16&255]+e[r>>24&255]+e[255&n]+e[n>>8&255]+e[n>>16&255]+e[n>>24&255]},isInAppView:e=>!(!e||!e.match(c)),toTitleCase:l,beautifyChannel:d,getUTMChannelName:e=>e?d(e):"Unspecified UTM",getQueryParamsAsObject:()=>{try{const e=location.search.slice(1).replaceAll(/[?]+/g,"?").replaceAll(/[&]+/g,"&").replaceAll(/[=]+/g,"=");return JSON.parse('{"'+e.replaceAll("?","").replaceAll("&",'","').replaceAll("=",'":"')+'"}')}catch(e){return null}},extractDomain:e=>{if(!e)return null;let t=e.split("."),i=t.length;return 2>i?t[0]:4===i||3===i&&3>=t[i-2].length?t[i-3]:t[i-2]},timestampToUtc:e=>new Date(e).toISOString().replace(/T/," ").replace(/\..+/,""),uniqueArray:e=>{const t=[];let i=0,r=e.length;for(;r>i;i++)-1===t.indexOf(e[i])&&""!==e[i]&&t.push(e[i]);return t},getDomainFromUrl:e=>{if(!e)return e;let t;return t=e.split("/").length>2?e.split("/")[2].split(":")[0]:e,t},getRandomElements:(e,t)=>e.sort(()=>.5-Math.random()).slice(0,t),affinityNameToFeature:e=>e.toLowerCase().split(" ").map(e=>l(e)).join(" ").replace(u,"").replace(/&/g,"And"),featureToAffinityName:e=>e.split(/(?=[A-Z])/).map(e=>"And"===e?"&":e.toLowerCase()).join(" "),asNumbers:(e,t=!1)=>e.map(e=>{const i=parseInt(e,10);return isNaN(i)?t?void 0:e:i}),hasDiff:g,get:(e,t,i)=>{if(!e||"object"!=typeof e)return i;const r=Array.isArray(t)?t:t.match(/([^[.\]])+/g);if(!r)return i;let n=e;for(let e of r)if(n=null===n?void 0:n[e],void 0===n)return i;return n},normalizeJsChannel:e=>{if(!e||"Direct"===e)return Channels.DIRECT;let t="";const i=h(e),r={};return Object.values(Channels).forEach(e=>{r[h(e)]=e}),t=r[i],t||Object.keys(r).sort((e,t)=>t.length-e.length).forEach(e=>{!t&&i.includes(e)&&(t=r[e])}),t||(t=Channels.OTHER),t},clickAllowed:m,addClickHandler:(e,t,i,r={})=>{p.has(i)&&y(t,i,r);let n=0,s=0,a=!1,o=null;const c=e=>{"mouse"!==e.pointerType&&0===e.button&&(n=e.clientX,s=e.clientY,a=!0,o=setTimeout(()=>{a=!1},500))},l=e=>{a&&(Math.abs(e.clientX-n)>10||Math.abs(e.clientY-s)>10)&&(a=!1,clearTimeout(o))},d=t=>{a&&(clearTimeout(o),a=!1,m(t,e)&&i(t))},u=t=>{m(t,e)&&i(t)};t.addEventListener("click",u,r),t.addEventListener("pointerdown",c,{passive:!0}),t.addEventListener("pointermove",l,{passive:!0}),t.addEventListener("pointerup",d,{passive:!0}),p.set(i,{onClick:u,onPointerDown:c,onPointerMove:l,onPointerUp:d,options:r})},removeClickHandler:y,isElementVisible:e=>{const t=window.getComputedStyle(e);return"none"!==t.display&&"hidden"!==t.visibility&&"0"!==t.opacity&&T(e)>0},isElementWithinViewport:e=>{const t=e.getBoundingClientRect();return!(0>t.top||0>t.left||t.bottom>(window.innerHeight||document.documentElement.clientHeight)||t.right>(window.innerWidth||document.documentElement.clientWidth))},isElementPartiallyInViewport:e=>{const t=e.getBoundingClientRect(),i=window.innerHeight||document.documentElement.clientHeight;if(t.top>=0&&t.bottom<=i)return!0;const r=Math.max(t.top,0),n=Math.min(t.bottom,i);return Math.max(0,n-r)>=.2*i},calculateArea:T}})(),NmgWorker=class{constructor(e,t=null,i={}){this.workerCallback=e,this.resultCallback=t;const r={waitForTerminate:!1,fallbackToMainThread:!1,isWorkerSupported:!!configurationsGetters.params.useWebWorker};this.options={...r,...i},this.isWorkerSupported=!!(window.Worker&&window.URL&&window.URL.createObjectURL)&&this.options.isWorkerSupported}run(t,i){if(t=t||{},i=i||{},this.isWorkerSupported)try{const r=this.workerCallback.toString(),n=Object.keys(i).map(e=>`const ${e} = ${i[e].toString()};`).join("\n"),s=new Blob([`\n                        onmessage = function(e) {\n                            const params = e.data;\n                            ${n}\n                            const func = ${r};\n                            const postMessage = self.postMessage.bind(self);\n                            const terminateWorker = () => {\n                                self.close();\n                                postMessage('terminate');\n                            };\n                            func(params);\n                        }\n                    `],{type:"application/javascript"}),a=window.URL.createObjectURL(s),o=new Worker(a),c=this.resultCallback,l=this.options.waitForTerminate,d=()=>{window.URL.revokeObjectURL(a),o.terminate()};o.onmessage=function(e){"terminate"===e.data?d():(c&&c(e.data),l||d())},o.onerror=function(e){coreLoggerManager.error(e,"NmgWorker.run.onerror"),d()},o.onmessageerror=function(){coreLoggerManager.error(e,"NmgWorker.run.onmessageerror"),d()},o.postMessage(t)}catch(e){coreLoggerManager.warn("Some exception when use Worker. Try to not use it: "+e,"NmgWorker.run"),this.isWorkerSupported=!1,this.run(t,i)}else if(this.options.fallback)this.options.fallback();else if(this.options.fallbackToMainThread){const e=this.resultCallback,r=t=>{"terminate"!==t&&e&&e(t)};try{i.terminateWorker=()=>{},i.postMessage=r;const e=Object.keys(i).join(",");Function("args","helperFunctions",`const {${e}}=helperFunctions;return (${this.workerCallback.toString()})(args);`)(t,i)}catch(e){coreLoggerManager.error("Unable to run the Worker callback in the main thread! "+e,"NmgWorker.run")}}}},{coreTracker:coreTracker,dynamicTracker:dynamicTracker}=(()=>{function e(e,t){return t=t||{},{action:EventsTopics.error,client_tag:e,href:decodeURI(window.location.href).slice(0,4e3),domain:coreUtils.parseUrl(window.location.href).hostname,user_agent:navigator.userAgent.slice(0,1024),device_type:coreUtils.getDevice(),browser:coreUtils.getBrowser(),os:coreUtils.getOS(),cb:Date.now(),message:t.message,stack:t.stack,module:t.module||"core"}}const t=["Object.entries is not a function","SecurityError: Failed to read the 'localStorage' property from 'Window'","SecurityError: The operation is insecure"];class i{constructor(e=""){this.ready=!1,this.name=e}static shouldBeIgnored(e){let i=JSON.stringify({event:e});for(let e=0,r=t.length;r>e;e++)if(i.includes(t[e]))return!0;return!1}init(e,t){this.host=e,this.productEndpoint=t,this.ready=!0}isReady(){return this.ready}async sendPostEvent(e){if(coreLoggerManager.info(e,"Stack-event (POST):"),i.shouldBeIgnored(e))return;const t=await this.getDataToSend(e);this.fetchWrapper(`${this.host}/${this.productEndpoint}`,{...FetchConfigs.POST,body:t})}async sendGetEvent(e){if(coreLoggerManager.info(e,"Stack-event (GET):"),i.shouldBeIgnored(e))return;const t=await this.getDataToSend(e),r=`${this.name?this.name+"|":""}${e.pv}|${e.cycle}`;this.fetchWrapper(`${this.host}/${this.productEndpoint}?${t}`,FetchConfigs.GET,r)}async sendGetEventViaWebWorker(e){try{if(coreLoggerManager.info(e,"Stack-event (GET-WB):"),i.shouldBeIgnored(e))return;const t=await this.getDataToSend(e),r=`${this.name?this.name+"|":""}${e.pv}|${e.cycle}`,n=`${this.host}/${this.productEndpoint}?${t}`,s=new NmgWorker(e=>{const t=e.url,i=e.FetchConfigs,r=e.requestId;fetch(t,i.GET).then(e=>{postMessage({status:e.status||200,requestId:r})},e=>{postMessage({status:e&&e.message?e.message:e+"",requestId:r})}).catch(e=>{postMessage({status:e&&e.message?e.message:e+"",requestId:r})})},e=>{e&&this.saveRequestStatus(e.requestId,e.status)},{fallback:()=>this.sendGetEvent(e)});s.run({url:n,FetchConfigs:FetchConfigs,requestId:r})}catch(t){await this.sendGetEvent(e)}}async sendPostEventViaWebWorker(e){try{if(coreLoggerManager.info(e,"Stack-event (POST-WB):"),i.shouldBeIgnored(e))return;const t=await this.getDataToSend(e),r={...FetchConfigs.POST,body:t},n=`${this.host}/${this.productEndpoint}`,s=new NmgWorker(({url:e,init:t})=>{fetch(e,t)},e=>{console.log(e)},{fallback:()=>this.sendPostEvent(e)});s.run({url:n,init:r})}catch(t){await this.sendPostEvent(e)}}reportEventsStack(e,t){this[e](t).catch()}reportEventsError(t,i,r){const n=r?e(r,i):function(t){return{...e(configurationsGetters.configurations.tag,t),user_id:dal.session.getOne("user_id"),session_id:dal.session.getOne("session_id"),pv:dal.session.getOne("pv"),...configurationsGetters.versions}}(i);this[t](n).catch()}async getDataToSend(e){return coreUtils.reformatJsonToKeysAndValues(e)}fetchWrapper(e,t,i=""){try{fetch(e,t).then(e=>(this.saveRequestStatus(i,(e.status||200)+""),e),t=>{coreLoggerManager.info(`Failed to report event. url: ${e}, err: ${t}`,"stack-error"),this.saveRequestStatus(i,t&&t.message?t.message:t+"")}).catch(t=>{coreLoggerManager.info(`Failed to report event (catch). url: ${e}, err: ${t}`,"stack-error"),this.saveRequestStatus(i,t&&t.message?t.message:t+"")})}catch(e){coreLoggerManager.info("Failed in fetch-wrapper. err: "+e,"stack-error"),this.saveRequestStatus(i,e&&e.message?e.message:e+"")}}saveRequestStatus(e,t){if(!e||!configurationsGetters.params.sendStackStatus)return;const i=dal.session.getOne("stack_obj")||{};i[e]=t,dal.session.set({stack_obj:i})}}return{coreTracker:new i,dynamicTracker:new i("dynamicTracker")}})();globals.coreTracker=coreTracker;const{prepareSnapshot:prepareSnapshot}={prepareSnapshot:async(e,t)=>{const i=t=>(coreLoggerManager.error("Failed to get config file from cdn","prepareSnapshot"),coreTracker.reportEventsError("sendGetEvent",{message:`Failed in snapshot fetch. path: ${l}, e: ${t}`},e),null),r=async e=>{try{return await fetch(e)}catch(e){return e.message}};if(!e||!t)return null;globals.cdnUrl=t;let n={text:"",failureData:{failed:!1,error:""}};const s=new Date;s.setHours(0,0,0,0);const a=s.getTime(),o=window.location.hostname.replace(/^www\d?\./,"").replace(/\./g,"_"),c=`${t}${e}${snapshotFileSuffix.replace("-",`-${o}-`)}?v=${a}`,l=`${t}${e}${snapshotFileSuffix}?v=${a}`;try{let e=await r(c);if(e.ok||(coreLoggerManager.warn(`Failed to fetch snapshot from domain path: ${c}, trying the default path: ${l}.\nStatus: `+(e.status?e.status.toString():"N/A")+"\nText: "+(e.text?await e.text():e),"prepareSnapshot"),e=await r(l)),n.failureData.failed=!e.ok,n.failureData.error=e.status.toString(),n.text=await e.text(),n.failureData.failed)return n.text=`${n.text}, status code: ${n.failureData.error}`,i(n.text)}catch(e){return i(e.message)}try{const e=n.text?n.text.trim():"",t=JSON.parse(e);return t.domains&&t.domains.length||(t.domains=[]),t.version=__INJECTIONS__.tagVersion,t}catch(e){const t=n.text&&n.text.length||0;return i(`Failed to decompress with error: ${e}, length: ${t}, first 30: '${t>0?n.text.slice(0,30):""}', last 30: '${t>30?n.text.slice(t-30):""}'`)}}},notifier=new class{constructor(){this.listeners={},this.counter={}}clear(){this.listeners={},this.counter={}}bind(e,t){coreUtils.isString(e)&&coreUtils.isFunction(t)&&(this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t))}retroBind(e,t){this.bind(e,t);const i=this.count(e);i&&i.forEach(e=>this.callbacksWrapper(t,e))}unbind(e){this.listeners[e]=[]}fire(e,...t){const i=this.prepareFire(e,t);i&&i.functions.forEach(e=>(e=>{setTimeout(()=>{this.callbacksWrapper(e,t)},0)})(e))}fireSync(e,...t){const i=this.prepareFire(e,t);let r=[];if(i)return i.functions.forEach(e=>{return i=e,void(r[r.length]=i.apply(i,t));var i}),r}prepareFire(e,t){const i={functions:this.listeners[e]||[]};return this.counter[e]||(this.counter[e]=[]),this.counter[e].push(t),i}count(e){return this.counter[e]}callbacksWrapper(e,t){new Promise((i,r)=>{try{const n=e.apply(e,t);n instanceof Promise?n.then(i).catch(r):i(n)}catch(e){r(e)}}).catch(async e=>{try{coreLoggerManager.error(e,"notifier.callbacksWrapper"),coreTracker.reportEventsError("sendGetEventViaWebWorker",{message:e.message,stack:e.stack})}catch(e){coreLoggerManager.error(e,"notifier.callbacksWrapper (catch)")}})}},domUtils=new class{constructor(){this.firedEvents={}}firePageLoadWhenReady(){const e=this;let t;const i=function(i){t&&"page-load"===i&&clearInterval(t),e.firedEvents[i]||(e.firedEvents[i]=!0,notifier.fire(i))};configurationsGetters.params.timeToStartWorkIfNoPageload&&(t=window.setInterval(()=>{coreLoggerManager.warn(`Fire 'page-load' event because of ${configurationsGetters.params.timeToStartWorkIfNoPageload} ms passed.`,"domUtils"),i("page-load")},configurationsGetters.params.timeToStartWorkIfNoPageload));const r=function(){"complete"===document.readyState&&document.body?(i("DOMContentLoaded"),i("page-load")):window.setTimeout(r,50)};r(),window.addEventListener&&"complete"!==document.readyState&&document.addEventListener("DOMContentLoaded",function(){i("DOMContentLoaded")},!1);const n=document.onreadystatechange||function(){};document.onreadystatechange=function(e){n(e),"complete"===document.readyState&&(document.onreadystatechange=n,i("DOMContentLoaded"),i("page-load"))}}},mutationObserverHandler=new class{constructor(){this.observers={},this.ready=!1}add(e,t){this.observers[e]=t,this.ready||this.initObserver()}remove(e){delete this.observers[e],Object.keys(this.observers).length||this.deactivateObserver()}initObserver(){this.mainObserver=new MutationObserver(this.handleMutations.bind(this)),this.mainObserver.observe(document,{subtree:!0,childList:!0,attributes:!0}),this.ready=!0}handleMutations(e){Object.entries(this.observers).forEach(([t,i])=>{try{i(e)}catch(e){coreLoggerManager.warn(`Error in handleMutation [${t}]: ${e}`,"handleMutations")}})}deactivateObserver(){this.mainObserver&&this.mainObserver.disconnect(),this.ready=!1}},spaHandler=new class{isRunning=!1;oldURL=location.href;constructor(){}listenToUrlChanges(e){this.isRunning||(this.isRunning=!0,mutationObserverHandler.add("spaHandler",()=>{const t=location.href;t!==this.oldURL&&(this.oldURL=t,e())}))}},storageManagers=(()=>{class e{constructor(e){this.storageManageName=e,this.memoryStorage=this.getRelevantStorage(),this.hasUnsavedChanges=!1,this.onReloadCallbacks={},this.forcePersist=!1,this.forceLoad=!1}static getStorage(e){if(!localStorage)return{};const t=localStorage.getItem(e)||null;t||localStorage.setItem(e,JSON.stringify({}));try{return JSON.parse(t)||{}}catch(i){return coreLoggerManager.error(t,`StorageManager.getStorage: Unable to parse the storage [${e}]: ${i}`),{}}}reloadStorage(){this.memoryStorage=this.getRelevantStorage(),Object.entries(this.onReloadCallbacks).forEach(([e,t])=>{try{t()}catch(t){coreLoggerManager.error(`Unable to execute onReload callback [${e}]: ${t}`,"StorageManager.reloadStorage")}})}onReload(e,t){this.onReloadCallbacks[e]=t}getItem(e,t=!1){let i;return i=t||this.forceLoad?this.getRelevantStorage():this.memoryStorage,i[e]}setItem(e,t,i=!1){localStorage&&(this.memoryStorage[e]=t,this.hasUnsavedChanges=!0,(i||this.forcePersist)&&this.persistStorage(e))}persistStorage(e="",t=!1){if(this.hasUnsavedChanges&&!window.__wandz_wdl_save_disabled){if(e){const t=this.getRelevantStorage();t[e]=this.memoryStorage[e],this.localStorageSetItem(this.storageManageName,JSON.stringify(t))}else this.localStorageSetItem(this.storageManageName,JSON.stringify(this.memoryStorage)),t&&coreLoggerManager.info(JSON.stringify(this.memoryStorage),this.storageManageName+" Storage persist");this.hasUnsavedChanges=!1}}localStorageSetItem(e,t){try{return localStorage.setItem(e,t),null}catch(i){const r=`${i.message} - local storage item: '${e}', value length: ${t.length}`;coreLoggerManager.warn(i,r);try{return coreTracker.isReady()&&coreTracker.reportEventsError("sendGetEventViaWebWorker",{message:r,stack:i.stack}),r}catch(e){}}}getRelevantStorage(){return e.getStorage(this.storageManageName)}}return new class{constructor(){this.isReady=!1,this.sharedStorageItemName="",this.storageManagers={}}init(){this.isReady||(this.isReady=!0,this.sharedStorageItemName=__INJECTIONS__.isDemo?"wandz-demo":"wandz",this.storageManagers={[this.sharedStorageItemName]:new e(this.sharedStorageItemName)})}getStorageManager(t){let i;return t||(t=this.sharedStorageItemName),Object.keys(this.storageManagers).includes(t)?i=this.storageManagers[t]:(i=new e(t),this.storageManagers[t]=i),i}persistAll(e=!1){Object.values(this.storageManagers).forEach(t=>t.persistStorage("",e))}markAllForce(){Object.values(this.storageManagers).forEach(e=>e.forcePersist=!0)}reloadAll(){Object.values(this.storageManagers).forEach(e=>e.reloadStorage())}}})(),beforeunloadHandler=(()=>{const e=new class{constructor(){this.ready=!1,this.wasHandled=!1,this.regularHandlers={},this.persistStorageHandler=null,this.sendReportHandler=null}init(){if(this.wasHandled=!1,this.ready)return;this.ready=!0;const t=()=>{if(!e.wasHandled){if(e.wasHandled=!0,Object.keys(e.regularHandlers).forEach(t=>{try{e.regularHandlers[t]()}catch(e){coreLoggerManager.error(e,`BeforeunloadHandler: Failed to call [${t}] handler:`)}}),e.persistStorageHandler)try{e.persistStorageHandler()}catch(e){coreLoggerManager.error(e,"BeforeunloadHandler: Failed to call [persistStorageHandler] handler:")}if(e.sendReportHandler)try{e.sendReportHandler()}catch(e){coreLoggerManager.error(e,"BeforeunloadHandler: Failed to call [sendReportHandler] handler:")}}};window.addEventListener("beforeunload",t,!0),notifier.unbind("beforeunload"),notifier.bind("beforeunload",t),coreLoggerManager.info("Init complete","BeforeunloadHandler")}addRegular(e,t){this.regularHandlers[e]=t}addPersistStorageHandler(e){this.persistStorageHandler=e}addSendReportHandler(e){this.sendReportHandler=e}};return e})(),dal=(()=>{class e{constructor(){this.tableData={}}get(e=!0){return e?coreUtils.clone(this.tableData):this.tableData}getOne(e){return coreUtils.clone(this.tableData[e])}set(e,t=!1,i=!1){let r,n=0;for(r in e){const t=e[r]&&coreUtils.clone(e[r]);coreUtils.isUndefined(e[r])||!i&&!coreUtils.hasDiff(this.tableData[r],t)||(this.tableData[r]=t,++n)}return(n>0||t)&&this.onchangeFunction&&!i&&this.onchangeFunction(t),n}onchange(e){coreUtils.isFunction(e)&&(this.onchangeFunction=e)}}return(new class{constructor(){this.dalObj={session:new e,hookReader:new e}}get dal(){return this.dalObj}}).dal})(),session=(()=>{const e=new class{constructor(){this.timestamp=Date.now(),this.sessionName="sessionData",this.sessionIdLocalStorageKey=__INJECTIONS__.isDemo?"wandz-session-id-demo":"wandz-session-id",this.isGenerated=!1,this.ready=!1,this.sessionWasExpired=!1,this.isNewUser=!1}init(t){this.resetLocals(),this.conf=t,this.storageManager=storageManagers.getStorageManager(),dal.session.onchange(this.sessionChanged);const i=this.storageManager.getItem(this.sessionName)||{};this.storageManager.setItem(this.sessionName,dal.session.get(!1)),this.storageManager.onReload("session",()=>{dal.session.set(e.storageManager.getItem(e.sessionName),!1,!0)}),this.processSession(i),this.ready=!0}resetLocals(){this.conf={},this.timestamp=Date.now(),this.isGenerated=!1,this.ready=!1,this.sessionWasExpired=!1,this.isNewUser=!1}isReady(){return this.ready}generateSessionData(e){const t=Object.assign({user_id:coreUtils.generateUUID(),session_id:coreUtils.generateUUID(),pv:1,pv_counter:1,session_counter:1,ust:this.timestamp,sst:this.timestamp,tos:0,pvst_obj:{},stack_obj:{},pvst:this.timestamp,lpvst:this.timestamp,lsst:this.timestamp,lset:this.timestamp},e,dal.session.get());t.pvst_obj[t.pvst]||(t.pvst_obj[t.pvst]=1),t.pv=Object.keys(t.pvst_obj).length,dal.session.set(t),this.isGenerated=!0}getDailySessionNumber(e){return!e.lset||Date.now()>new Date(e.lset).getDate()||(new Date).getMonth()>new Date(e.lset).getMonth()?1:e.dsn+1}processSession(t){if(coreLoggerManager.info(t,"existing session: "),t&&t.user_id||(e.isNewUser=!0),t.user_id&&t.pvst&&this.timestamp-t.pvst>=SESSION_PERIOD){e.sessionWasExpired=!0;const i=this.getDailySessionNumber(t);t={user_id:t.user_id,session_id:coreUtils.generateUUID(),etag_user_id:t.etag_user_id||"",etag_session_id:"",pv_counter:t.pv_counter||0,session_counter:+(t.session_counter||0)+1,ust:t.ust,lsst:t.sst,lset:t.pvst,dsn:i,sst:this.timestamp,tos:0,isFirstCoreStackCall:!0,colorPreferencesFrequencies:t.colorPreferencesFrequencies||{},affinityTimestamps:t.affinityTimestamps,customAffinityTimestamps:t.customAffinityTimestamps,affinityCategoryKeywords:t.affinityCategoryKeywords,affinityAccumulator:t.affinityAccumulator,accumulatorVersion:t.accumulatorVersion,productPageViews:{},categoryPageViewCount:0,pvst_obj:{},traffic_source:"",app_referrer:"",model_targets:{},adaptiveSearchConf:t.adaptiveSearchConf,abTestsConf:t.abTestsConf,adaptiveCarouselConf:t.adaptiveCarouselConf,disableColorDetectionFromImage:t.disableColorDetectionFromImage,failedColorDetectionFromImageCounter:0}}const i=Object.keys(t.pvst_obj||{}).length,r=i+1,n=(t.pv_counter||i)+r-i;let s,a;s=1===r||coreUtils.isUndefined(t.performanceTimingEnable)?configurationsGetters.params.measure_js_performance>Math.random():t.performanceTimingEnable,a=1===r||coreUtils.isUndefined(t.useDynamicTracker)?(configurationsGetters.params.useDynamicTrackerChance||0)>Math.random():t.useDynamicTracker,a&&configurationsGetters.params.dynamicTrackerHost&&configurationsGetters.params.dynamicTrackerPath&&(dynamicTracker.init(configurationsGetters.params.dynamicTrackerHost,configurationsGetters.params.dynamicTrackerPath),coreLoggerManager.info(`Dynamic Tracker was enabled with the ${configurationsGetters.params.useDynamicTrackerChance} chance to ${configurationsGetters.params.dynamicTrackerHost}/${configurationsGetters.params.dynamicTrackerPath}`,"Session: ")),t.pvst&&this.timestamp-t.pvst<QUICK_PV_THRESHOLD&&(coreLoggerManager.warn(this.timestamp-t.pvst,"Session: looks like quick PV - use prev. timestamp."),this.timestamp=t.pvst),dal.session.set({pvst:this.timestamp,lpvst:t.pvst,pv:r,pv_counter:n,href:decodeURI(window.location.href),prevURL:t.href||decodeURI(window.location.href),ud:(t.ud||0)+((t.pvst||0)-(t.lpvst||0)),dsn:t.dsn||1,traffic_source:t.traffic_source,isFirstCoreStackCall:void 0===t.isFirstCoreStackCall||t.isFirstCoreStackCall,performanceTimingEnable:+s,useRawTracker:+a,...e.sessionWasExpired?t:{}}),this.generateSessionData(t),this.storageManager.setItem(this.sessionName,dal.session.get(),!0),localStorage.setItem(this.sessionIdLocalStorageKey,dal.session.getOne("session_id")),notifier.fire("session-ready")}sessionChanged(t){e.isGenerated&&e.storageManager.setItem(e.sessionName,dal.session.get(),t),notifier.fire("session-change")}};return e})(),hookReader=new class{constructor(){this.ready=!1}init(e){this.resetLocals();const t=configurationsGetters.mappedDomain,i=configurationsGetters.domain;this.hookReader={},Object.keys(e).forEach(r=>{const n=e[r],s=n.domain;s&&s!==i&&s!==t||(this.hookReader[r]=n)}),this.storageManager=storageManagers.getStorageManager(),notifier.bind("hook-cycle",this.updateHooksValues.bind(this)),this.ready=!0}resetLocals(){this.ready=!1}isReady(){return this.ready}getHook(e,t){if(!e[t])return"";const i=e[t];if(!i.readFrom)return"";const r=i.key;let n,s;switch(i.readFrom.toLowerCase()){case"cookie":n=coreUtils.getCookie(r);break;case"localstorage":n=window.localStorage.getItem(r)||null;break;case"sessionstorage":n=window.sessionStorage.getItem(r)||null;break;case"memory":case"window":n=coreUtils.get(window,r);break;case"session":n=dal.session.getOne(r)}let a=i.parser;try{s=coreUtils.isUndefined(a)||null===a||""===a||coreUtils.isUndefined(n)||null===n||""===n?n:((e,t,i)=>Function("rawVal","context",`const {coreUtils,dal}=context;const parser = ${t};return parser(rawVal);`)(e,i))(n,a,{coreUtils:coreUtils,dal:dal})}catch(e){coreLoggerManager.error(e)}return"sessionid"===i.role&&s!==dal.hookReader.getOne("clientSessionId")&&dal.hookReader.set({clientSessionId:s}),0===s?0:!1!==s&&(s||void 0)}updateHooksValues(){const e=dal.hookReader.get();let t;try{const i={};let r="";for(t in this.hookReader){if(!this.hookReader.hasOwnProperty(t))continue;const n=this.getHook(this.hookReader,t);coreUtils.isUndefined(n)||(r=this.hookReader[t].param||"client_attr"+t,e[r]!==n&&(i[r]=n))}if(0!==Object.keys(i).length){const e={},t=dal.hookReader.get(!1);Object.entries(i).forEach(([i,r])=>{t[i]!==r&&(/client_attr[1234]/.test(i)?e[i]=r:(e.client_attr_json=e.client_attr_json||{},e.client_attr_json[i]=r),r&&("cnv"===i&&(e.is_conversion=1),"cnvid"===i&&(e.order_id=r)))}),Object.keys(e).length&&coreReports.extendDelta(e),dal.hookReader.set(i)}}catch(e){throw Error(`Failed in updateHooksValues: ${e} , Param Name : ${t?this.hookReader[t].param:"unknown"}`)}}},predictions=(()=>{const e={...FetchConfigs.GET,mode:"cors"},t=new class{async init(){this.probes={},this.targetProbes={},this.idToNameMapping={},this.isBot=!1,this.device="",this.checkedModels={},this.modelsToSend=[],this.host=configurationsGetters.params.predictionServerHost||"",this.dataToSendBackwards={},this.scoreToSendBackwards={},this.modelTargets=dal.session.getOne("model_targets")||{};const e=configurationsGetters.domain,t=configurationsGetters.mappedDomain;(configurationsGetters.configurations.models||[]).forEach(i=>{if(!i.d||e===i.d||t===i.d){if(void 0===this.modelTargets[i.guid]&&(this.probes[i.guid]=this.prepareProbe(i.xb,i.a),i.tr&&i.tr.r&&i.tr.r.length)){const e="or"===i.tr.c?aiUtils.orBunch:aiUtils.andBunch,t=this.prepareTargetProbe(i.tr.r);this.targetProbes[i.guid]={isSpecialTarget:i.tr.r.some(e=>"notContains"===e.op),probe:()=>e(t)}}this.idToNameMapping[i.guid]=i.n}}),Object.keys(this.modelTargets).length&&notifier.retroBind("wdl-ready",function(){this.setTargetPredictions(this.modelTargets,!1)}.bind(this)),notifier.bind("pageDataCollected",this.start.bind(this))}getPredictionsToSend(){if(!Object.keys(this.dataToSendBackwards).length)return{};const e={...this.dataToSendBackwards};return this.dataToSendBackwards={},e}getPredictionsScoreToSend(){if(!Object.keys(this.scoreToSendBackwards).length)return{};const e={...this.scoreToSendBackwards};return this.scoreToSendBackwards={},e}getModelTargets(){if(!Object.keys(this.modelTargets).length)return{};const e={...this.modelTargets};return this.modelTargets={},e}start(){aiLoggerManager.info("Start","predictions"),this.isBot=!(!wdl.get("isBotEnhanced","aiFeature")&&!wdl.get("isBot","aiFeature")),this.device=wdl.device.toLowerCase(),this.performCheckAndPrediction()}performCheckAndPrediction(){this.checkEligibility(),this.modelsToSend.length?this.doPredictionCall():aiLoggerManager.info("No models to send","predictions")}checkEligibility(){const e={};Object.entries(this.probes).forEach(([t,i])=>{if(!this.checkedModels[t]&&i()){if(aiLoggerManager.info(`[${t}][${this.idToNameMapping[t]}] model is eligible to predict.`,"predictions.checkEligibility"),this.checkedModels[t]=!0,this.targetProbes[t]){const i=this.targetProbes[t].probe(),r=this.targetProbes[t].isSpecialTarget;if(i!==r)return this.modelTargets[t]=e[t]=+!r,void aiLoggerManager.info(`[${t}][${this.idToNameMapping[t]}] model target was calculated as [${e[t]}]. No need to predict.`,"predictions.checkEligibility")}this.modelsToSend.push(t)}}),Object.keys(e).length&&this.setTargetPredictions(e)}prepareProbe(e,i){return()=>(!e||!t.isBot)&&aiUtils.checkForTarget({c:i.c,d:i.d,a:i.s,ca:["All"]})}doPredictionCall(){const e=[...this.modelsToSend];if(this.modelsToSend=[],aiLoggerManager.info(`Do prediction call for ${e.length} models: ${e.map(e=>this.idToNameMapping[e]).join(", ")}`,"predictions.doPredictionCall"),!configurationsGetters.params.predictionCallsAllowed||!this.host)return void aiLoggerManager.warn("Prediction calls does not allowed or no host provided in the config!","predictions.doPredictionCall");const t=dal.session.get(!1),i={clientTag:configurationsGetters.configurations.tag,domain:configurationsGetters.mappedDomain||configurationsGetters.domain,userId:t.user_id,sessionId:t.session_id,page_cb:t.pvst,page_cb_timestamp:coreUtils.timestampToUtc(t.pvst),cycle:coreReports.cycle,cycle_timestamp:coreUtils.timestampToUtc(coreReports.cycleTimestamp)},r={action:EventsTopics.prediction_times,client_tag:i.clientTag,domain:i.domain,user_id:i.userId,session_id:i.sessionId,page_cb:i.page_cb,page_cb_timestamp:i.page_cb_timestamp,cycle:i.cycle,cycle_timestamp:i.cycle_timestamp},n=e.length?wdl.getFeaturesList(configurationsGetters.configurations.predictionFeatures||[],!0):{};if(e.length&&!Object.keys(n).length)return void aiLoggerManager.warn(e,"predictions.doPredictionCall: There are no aiFeatures to send - no need to send models.");const s=[],a=configurationsGetters.params.predictionModelsChunkSize,o=e.length;if(a&&o>a){const t=Math.ceil(o/Math.ceil(o/a));for(let r=0;o>r;r+=t){const a=e.slice(r,r+t);s.push([coreUtils.reformatJsonToKeysAndValues({...i,aiFeatures:n,modelsArray:a}),a])}}else s.push([coreUtils.reformatJsonToKeysAndValues({...i,aiFeatures:n,modelsArray:e}),e]);s.forEach(([e,t])=>{const i=`${this.host}/predict?${e}`;if(this.performPredictionCallByWorker(i,!1,r,t),configurationsGetters.params.testPredictionServerHost&&configurationsGetters.params.testPredictionServerHost!==this.host){const i=`${configurationsGetters.params.testPredictionServerHost}/predict?${e}`;aiLoggerManager.info("Test prediction call to "+configurationsGetters.params.testPredictionServerHost,"predictions.doPredictionCall"),this.performPredictionCallByWorker(i,!0,r,t)}})}performPredictionCallByWorker(i,r,n,s){const a=new NmgWorker(e=>{const t=e.url,i=e.fetchConfig,r=Date.now();fetch(t,i).then(e=>{if(!e.ok)throw Error("Network response was not ok");let t={};return e.headers.forEach((e,i)=>{t[i]=e}),e.json().then(e=>({headers:t,data:e}))},e=>postMessage(e)).then(e=>postMessage({data:e,requestStartTime:r,requestEndTime:Date.now()}),e=>postMessage(e))},e=>{if(e instanceof Error)return aiLoggerManager.error(e,"predictions.performPredictionCallByWorker"),void t.sendTimes(n,s,-1,-1,r);t.sendTimes(n,s,e.requestStartTime,e.requestEndTime,r),r?aiLoggerManager.info("Drop response from test prediction server. Response:\n"+JSON.stringify(e),"predictions.performPredictionCallByWorker"):t.processPredictionResponse(e.data)},{fallbackToMainThread:!0});a.run({url:i,fetchConfig:e})}processPredictionResponse(e){if(aiLoggerManager.info("Process response from prediction server","predictions.processResponse"),aiLoggerManager.info(e,"predictions.processResponse"),!e)return void aiLoggerManager.error(e,"predictions.processResponse: No data to process!");const t=(e.data||{}).predictions||[];t.length&&wdl.setPredictions(t.map(e=>{const t=this.idToNameMapping[e.model_id];return this.dataToSendBackwards[e.model_id]=e.prediction,this.scoreToSendBackwards[e.model_id]=e.prediction_score,{modelName:t,predictionResult:{prediction:e.prediction,prediction_score:e.prediction_score}}}))}setTargetPredictions(e,t=!0){if(t){let t=dal.session.getOne("model_targets")||{};dal.session.set({model_targets:{...t,...e}})}wdl.setPredictions(Object.keys(e).map(t=>{const i=this.idToNameMapping[t];return i?{modelName:i,predictionResult:{prediction:e[t],prediction_score:1}}:null}).filter(e=>e))}prepareTargetProbe(e){return e.map(e=>generateTargetReachedProbe(e))}sendTimes(e,t,i,r,n){configurationsGetters.params.predictionTimesCallsAllowed&&coreTracker.reportEventsStack("sendGetEventViaWebWorker",{...e,models:t,request_start_time:i,request_end_time:r,prediction_host:n?configurationsGetters.params.testPredictionServerHost:void 0})}};return t})(),{extractColorFromPageInnerText:extractColorFromPageInnerText,extractColorFromPageSelectors:extractColorFromPageSelectors}=(()=>{let e=null;const t=()=>{e=RegExp("(?:^|\\s|\\W|\\b|_)("+Object.keys(configurationsGetters.specialColorNameMapping).join("|")+")(?:$|\\s|\\W|\\b|_)","i")},i=t=>{if(!t.innerText)return null;if(t.innerText.length>AFFINITY_MAX_SIZE_STRING_CHECKING)return null;if(3>t.innerText.length)return null;const i=t.innerText.match(e);return i&&3>i.length?i[0].toLowerCase():null},r=e=>1200>e.getBoundingClientRect().top+window.scrollY;return{extractColorFromPageInnerText:()=>{e||t();const i=cleanRawColorNames(Array.from(document.body.innerText.matchAll(/(?:colou?rs?|couleurs?|colou?ri|colores?|farb[ae]n?|cores?|è‰²|ã‚«ãƒ©ãƒ¼)\s*(?:\s*:\s*|\s*-\s+|\s+)(?<color>[^-]*?)(?:\n|\s|\r|\r\n)/gi)).map(t=>(t=>{if(t.length>50)return null;const i=t.match(e);return i&&3>i.length?i[0].toLowerCase():null})(t.groups.color.trim())).filter(e=>e));return i&&1===i.length?i[0]:null},extractColorFromPageSelectors:()=>{e||t();let n="";const s=Array.from(document.querySelectorAll(".selected")).filter(e=>r(e)).map(e=>i(e)).filter(e=>e);1===s.length&&(n=s[0]);let a=Array.from(document.querySelectorAll("*:not(script):not(link):not(meta):not(style):not(:has(*)):not(:empty), select"));a=a.filter(e=>r(e));let o=a.map(function(e){const t=i(e);return{element:e,include:null!==t,isSelect:"select"===e.tagName.toLowerCase(),color:t}});o=o.filter(e=>e.include);let c={};for(let e=0,t=o.length;t>e;e++){const t=o[e],r=c[t.color]||[];if(t.isSelect){const e=t.element.selectedIndex?t.element.selectedIndex:0,n=i(t.element.options[e]);n&&(r.push(t.element.getAttribute("id")+","+t.element.getAttribute("class")),c[n]=r);continue}r.push(t.element.getAttribute("id")+","+t.element.getAttribute("class")),c[t.color]=r}let l="";return l=n&&c[n]?n:(e=>{const t=Object.keys(e);let i=null;if(t.length>0){let r=0;for(let n=0;n<t.length;n++){const s=t[n];e[s].length>r&&(i=s,r=e[s].length)}}return i||""})(c),l&&cleanRawColorNames([l])[0]||""}}})(),{cleanRawColorNames:cleanRawColorNames,setColorAffinities:setColorAffinities,getDetectedColors:getDetectedColors,checkColorsInText:checkColorsInText,colorsFromText:colorsFromText}=(()=>{const e=function(){var e,t=function(e,t){return t>e?-1:e>t?1:0},r=function(e){return e.reduce(function(e,t){return e+t},0)},n=function(){function e(e){this.colors=e}var t=e.prototype;return t.palette=function(){return this.colors},t.map=function(e){return e},e}(),s=function(){function e(e,t,i){return(e<<10)+(t<<5)+i}function i(e){function t(){i.sort(e),r=!0}var i=[],r=!1;return{push:function(e){i.push(e),r=!1},peek:function(e){return r||t(),void 0===e&&(e=i.length-1),i[e]},pop:function(){return r||t(),i.pop()},size:function(){return i.length},map:function(e){return i.map(e)},debug:function(){return r||t(),i}}}function s(e,t,i,r,n,s,a){var o=this;o.r1=e,o.r2=t,o.g1=i,o.g2=r,o.b1=n,o.b2=s,o.histo=a}function a(){this.vboxes=new i(function(e,i){return t(e.vbox.count()*e.vbox.volume(),i.vbox.count()*i.vbox.volume())})}function o(t,i){var r,n,s,a,o,c,l,d,u,g;if(i.count()){if(r=i.r2-i.r1+1,n=i.g2-i.g1+1,s=Math.max.call(null,r,n,i.b2-i.b1+1),1==i.count())return[i.copy()];if(d=0,u=[],g=[],s==r)for(a=i.r1;a<=i.r2;a++){for(l=0,o=i.g1;o<=i.g2;o++)for(c=i.b1;c<=i.b2;c++)l+=t[e(a,o,c)]||0;u[a]=d+=l}else if(s==n)for(a=i.g1;a<=i.g2;a++){for(l=0,o=i.r1;o<=i.r2;o++)for(c=i.b1;c<=i.b2;c++)l+=t[e(o,a,c)]||0;u[a]=d+=l}else for(a=i.b1;a<=i.b2;a++){for(l=0,o=i.r1;o<=i.r2;o++)for(c=i.g1;c<=i.g2;c++)l+=t[e(o,c,a)]||0;u[a]=d+=l}return u.forEach(function(e,t){g[t]=d-e}),function(e){var t,r,n,s,o,c=e+"1",l=e+"2",h=0;for(a=i[c];a<=i[l];a++)if(u[a]>d/2){for(n=i.copy(),s=i.copy(),o=(t=a-i[c])>(r=i[l]-a)?Math.max(i[c],~~(a-1-t/2)):Math.min(i[l]-1,~~(a+r/2));!u[o];)o++;for(h=g[o];!h&&u[o-1];)h=g[--o];return n[l]=o,s[c]=n[l]+1,[n,s]}}(s==r?"r":s==n?"g":"b")}}return s.prototype={volume:function(e){var t=this;return t._volume&&!e||(t._volume=(t.r2-t.r1+1)*(t.g2-t.g1+1)*(t.b2-t.b1+1)),t._volume},count:function(t){var i,r,n,s,a=this,o=a.histo;if(!a._count_set||t){for(s=0,i=a.r1;i<=a.r2;i++)for(r=a.g1;r<=a.g2;r++)for(n=a.b1;n<=a.b2;n++)s+=o[e(i,r,n)]||0;a._count=s,a._count_set=!0}return a._count},copy:function(){var e=this;return new s(e.r1,e.r2,e.g1,e.g2,e.b1,e.b2,e.histo)},avg:function(t){var i,r,n,s,a,o,c,l,d=this,u=d.histo;if(!d._avg||t)if(a=0,o=0,c=0,l=0,d.r1===d.r2&&d.g1===d.g2&&d.b1===d.b2)d._avg=[d.r1<<3,d.g1<<3,d.b1<<3];else{for(r=d.r1;r<=d.r2;r++)for(n=d.g1;n<=d.g2;n++)for(s=d.b1;s<=d.b2;s++)a+=i=u[e(r,n,s)]||0,o+=i*(r+.5)*8,c+=i*(n+.5)*8,l+=i*(s+.5)*8;d._avg=a?[~~(o/a),~~(c/a),~~(l/a)]:[~~(8*(d.r1+d.r2+1)/2),~~(8*(d.g1+d.g2+1)/2),~~(8*(d.b1+d.b2+1)/2)]}return d._avg},contains:function(e){var t=this,i=e[0]>>3;return gval=e[1]>>3,bval=e[2]>>3,!(i<t.r1||i>t.r2||gval<t.g1||gval>t.g2||bval<t.b1||bval>t.b2)}},a.prototype={push:function(e){this.vboxes.push({vbox:e,color:e.avg()})},palette:function(){return this.vboxes.map(function(e){return e.color})},size:function(){return this.vboxes.size()},map:function(e){for(var t=this.vboxes,i=0;i<t.size();i++)if(t.peek(i).vbox.contains(e))return t.peek(i).color;return this.nearest(e)},nearest:function(e){for(var t,i,r,n=this.vboxes,s=0;s<n.size();s++)((i=Math.sqrt(Math.pow(e[0]-n.peek(s).color[0],2)+Math.pow(e[1]-n.peek(s).color[1],2)+Math.pow(e[2]-n.peek(s).color[2],2)))<t||void 0===t)&&(t=i,r=n.peek(s).color);return r},forcebw:function(){var e,i,n,s=this.vboxes;s.sort(function(e,i){return t(r(e.color),r(i.color))}),5>(e=s[0].color)[0]&&5>e[1]&&5>e[2]&&(s[0].color=[0,0,0]),(n=s[i=s.length-1].color)[0]>251&&n[1]>251&&n[2]>251&&(s[i].color=[255,255,255])}},{quantize:function(r,c){function l(e,t){var i,r,n,s,a,c;for(r=e.size(),n=0;1e3>n;){if(r>=t)return;if(n++>1e3)return;if((i=e.pop()).count()){if(a=(s=o(p,i))[0],c=s[1],!a)return;e.push(a),c&&(e.push(c),r++)}else e.push(i),n++}}var d,u,g,h,f,p,m,y,T,w;if(!Number.isInteger(c)||1>c||c>256)throw Error("Invalid maximum color count. It must be an integer between 1 and 256.");if(!r.length||2>c||c>256)return!1;if(!r.length||2>c||c>256)return!1;for(d=[],u=new Set,g=0;g<r.length;g++)f=(h=r[g]).join(","),u.has(f)||(u.add(f),d.push(h));if(d.length<=c)return new n(d);for(p=function(t){var i,r=Array(32768);return t.forEach(function(t){i=e(t[0]>>3,t[1]>>3,t[2]>>3),r[i]=(r[i]||0)+1}),r}(r),p.forEach(function(){}),m=function(e,t){var i,r,n,a=1e6,o=0,c=1e6,l=0,d=1e6,u=0;return e.forEach(function(e){(i=e[0]>>3)<a?a=i:i>o&&(o=i),(r=e[1]>>3)<c?c=r:r>l&&(l=r),(n=e[2]>>3)<d?d=n:n>u&&(u=n)}),new s(a,o,c,l,d,u,t)}(r,p),y=new i(function(e,i){return t(e.count(),i.count())}),y.push(m),l(y,.75*c),T=new i(function(e,i){return t(e.count()*e.volume(),i.count()*i.volume())});y.size();)T.push(y.pop());for(l(T,c),w=new a;T.size();)w.push(T.pop());return w}}}().quantize,a=function(e){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.width=this.canvas.width=e.naturalWidth,this.height=this.canvas.height=e.naturalHeight,this.context.drawImage(e,0,0,this.width,this.height)};return a.prototype.getImageData=function(){return this.context.getImageData(0,0,this.width,this.height)},(e=function(){}).prototype.getColor=function(e,t){return void 0===t&&(t=10),this.getPalette(e,5,t)[0]},e.prototype.getPalette=function(e,t,i){var r=function(e){var t=e.colorCount,i=e.quality;if(void 0!==t&&Number.isInteger(t)){if(1===t)throw Error("colorCount should be between 2 and 20. To get one color, call getColor() instead of getPalette()");t=Math.min(t=Math.max(t,2),20)}else t=10;return(void 0===i||!Number.isInteger(i)||1>i)&&(i=10),{colorCount:t,quality:i}}({colorCount:t,quality:i}),n=new a(e),o=function(e,t,i){for(var r,n,s,a,o,c=e,l=[],d=0;t>d;d+=i)n=c[0+(r=4*d)],s=c[r+1],a=c[r+2],(void 0===(o=c[r+3])||o>=125)&&(n>250&&s>250&&a>250||l.push([n,s,a]));return l}(n.getImageData().data,n.width*n.height,r.quality),c=s(o,r.colorCount);return c?c.palette():null},e.prototype.getColorFromUrl=function(e,t,i){var r=this,n=document.createElement("img");n.addEventListener("load",function(){var s=r.getPalette(n,5,i);t(s[0],e)}),n.src=e},e.prototype.getImageData=function(e,t){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){var e,r,n,s,a;if(200==this.status){for(e=new Uint8Array(this.response),i=e.length,r=Array(i),n=0;n<e.length;n++)r[n]=String.fromCharCode(e[n]);s=r.join(""),a=window.btoa(s),t("data:image/png;base64,"+a)}},r.send()},e.prototype.getColorAsync=function(e,t,i){var r=this;this.getImageData(e,function(e){var n=document.createElement("img");n.addEventListener("load",function(){var e=r.getPalette(n,5,i);t(e[0],this)}),n.src=e})},e}(),t=function(){function e(t,r){var n,s,a,o,c;if(!(t=i(t)))return null;for(s=1/0,r||(r=e.DEFAULT_COLORS),c=0;c<r.length;++c)a=r[c].rgb,s>(n=Math.pow(t.r-a.r,2)+Math.pow(t.g-a.g,2)+Math.pow(t.b-a.b,2))&&(s=n,o=r[c]);return o.name?{name:o.name,value:o.source,rgb:o.rgb,distance:Math.sqrt(s)}:o.source}function t(e){return e instanceof Array?e.map(function(e){return r(e)}):Object.keys(e).map(function(t){return r(e[t],t)})}function i(t){var r,s;if("object"==typeof t)return t;if(t in e.STANDARD_COLORS)return i(e.STANDARD_COLORS[t]);if(r=t.match(/^#?((?:[0-9a-f]{3}){1,2})$/i))return r=3===(r=r[1]).length?[r.charAt(0)+r.charAt(0),r.charAt(1)+r.charAt(1),r.charAt(2)+r.charAt(2)]:[r.substring(0,2),r.substring(2,4),r.substring(4,6)],{r:parseInt(r[0],16),g:parseInt(r[1],16),b:parseInt(r[2],16)};if(s=t.match(/^rgb\(\s*(\d{1,3}%?),\s*(\d{1,3}%?),\s*(\d{1,3}%?)\s*\)$/i))return{r:n(s[1]),g:n(s[2]),b:n(s[3])};throw Error('"'+t+'" is not a valid color')}function r(e,t){var n,a={};if(t&&(a.name=t),"string"==typeof e)a.source=e,a.rgb=i(e);else if("object"==typeof e){if(e.source)return r(e.source,e.name);a.rgb=e,a.source="#"+s((n=e).r.toString(16))+s(n.g.toString(16))+s(n.b.toString(16))}return a}function n(e){return"%"===e.charAt(e.length-1)?Math.round(255*parseInt(e,10)/100):+e}function s(e){return 1===e.length&&(e="0"+e),e}return e.from=function i(r){var n=t(r),s=e,a=function(e){return s(e,n)};return a.from=i,a.or=function(i){var r=n.concat(t(i));return e.from(r)},a},e.STANDARD_COLORS={aqua:"#0ff",black:"#000",blue:"#00f",fuchsia:"#f0f",gray:"#808080",green:"#008000",lime:"#0f0",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#ffa500",purple:"#800080",red:"#f00",silver:"#c0c0c0",teal:"#008080",white:"#fff",yellow:"#ff0"},e.DEFAULT_COLORS=t(["#f00","#f80","#ff0","#0f0","#00f","#008","#808"]),e}();let r=null;const n=e=>{const t=e.reduce((e,t)=>(configurationsGetters.specialColorNameMapping[t]&&(e[configurationsGetters.specialColorNameMapping[t]]=1),e),{});return Object.keys(t)},s=e=>{const t=e.toString(16);return 1===t.length?"0"+t:t},a={cropped:{},notCropped:{}},o=(i,o,c)=>{if(a[o?"cropped":"notCropped"][c])return;a[o?"cropped":"notCropped"][c]=1;const d=new Image;d.crossOrigin="Anonymous",d.onload=((i,a=!1,o="")=>()=>{aiLoggerManager.info(o,`detectNearestColor: Image (${a?"":"not "}cropped) checking for color affinity:`);const c=new e;let d;try{d=[c.getColor(i,1)]}catch(e){return void aiLoggerManager.error(e,"detectNearestColor: Unable to getColor!")}if(!d)return void aiLoggerManager.error(d,"detectNearestColor: Unable to getColor! colorRgb is ");const g=d.map(e=>{return"#"+s((t=e)[0])+s(t[1])+s(t[2]);var t});u(((e,i="",s=!1)=>{if(!r){const e={...COLORS};configurationsGetters.configurations.colorMapping&&Object.keys(configurationsGetters.configurations.colorMapping).forEach(t=>{e[t]=configurationsGetters.configurations.colorMapping[t].h}),r=t.from(e)}const a=e.map(e=>r(e));aiLoggerManager.info(a,`detectNearestColor: Image (${s?"":"not "}cropped) [ ${i} ] nearest color:\n`);const o=a.map(e=>e.name),c=n(o);return aiLoggerManager.info(c,`detectNearestColor: Image (${s?"":"not "}cropped) [ ${i} ] mapped nearest color:\n`),c})(g,o,a),l())})(d,o,c),d.onerror=e=>{aiLoggerManager.error(e.target||e,"detectNearestColor: Unable to check the image for color affinity:");let t=dal.session.getOne("failedColorDetectionFromImageCounter")||0;t++,t>3?(aiLoggerManager.warn("failedColorDetectionFromImageCounter = "+t,"AffinityToColor: top checking for color affinity from image!"),dal.session.set({disableColorDetectionFromImage:1,failedColorDetectionFromImageCounter:t},!0)):dal.session.set({failedColorDetectionFromImageCounter:t},!0)},d.src=i},c=(e,t=null)=>{if(!e)return;let i=e.getAttribute("src");if(i||(i=e.getAttribute("srcset")||e.getAttribute("data-srcset"),i&&(i=i.split(",")[0].split(" ")[0])),!i)return void aiLoggerManager.warn(e,"AffinityToColor: image has no src or srcset!");if(a.cropped[i]&&a.notCropped[i])return;const r=`class="${e.className||""} id="${e.id||""}"`.toLowerCase(),n=["logo","search","icon"].filter(e=>aiUtils.wordInText(e,r));if(n.length)return void aiLoggerManager.warn(n,`AffinityToColor: Service attributes detected in [${r}]`);const s=e.getAttribute("alt")||"",c=h(`${i} ${s}`.toLowerCase())||[];if(c.length)return aiLoggerManager.info(c,`AffinityToColor detected from the image URL ${i} (or alt: ${s}) - no need to look deeper: `),void u(c,l());if(!(()=>{let e=configurationsGetters.params.disableColorDetectionFromImage,t=dal.session.getOne("disableColorDetectionFromImage");return e!==t&&(t?configurationsGetters.params.disableColorDetectionFromImageFixed&&(t=e,dal.session.set({disableColorDetectionFromImage:e},!0)):(dal.session.set({disableColorDetectionFromImage:e},!0),t=e)),!t})())return void aiLoggerManager.warn(e,"AffinityToColor: color detection from image is not allowed");const d=document.createElement("canvas"),g=d.getContext("2d");if(t){const i=document.createElement("canvas"),r=i.getContext("2d"),n=e.getBoundingClientRect(),s=t.clientX-n.left,a=t.clientY-n.top;i.width=e.width,i.height=e.height,r.drawImage(e,0,0,e.width,e.height);const o=50,c=o/2,l=Math.max(0,s-c),u=Math.max(0,a-c),h=Math.min(e.width,s+c),f=Math.min(e.height,a+c);d.width=o,d.height=o,g.drawImage(i,l,u,h-l,f-u,0,0,o,o)}else{const t=100;d.width=t,d.height=t,g.drawImage(e,Math.max(0,e.naturalWidth-t)/2,Math.max(0,e.naturalHeight-t)/2,t,t,0,0,t,t)}try{o(d.toDataURL(),!0,i)}catch(e){aiLoggerManager.warn(`Unable to get canvas.toDataUrl: ${e} Src: ${i}. Will use not cropped image.`,"detectNearestColor"),a.cropped[i]=1,o((e=>{const t="r="+Math.random().toString().slice(2);return e.indexOf("?")>0?`${e}&${t}`:`${e}?${t}`})(i),!1,i)}},l=()=>dal.session.getOne("colorPreferencesFrequencies")||{};let d={};const u=(e,t)=>{const i=Date.now();e.forEach(e=>{t[e]=i,d[e.toLowerCase()]=1}),e.length&&affinityAccumulator.add({colors:e});const r={};Object.keys(t).forEach(e=>{r["affinityInteractionsWith"+e]=1}),Object.keys(COLORS).forEach(e=>{t[e]||(r["affinityInteractionsWith"+e]=0)}),r.HasAffinityToColor=+!!Object.keys(t).length;const n=wdl.set(r);e.length&&dal.session.set({colorPreferencesFrequencies:t}),n&&coreReports.shouldSend&&!coreReports.cyclesAreActive&&(coreReports.cyclesAreActive=!0)},g=e=>n(Object.keys(configurationsGetters.specialColorNameMapping).reduce((t,i)=>{const r=i.toLowerCase();return aiUtils.wordInText(r,e)&&t.push(i),t},[])),h=(e,t=1)=>{if(!e)return null;if(e.length>AFFINITY_MAX_SIZE_STRING_CHECKING)return null;const i=g(e);if(i.length){if(i.length<=t)return aiLoggerManager.info(i,"AffinityToColor (checkColorsInText) in TEXT detected: "),u(i,l()),i;aiLoggerManager.warn(i,"AffinityToColor (checkColorsInText) in TEXT detected but NOT STORED (over the threshold): ")}return null};return{cleanRawColorNames:n,setColorAffinities:()=>{u([],l()),notifier.retroBind("pageType",e=>{let t=e===SiteSections.home||"/"===window.location.pathname||""===window.location.pathname;if([SiteSections.cart,SiteSections.checkout,SiteSections.orderConfirmation].indexOf(e)>=0)return;t||(e=>{const t=`${window.location.href||""} ${e&&"Unknown"!==e&&document.title||""}`.toLowerCase(),i=h(t)||[];i.length&&(aiLoggerManager.info(i,"AffinityToColor in URL detected: "),u(i,l()))})(e);const i=Array.from(document.querySelectorAll("img"));i.forEach(e=>{coreUtils.addClickHandler("detectNearestColor",e,t=>{c(e,t)},!0)});const r=e=>{let t=e.target;if("IMG"===t.tagName)return c(t,e);let i=2;for(;t.childElementCount>0&&i>=0;){if(t=t.firstElementChild,t&&"IMG"===t.tagName)return c(t,e);i--}};coreUtils.removeClickHandler(document.body,r,!0),coreUtils.addClickHandler("detectNearestColor.clickEventHandler",document.body,r,!0);let n=extractColorFromPageInnerText();if(calculationsCycle.add("extractColorFromPageInnerText",()=>{const e=extractColorFromPageInnerText();e&&n!==e&&(aiLoggerManager.info(e,`AffinityToColor on PAGE (innerText) changed from ${n} to `),n=e,u([coreUtils.toTitleCase(e)],l()))}),n)return aiLoggerManager.info(n,"AffinityToColor on PAGE (innerText) detected - skip the following detections: "),void u([coreUtils.toTitleCase(n)],l());if(e===SiteSections.product){let e=extractColorFromPageSelectors();if(calculationsCycle.add("extractColorFromPageSelectors",()=>{const t=extractColorFromPageSelectors();t&&e!==t&&(aiLoggerManager.info(t,`AffinityToColor on PAGE (selectors) changed from ${e} to `),e=t,u([coreUtils.toTitleCase(t)],l()))}),e)aiLoggerManager.info(e,"AffinityToColor on PAGE (selectors) detected: "),u([coreUtils.toTitleCase(e)],l());else{(()=>{const e=Array.from(document.getElementsByTagName("meta")).filter(e=>"og:image"===e.getAttribute("property"));if(!e.length)return;if(e.length>1)return void aiLoggerManager.warn(e,"detectColorFromMetaTag: more than 1 meta tag found!");const t=e[0].content;if(!t)return void aiLoggerManager.warn(e,"detectColorFromMetaTag: meta tag has no content!");aiLoggerManager.info(e,"detectColorFromMetaTag: try to detect colors from the meta tag.");const i=h(t.toLowerCase())||[];i.length&&(aiLoggerManager.info(i,`detectColorFromMetaTag detected from the image URL ${t}: `),u(i,l()))})();const e=i.sort((e,t)=>t.height*t.width-e.height*e.width);if(e.length){const t=e[0],i=e[1];(!i||t.src&&t.height*t.width/(i.height*i.width)>1.3)&&(aiLoggerManager.info(t.src,"detectNearestColor: Check largest image for color affinity:"),c(t))}}}})},getDetectedColors:()=>{const e=Object.keys(d);return d={},e},checkColorsInText:h,colorsFromText:g}})(),customAiFeatures=(()=>{class CustomAiFeatures{async init(){this.errorMessages={},this.computedFeatures={},this.collectedFeatures={},this.getters={},this.converters={},this.features=Object.entries(configurationsGetters.customAiFeatures).reduce((e,[t,i])=>(i.a||(this.getters[i.s]||(this.getters[i.s]=this.prepareValueGetter(i.s)),this.converters[i.d]||(this.converters[i.d]=this.prepareValueConverter(i.d)),e[t]=i),e),{}),notifier.bind("wdl-ready",this.collect.bind(this)),calculationsCycle.add("collectCustomAiFeatures",this.collect.bind(this))}collect(){let e={};Object.keys(this.features).forEach(t=>{let i;if(i=wdl.needToRecalculateCustom([t])?this.computeFeature(t):wdl.get(t,"aiFeature"),this.computedFeatures[t]!==i){const r=this.features[t].id;e[t]=i,this.computedFeatures[t]=i,this.collectedFeatures[r]=i}}),Object.keys(e).length&&(wdl.setCustomAiFeatures(e),!coreReports.cyclesAreActive&&coreReports.cycle>0&&(coreReports.cyclesAreActive=!0))}getCollectedFeatures(){const e={...customAiFeatures.collectedFeatures};return customAiFeatures.collectedFeatures={},e}computeFeature(e){let t;const i=this.features[e];try{const e=this.getters[i.s];t=(0,this.converters[i.d])(e(i.k))}catch(r){t=i.dv;const n=`Unable to compute feature [${e}]: ${r}.\nWill return the default value [${t}]`;this.errorMessages[e]||(this.errorMessages[e]=!0,aiLoggerManager.warn(n,"customAiFeatures.computeFeature"))}return t}prepareValueGetter(store){switch(store){case"u":return e=>(coreUtils.getQueryParamsAsObject()||{})[e];case"w":return e=>coreUtils.get(window,e);case"c":return e=>coreUtils.getCookie(e);case"s":return e=>window.sessionStorage.getItem(e)||null;case"l":return e=>window.localStorage.getItem(e)||null;case"j":return key=>eval(key);default:return()=>{}}}prepareValueConverter(e){switch(e){case"n":return e=>{const t=+e;return isNaN(t)?e:t};case"b":return e=>{if(coreUtils.isString(e)){const t=e.toLowerCase();if("true"===t||"t"===t||"1"===t)return 1;if("false"===t||"f"===t||"0"===t)return 0}return+!!e};default:return e=>e}}}const customAiFeatures=new CustomAiFeatures;return customAiFeatures})(),audienceDetector=(()=>{function e(e,t,i,r){switch(e){case"f":return t?e=>{const i=wdl.getCustomByID(e);return void 0===i?wdl.getDefaultFeatureValueById(e,t):i}:wdl.getByID.bind(wdl);case"m":return e=>{const i=wdl.get(e,"model")||{};return t?i.prediction_score:i.prediction};case"aud":return e=>wdl.get(e,"audience")||0;case"e":return e=>wdl.get(e,"event")||0;case"aff":return i?()=>affinityAccumulator.getAccumulatedAffinityById(r,i):t?e=>{const i=wdl.getCustomByID(e);return void 0===i?wdl.getDefaultFeatureValueById(e,t):i}:wdl.getByID.bind(wdl);case"i":return wdl.get.bind(wdl);default:return()=>null}}const t=new class{constructor(){this.detectedAudiences={},this.detectedCustomAudiences={},this.audiencesToSend={},this.customAudiencesToSend={},this.probes={},this.customProbes={},this.nameToGuidMapping={},this.guidToNameMapping={},this.changedAudiences={wandzAudiences:{},customAudiences:{}},this.hasChangedAudiences=!1}async init(){this.clearChangedAudiencesObj(),Object.entries(configurationsGetters.audiences).forEach(([e,t])=>{const i="or"===t.op?aiUtils.orBunch:aiUtils.andBunch,r=this.prepareCheckers(t.r);this.probes[e]=()=>i(r),this.nameToGuidMapping[e]=t.guid,this.guidToNameMapping[t.guid]=e}),Object.entries(configurationsGetters.customAudiences).forEach(([e,t])=>{const i="or"===t.op?aiUtils.orBunch:aiUtils.andBunch,r=this.prepareCheckers(t.r);this.customProbes[e]=()=>i(r),this.nameToGuidMapping[e]=t.guid,this.guidToNameMapping[t.guid]=e}),notifier.retroBind("wdl-ready",this.loadStoredAudiences.bind(this)),notifier.bind("hook-cycle",this.detect.bind(this)),notifier.bind("calculate-audiences",this.detect.bind(this))}loadStoredAudiences(){const e=wdl.getBranch(CUSTOM_AUDIENCES_PATH),t=session.sessionWasExpired;if(e){const i={};Object.entries(e).forEach(([e,r])=>{if(!r)return;const n=configurationsGetters.customAudiences[e];if(!n)return;const s=n.dp||"P";let a;switch(s){case"C":case"P":default:a=!1;break;case"S":a=!t;break;case"U":a=!0}a&&(this.detectedCustomAudiences[e]=r,this.customAudiencesToSend[n.guid||e]=1,notifier.fire(e+"-calculated",1),i[e]=`${r} (${s})`,this.changedAudiences.customAudiences[e]=1,this.hasChangedAudiences=!0)}),Object.keys(i).length&&aiLoggerManager.info(i,"audienceDetector.loadStoredAudiences - Custom Audiences was loaded from storage")}const i=configurationsGetters.params.defaultPersistenceAudience||"P";if("P"!==i&&("U"===i||"S"===i&&!t)){const e=wdl.getBranch(AUDIENCES_PATH),t={};Object.entries(e).forEach(([e,i])=>{i&&(this.detectedAudiences[e]=i,this.audiencesToSend[e]=1,notifier.fire(e+"-calculated",1),t[e]=i,this.changedAudiences.wandzAudiences[e]=1,this.hasChangedAudiences=!0)}),Object.keys(t).length&&aiLoggerManager.info(t,`audienceDetector.loadStoredAudiences - Wandz Audiences was loaded from storage (${i})`)}this.hasChangedAudiences&&notifier.fire("audiences-changed")}detect(){performanceMeasurer.start("audiences-detect"),this.audiencesToSend={...this.audiencesToSend,...this.detectAudiences(this.probes,this.detectedAudiences,!1)},this.customAudiencesToSend={...this.customAudiencesToSend,...this.detectAudiences(this.customProbes,this.detectedCustomAudiences,!0)},this.hasChangedAudiences&&notifier.fire("audiences-changed"),performanceMeasurer.end("audiences-detect")}getAudiencesToSend(){const e=Object.keys(this.audiencesToSend);return this.audiencesToSend={},e}getCustomAudiencesToSend(){const e=Object.keys(this.customAudiencesToSend);return this.customAudiencesToSend={},e}getChangedAudiences(){const e=JSON.parse(JSON.stringify(t.changedAudiences));return t.clearChangedAudiencesObj(),e}clearChangedAudiencesObj(){t.changedAudiences={wandzAudiences:{},customAudiences:{}},t.hasChangedAudiences=!1}detectAudiences(e,t,i){const r={},n={};return Object.entries(e).forEach(([e,s])=>{if(!t[e])if(s()){const s=this.nameToGuidMapping[e];s?n[i?s:e]=1:(aiLoggerManager.warn(`${i?"Custom":""} Audience [${e}] has no GUID! Will send the name instead.`,"audienceDetector.detect"+(i?"Custom":"")),n[e]=1),r[e]=t[e]=1,notifier.fire(e+"-calculated",1),this.changedAudiences[i?"customAudiences":"wandzAudiences"][e]=1,this.hasChangedAudiences=!0}else void 0===t[e]&&notifier.fire(e+"-calculated",0),r[e]=t[e]=0}),Object.keys(r).length&&(aiLoggerManager.info(r,"audienceDetector.detect"+(i?"Custom":"")),i?wdl.setCustomAudiences(r):wdl.setAudiences(r)),n}prepareCheckers(t){const i=[];return t.forEach(t=>{const r=aiUtils.getComparator(t.c);let n;n="m"===t.et?e(t.et,+("n"===t.dt)):"aff"===t.et&&"n"===t.dt?e(t.et,t.ct,t.aft,t.afid):e(t.et,t.ct),i.push(()=>{let e=n(t.aid);const i="f"===t.et?wdl.getDefaultFeatureValueById(t.aid,t.ct):void 0;"b"===t.dt&&void 0!==e&&(e=!!e);try{return r(e,t.v,i)}catch(i){return aiLoggerManager.error(i,`Error in comparator [${t.c}] for real value [${JSON.stringify(e)}] and expected value [${JSON.stringify(t.v)}]`),!1}})}),i}};return t})(),{userEvents:userEvents,setClickedPerSessionsListener:setClickedPerSessionsListener,setScrollSpeedObserver:setScrollSpeedObserver}=(()=>{const e=e=>{let t=0;for(;e.parentElement;)t++,e=e.parentElement;return t},t=e=>{const t=e.getAttributeNames().reduce((t,i)=>(i.startsWith("on")&&(t[i]=e.getAttribute(i)),t),{});return["onclick","onsubmit","onchange","oninput","onfocus","onkeydown","onmouseover"].forEach(i=>{e[i]&&!t[i]&&(t[i]=e[i].toString())}),t},i=new class{constructor(){this.isReady=!1,this.eventIdToNameMapping={},this.isBoundKey="",this.sendClickEventSourcesEnable=!1,this.caughtElementsMap=[],this.bounceTimeoutId=null,this.elementsToCheck=[],this.events=[],this.pageType="",this.onPageAndEvents={},this.visibilityRules=[],this.visibilityEventIds={},this.parentsDepth=3}init(){this.caughtElementsMap=[],this.bounceTimeoutSeconds=configurationsGetters.params.userEventsBounceSeconds||0,this.parentsDepth=configurationsGetters.params.userEventsParentsDepth,void 0===this.parentsDepth&&(this.parentsDepth=3),this.bounceTimeoutId=null,this.elementsToCheck=[],this.events=[],this.onPageAndEvents={},this.visibilityRules=[],this.visibilityEventIds={};const e="__wndz_user_events_bound";this.isBoundKey=__INJECTIONS__.isDemo?e+"_demo":e,Object.entries(configurationsGetters.userEvents||{}).forEach(([e,t])=>{i.eventIdToNameMapping[t.id]=e}),notifier.bind("user-interaction",i.handleInteraction),notifier.retroBind("pageDataCollected",e=>{i.initEvents(),i.checkForCandidates(e)}),beforeunloadHandler.addRegular("checkUserEvents",i.checkElements),i.bindListener()}initEvents(){let e=!1;Object.values(configurationsGetters.userEvents||{}).forEach(t=>{if(!(t.pgc&&t.pgc.r&&t.pgc.r.length)||("or"===t.pgc.c?aiUtils.orBunch:aiUtils.andBunch)(t.pgc.r.map(e=>generateTargetReachedProbe(e))))if(t.evc&&t.evc.r&&t.evc.r.length){i.events.push(t),"and"===t.evc.c&&(i.onPageAndEvents[t.id]={expectedCount:t.evc.r.length,actualCount:{}});for(let r=0,n=t.evc.r.length;n>r;r++){const n=t.evc.r[r];if(n.entityType)switch(n.entityType){case"interaction":i.initEntityInteractionEvent(n,r,t);break;case"adaptiveSearch":i.initEntityAdaptiveSearchEvent(n,r,t);break;default:aiLoggerManager.warn(n,`UserEvents: Unknown entity type for event ${i.eventIdToNameMapping[t.id]} (# ${t.id})!`)}n.elementRule&&"click"!==n.elementRule.event&&(e=!0,i.visibilityEventIds[t.id]=!0,i.visibilityRules.push({event:t,rule:n,ruleIdx:r,probe:i.generateVisibilityProbe(n),element:null,detected:!1}))}}else aiLoggerManager.info(t,"UserEvents: No event rule provided! Seems only the page condition is met - handle the event."),i.handleInteraction(t.id,"page-conditions-only-event")}),e&&calculationsCycle.add("element-visibility-events",this.performVisibilityCheck.bind(this))}handleInteraction(e,t=null){const r=i.eventIdToNameMapping[e]||"";if(!r)return void aiLoggerManager.warn(e,"userInteraction - no event name for ID found!");if(i.onPageAndEvents[e]){const t=Object.keys(i.onPageAndEvents[e].actualCount).length,n=i.onPageAndEvents[e].expectedCount;if(n>t)return void aiLoggerManager.info(r,`UserEvents: Not all elements are caught yet! ${t}/${n}`)}const n=(wdl.get(r,"event")||0)+1,s={[e]:n,[r]:n};wdl.get("isUserInteractionOccurred","aiFeature")||(s.isUserInteractionOccurred=1),r.startsWith("gift_card")?s.isEngagedUser=1:r.startsWith("apply_coupon")||r.startsWith("click_on_coupon")?s.numberApplyCouponsOnPage=(wdl.get("numberApplyCouponsOnPage","aiFeature")||0)+1:(r.startsWith("login")||r.startsWith("visitor_login"))&&(s.numberOfLoginTriesOnPage=(wdl.get("numberOfLoginTriesOnPage","aiFeature")||0)+1);const a=wdl.set(s,!1,!0);t&&(notifier.fire("user-event-fired",r,t),notifier.fire("user-event-"+r,r,t)),a&&coreReports.updateStack(!0)}getClickHandler(){return function(e){try{const t=e.target;let r=!1;for(let e=0,n=i.caughtElementsMap.length;n>e;e++)i.caughtElementsMap[e][0].includes(t)&&(r=!0,i.caughtElementsMap[e][1].forEach(t=>i.handleInteraction(t,i.caughtElementsMap[e][2])));if(r)return;const n=t.parentNode;let s=t;n&&n.outerHTML&&n.outerHTML.length<AFFINITY_MAX_SIZE_STRING_CHECKING&&(s=n),-1===i.elementsToCheck.indexOf(t)&&(i.elementsToCheck.push(t),i.bounceTimeoutId||(i.bounceTimeoutId=setTimeout(i.checkElements,1e3*i.bounceTimeoutSeconds))),brandAndCategoryAffinity.checkGroupsAffinity(t.textContent.trim().toLowerCase(),t!==s?(s.textContent||"").trim().toLowerCase():"",wdl.get("pageType","aiFeature")),checkColorsInText(t.textContent.trim().toLowerCase())||t===s||checkColorsInText((s.textContent||"").trim().toLowerCase()),i.sendClickEventSourcesEnable&&i.sendClickEventSource([t])}catch(e){aiLoggerManager.error(e,"addEventListener")}}}bindListener(){i.sendClickEventSourcesEnable=(configurationsGetters.params.sendClickEventSources||0)>Math.random(),window[this.isBoundKey]||(window[this.isBoundKey]=1,coreUtils.addClickHandler("userEvents.bindListener",document.body,i.getClickHandler(),{capture:!0})),i.getAllShadowRoots().forEach(i.bindClickListenerToShadowRoot)}bindClickListenerToShadowRoot(e){try{e[i.isBoundKey]||(e[i.isBoundKey]=1,coreUtils.addClickHandler("userEvents.bindListenerShadowRoot",e,i.getClickHandler(),{capture:!0}))}catch(e){aiLoggerManager.error(e,"addEventListener to shadowRoot")}}checkElement(e,t){let i=t.attribute;const r=t.value;let n;if("element"===i)n=e.tagName||"";else if("innerHTML"===i)try{n=e.innerHTML}catch(e){aiLoggerManager.warn(e,"UserEvents: Unable to get the innerHtml!"),n=""}else if("innerText"===i)try{n=e.innerText,n.length>MAX_SIZE_STRING_CHECKING&&(n="")}catch(e){aiLoggerManager.warn(e,"UserEvents: Unable to get the innerHtml!"),n=""}else n=e.getAttribute(i)||e[i];return aiUtils.getComparator(t.operator)(n,r)}sendClickEventSource(e){const t=dal.session.getOne("pvst"),r={action:"wandz_events",client_tag:configurationsGetters.configurations.tag,domain:configurationsGetters.mappedDomain||configurationsGetters.domain,is_crawler:0,page_cb:t,page_cb_timestamp:coreUtils.timestampToUtc(t),page_href:decodeURI(window.location.href).slice(0,4e3),items:e.map(e=>i.extractEventSourceData(e))};aiLoggerManager.info(r,"sendClickEventSource"),coreTracker.sendGetEventViaWebWorker(r).then()}extractEventSourceData(r){const n=["id","class","name","href","src","onclick","title","for","alt","aria-label","data-testid","aria-labelledby","data-target"],s=r.getBoundingClientRect();return{element_type:r.tagName||"",element_text:r.innerText||"",element_id:r.id||null,element_name:r.getAttribute("name")||null,element_href:r.getAttribute("href")||r.getAttribute("src")||null,element_class:r.className||null,element_onclick:r.getAttribute("onclick")||null,element_aria_label:r.getAttribute("aria-label")||null,element_title:r.getAttribute("title")||null,element_for:r.getAttribute("for")||null,element_data_testid:r.getAttribute("data-testid")||null,element_aria_labelledby:r.getAttribute("aria-labelledby")||null,element_alt:r.getAttribute("alt")||null,element_data_target:r.getAttribute("data-target")||null,element_rest_of_attributes:r.getAttributeNames().reduce((e,t)=>(t.startsWith("on")||-1!==n.indexOf(t)||(e[t]=r.getAttribute(t)),e),{}),element_is_visible:coreUtils.isElementVisible(r),element_href_or_action:r.getAttribute("href")||r.getAttribute("src")||r.getAttribute("action")||null,element_area:coreUtils.calculateArea(r),element_position:{viewportHeight:window.innerHeight,viewportWidth:window.innerWidth,x:s.x,y:s.y},element_events:t(r),element_depth:e(r),element_wdz_form_id:null,element_wdz_parent_form_id:null,element_section:i.pageType}}checkForCandidates(e){if(i.pageType=e,(configurationsGetters.params.sendCandidateSources||0)<=Math.random())return;const t=configurationsGetters.params.sendCandidateConfig||[];if(!t.length)return;const r=t.reduce((e,[t,i])=>{if(i&&t){const r=document.getElementsByTagName(t),n=coreUtils.getRandomElements(Array.from(r),i);e=e.concat(n)}return e},[]);r.length?(aiLoggerManager.info(r,`UserEvents: Found ${r.length} candidates to send`),i.sendClickEventSource(r)):aiLoggerManager.info(t,"UserEvents: No candidates were found for the config given.")}getAllShadowRoots(){return Array.from(document.querySelectorAll("*")).filter(e=>e.shadowRoot&&"open"===e.shadowRoot.mode)}getAllEventElements(){const e=[],t={},r=i.getAllShadowRoots();return i.events.forEach(n=>{const s=n.evc.r;for(let a=0,o=n.evc.r.length;o>a;a++){const o=s[a];if(!o.elementRule)continue;if("click"!==o.elementRule.event)continue;const c="or"===o.attributesRules.operator?aiUtils.orBunch:aiUtils.andBunch;o.elementRule.tags.reduce((e,i)=>{if(!t[i]){const e=r.flatMap(e=>Array.from(e.shadowRoot.querySelectorAll(i)));t[i]=[...Array.from(document.getElementsByTagName(i)),...e]}return e.concat(t[i])},[]).forEach(t=>{c((o.attributesRules.rules||[]).map(e=>()=>i.checkElement(t,e)))&&e.push({element:t,eventId:n.id,elementConditionIdx:a})})}}),e}checkForParents(e,t,i){const r=[];let n=e;for(let e=0;i>e&&(n=n.parentElement,null!==n);e++)r.push(n);return r.includes(t)}checkElements(){if(!i.elementsToCheck||!i.elementsToCheck.length)return;const e=i.getAllEventElements(),t=t=>{if(t)try{let r=!1;for(let n=0,s=e.length;s>n;n++){const s=e[n].element;if(s.contains(t)||!["LI","OPTION"].includes(s.tagName)&&i.checkForParents(s,t,i.parentsDepth)){r=!0;const a=e[n].eventId,o=i.caughtElementsMap.find(e=>e[2]===s);o?(o[0].includes(t)||o[0].push(t),o[1].includes(a)||o[1].push(a)):i.caughtElementsMap.push([[t],[a],s]),i.onPageAndEvents[a]&&(i.onPageAndEvents[a].actualCount[e[n].elementConditionIdx]=!0),i.handleInteraction(a,s)}}r||!t.tagName||"html"===t.tagName.toLowerCase()||t.parentElement||i.events.forEach(e=>{const r=e.evc.r;for(let n=0,s=e.evc.r.length;s>n;n++){const s=r[n];if(!s.elementRule)continue;if("click"!==s.elementRule.event)continue;const a="or"===s.attributesRules.operator?aiUtils.orBunch:aiUtils.andBunch;if(s.elementRule.tags.includes(t.tagName.toLowerCase())&&a((s.attributesRules.rules||[]).map(e=>()=>i.checkElement(t,e)))){const r=e.id,s=i.caughtElementsMap.find(e=>e[2]===t);s?(s[0].includes(t)||s[0].push(t),s[1].includes(r)||s[1].push(r)):i.caughtElementsMap.push([[t],[r],t]),i.onPageAndEvents[r]&&(i.onPageAndEvents[r].actualCount[n]=!0),i.handleInteraction(r,t)}}})}catch(e){aiLoggerManager.error(t,"userEvents.checkOneElement fails: "+e)}else aiLoggerManager.warn(`target is [${t}]!`,"userEvents.checkOneElement")};let r=i.elementsToCheck.pop();for(;r;)t(r),r=i.elementsToCheck.pop();window.clearTimeout(i.bounceTimeoutId),i.bounceTimeoutId=null}generateVisibilityProbe(e){switch(e.elementRule.event){case"existsOnPage":return coreUtils.isElementVisible;case"viewableOnPage":return e=>coreUtils.isElementVisible(e)&&coreUtils.isElementWithinViewport(e);default:return aiLoggerManager.warn(e,`UserEvents: Unknown visibility event ${e.elementRule.event}!`),()=>!1}}performVisibilityCheck(){const e={};let t=null;i.visibilityRules.forEach(r=>{r.detected?(e=>{const t=e.element,r=e.event.id;t&&e.probe(t)||(e.element=null,e.detected=!1,i.onPageAndEvents[r]&&(i.onPageAndEvents[r].actualCount[e.ruleIdx]=!1))})(r):(r=>{t||(t=i.getAllShadowRoots());const n=r.rule,s="or"===n.attributesRules.operator?aiUtils.orBunch:aiUtils.andBunch;n.elementRule.tags.reduce((i,r)=>{if(!e[r]){const i=t.flatMap(e=>Array.from(e.shadowRoot.querySelectorAll(r)));e[r]=[...Array.from(document.getElementsByTagName(r)),...i]}return i.concat(e[r])},[]).forEach(e=>{if(!r.element&&s((n.attributesRules.rules||[]).map(t=>()=>i.checkElement(e,t)))&&r.probe(e)){r.element=e,r.detected=!0;const t=r.event.id;i.onPageAndEvents[t]&&(i.onPageAndEvents[t].actualCount[r.ruleIdx]=!0),i.handleInteraction(t,e)}})})(r)})}initEntityInteractionEvent(e,t,r){if(e.actions&&e.actions.length)for(const n of e.actions){let s="";switch(n){case"click":s="interactionPopupClicked";break;case"view":s="interactionPopupDisplayed";break;case"closeWithoutClick":s="interactionPopupClosedWithoutClick";break;case"reminderClick":s="interactionReminderClicked";break;case"reminderClose":s="interactionReminderClosed";break;default:aiLoggerManager.warn(n,`UserEvents: Unknown action for event ${i.eventIdToNameMapping[r.id]} (# ${r.id})!`);continue}const a=e.identifier||"";a?notifier.bind(s,((e,t,i,r)=>n=>{-1!==e&&n!==e||(r.onPageAndEvents[t]&&(r.onPageAndEvents[t].actualCount[i]=!0),r.handleInteraction(t,n))})(a,r.id,t,i)):aiLoggerManager.warn(e,`UserEvents: No identifier provided for event ${i.eventIdToNameMapping[r.id]} (# ${r.id})!`)}else aiLoggerManager.warn(e,`UserEvents: No actions provided for event ${i.eventIdToNameMapping[r.id]} (# ${r.id})!`)}initEntityAdaptiveSearchEvent(e,t,r){if(e.actions&&e.actions.length)for(const n of e.actions){let s="";switch(n){case"click":s="adaptive-search-term-clicked";break;case"view":s="adaptive-search-displayed";break;default:aiLoggerManager.warn(n,`UserEvents: Unknown action for event ${i.eventIdToNameMapping[r.id]} (# ${r.id})!`);continue}const a=e.identifier||"";a?notifier.bind(s,((e,t,i,r)=>n=>{-1!==e&&n!==e||(r.onPageAndEvents[t]&&(r.onPageAndEvents[t].actualCount[i]=!0),r.handleInteraction(t,n))})(a,r.id,t,i)):aiLoggerManager.warn(e,`UserEvents: No identifier provided for event ${i.eventIdToNameMapping[r.id]} (# ${r.id})!`)}else aiLoggerManager.warn(e,`UserEvents: No actions provided for event ${i.eventIdToNameMapping[r.id]} (# ${r.id})!`)}};return{userEvents:i,setClickedPerSessionsListener:()=>{const e=dal.session.getOne("uniqueClicks")||0;wdl.set({clicksInSessionValue:e,...aiUtils.calculateScore(e,"clicksInSessionValue",wdl.device)}),window.__wndz_clicked_per_session_listener_bound||(window.__wndz_clicked_per_session_listener_bound=1,coreUtils.addClickHandler("setClickedPerSessionsListener",document,()=>{const e=dal.session.getOne("uniqueClicks")||0,t=dal.session.getOne("lastClickTimestamp")||0,i=t?new Date(t).getTime():null,r=!i||!e,n=Date.now(),s=i&&n>new Date(i+1e3).getTime(),a={lastClickTimestamp:n};if(r||s){const t=e+1;wdl.set({clicksInSessionValue:t,...aiUtils.calculateScore(t,"clicksInSessionValue",wdl.device)},!1,!0),a.uniqueClicks=t}dal.session.set(a,!0)},!0))},setScrollSpeedObserver:()=>{let e=0,t=0,i=0;const r=wdl.device,n=[Devices.TABLET,Devices.MOB];r!==BOT_DEVICE&&n.includes(r)?document.addEventListener("touchmove",r=>{try{e++;const n=window.innerHeight-r.touches[0].clientY;t+=Math.abs(i-n),i=n;const s=t/e;let a;a=15>s?1:25>s?2:3,notifier.fire("set-scroll-speed",a)}catch(e){aiLoggerManager.error(e,"setScrollSpeedObserver")}}):document.addEventListener("scroll",r=>{try{let n;e++;const s=r.target.scrollingElement.scrollTop;t+=Math.abs(i-s),i=s;let a=t/e;n=15>a?1:25>a?2:3,notifier.fire("set-scroll-speed",n)}catch(e){aiLoggerManager.error(e,"setScrollSpeedObserver")}})}}})(),affinityAccumulator=new class{constructor(){this.affinities={},this.today=0,this.categories={},this.keywords={},this.brands={},this.custom={},this.colors={},this.colorsObj={},this.dataToSend={category:{},brand:{},color:{},customAffinity:{},keywords:{}},this.idToCountMapping={}}init(){const e=dal.session.getOne("accumulatorVersion"),t=configurationsGetters.params.accumulatorVersion;t&&t!==e?(aiLoggerManager.warn(`Affinity accumulator version has changed from ${e} to ${t}. Resetting the accumulator.`,"AffinityAccumulator.init"),dal.session.set({accumulatorVersion:t,affinityAccumulator:{}}),this.affinities={}):this.affinities=dal.session.getOne("affinityAccumulator")||{},this.categories={},this.keywords={},this.brands={},this.custom={},this.colors={},this.colorsObj={},this.dataToSend={category:{},brand:{},color:{},customAffinity:{},keywords:{}},this.idToCountMapping={};const i=new Date;i.setHours(0,0,0,0),this.today=i.getTime(),Object.keys(this.affinities).length&&(this.initialCalculateAffinities(),this.exposeToWdl())}initialCalculateAffinities(){const e=(e,t,i=!1,r=!0)=>{e&&Object.keys(e).forEach(n=>{const s=r?"accumulatedAffinityTo"+n:n.toLowerCase();t[s]=(t[s]||0)+e[n],i&&(this.colorsObj[n]=1)})};Object.keys(this.affinities).forEach(t=>{const i=this.affinities[t];(e=>{["accumulatedAffinityToCategories","accumulatedKeywords","accumulatedAffinityToBrands","accumulatedCustomAffinity","accumulatedAffinityToColors"].forEach(t=>{e[t]||(e[t]={})})})(i),e(i.accumulatedAffinityToCategories,this.categories),e(i.accumulatedKeywords,this.keywords,!1,!1),e(i.accumulatedAffinityToBrands,this.brands),e(i.accumulatedCustomAffinity,this.custom),e(i.accumulatedAffinityToColors,this.colors,!0)}),this.prepareDataToSend()}prepareDataToSend(e){["categories","brands","colors","custom","keywords"].forEach(t=>{if(e&&!e[t])return;const i=this[t],r={categories:"category",brands:"brand",colors:"color",custom:"customAffinity",keywords:"keywords"}[t];Object.keys(i).forEach(e=>{if(!i.hasOwnProperty(e))return;const n="keywords"===t?e:e.replace("accumulatedAffinityTo","");if(["colors","keywords"].includes(t))this.dataToSend[r][n.toLowerCase()]=i[e];else{let s="",a=aiUtils.onlyLetters(n.toLowerCase()),o=aiUtils.onlyLetters(coreUtils.featureToAffinityName(n).toLowerCase()),c="";switch(t){case"categories":c=brandAndCategoryAffinity.cleanedCategoryMap[a]||brandAndCategoryAffinity.cleanedCategoryMap[o],c&&(s=brandAndCategoryAffinity.categoryNameToId[c]);break;case"brands":c=brandAndCategoryAffinity.cleanedBrandMap[a]||brandAndCategoryAffinity.cleanedBrandMap[o],c&&(s=brandAndCategoryAffinity.brandNameToId[c.toLowerCase()]);break;case"custom":c=customAffinity.cleanNameMap[a]||customAffinity.cleanNameMap[o],c&&(s=(customAffinity.displayNameMapping[c.toLowerCase()]||{}).id)}if(!s)return;this.dataToSend[r][s]=i[e]}})}),this.processIdToCountMapping()}processIdToCountMapping(){Object.keys(this.dataToSend).forEach(e=>{Object.keys(this.dataToSend[e]).length&&(this.idToCountMapping[e]=this.dataToSend[e],"color"===e&&Object.entries(this.idToCountMapping[e]).forEach(([t,i])=>{delete this.idToCountMapping[e][t],this.idToCountMapping[e][wdl.aiFeatureNameToIdMapping["affinityInteractionsWith"+coreUtils.toTitleCase(t)]||t]=i}))})}getAccumulatedAffinityById(e,t){const i={c:"category",b:"brand",col:"color",ca:"customAffinity"}[t]||t;return this.idToCountMapping[i]&&this.idToCountMapping[i][e]||0}getDataToSend(){const e={};return Object.keys(this.dataToSend).forEach(t=>{Object.keys(this.dataToSend[t]).length&&(e[t]=this.dataToSend[t])}),this.dataToSend={category:{},brand:{},color:{},customAffinity:{},keywords:{}},e}saveAffinities(){dal.session.set({affinityAccumulator:this.affinities})}exposeToWdl(){wdl.setAccumulatedAffinities({accumulatedAffinityToCategories:this.categories,accumulatedAffinityToBrands:this.brands,accumulatedAffinityToColors:this.colors,accumulatedCustomAffinity:this.custom,accumulatedKeywords:this.keywords},Object.keys(this.colorsObj))}add(e){this.affinities[this.today]||(this.affinities[this.today]={accumulatedAffinityToCategories:{},accumulatedAffinityToBrands:{},accumulatedAffinityToColors:{},accumulatedCustomAffinity:{},accumulatedKeywords:{}});const t=this.affinities[this.today];this.increaseAffinity(e.brands,t.accumulatedAffinityToBrands,this.brands),this.increaseAffinity(e.categories,t.accumulatedAffinityToCategories,this.categories),this.increaseAffinity(e.custom,t.accumulatedCustomAffinity,this.custom),this.increaseAffinity(e.keywords,t.accumulatedKeywords,this.keywords,!1,!1),this.increaseAffinity(e.colors,t.accumulatedAffinityToColors,this.colors,!0),this.prepareDataToSend(e),this.saveAffinities(),this.exposeToWdl(),notifier.fire("affinitiesAccumulated")}increaseAffinity(e,t,i,r=!1,n=!0){e&&e.forEach(e=>{e=n?coreUtils.affinityNameToFeature(e):e.toLowerCase();const s=n?"accumulatedAffinityTo"+e:e;i[s]=(i[s]||0)+1,t[e]=(t[e]||0)+1,r&&(this.colorsObj[e]=1)})}},brandAndCategoryAffinity=(()=>{const e=new class{constructor(){this.affinityNameToFeature={},this.detectedCategories={},this.detectedCategoryKeywords={},this.detectedBrands={},this.brandNameToId={},this.categoryNameToId={},this.exclusions={},this.cleanedBrandMap={},this.cleanedCategoryMap={},this.categoryKeywords={}}async init(){this.affinities=await this.initAffinities(configurationsGetters.configurations.affinities),this.checkTitleIfNoSection=!!configurationsGetters.params.affinityCheckTitleIfNoSection,notifier.retroBind("pageType",t=>{if([SiteSections.cart,SiteSections.checkout,SiteSections.orderConfirmation].indexOf(t)>=0)return;let i="";t!==SiteSections.home&&"/"!==window.location.pathname&&""!==window.location.pathname&&(t||!t&&e.checkTitleIfNoSection)&&(i=(document.title||"").slice(0,AFFINITY_MAX_SIZE_STRING_CHECKING));const r=`${i} ${(window.location.href.replace(location.origin,"")||"").slice(0,AFFINITY_MAX_SIZE_STRING_CHECKING)}`.trim().slice(0,AFFINITY_MAX_SIZE_STRING_CHECKING).toLowerCase();e.checkGroupsAffinity(r,"",t,!0,configurationsGetters.params.affinityMaxQtyFromTitle||4)})}checkGroupsAffinity(t,i="",r="",n=!1,s=3){if(r&&[SiteSections.cart,SiteSections.checkout,SiteSections.orderConfirmation].includes(r))return;if(!t&&!i)return;const a={affinityToBrands:[],affinityToCategories:[]};let o,c={},l=!1,d={};const u=t=>{if(!t)return;const i=t.length;if(i>AFFINITY_MAX_SIZE_STRING_CHECKING||2>i)return void aiLoggerManager.warn(i,"brandsAndCategories. performCheck - skip to check - the length is");const r=aiUtils.tokenizeWords(t),n=(t,i,n=!1,s=null)=>{const a={};return r.forEach(r=>{const u=i[r]||s&&s[aiUtils.onlyLetters(r)];u&&!e.isExcludedKeyword(u,r)&&(l=!0,a[u]=1,o=o||Date.now(),d[t]=d[t]||{},n&&(c[r]=1,r=`${r}||${u}`),d[t][r]=o)}),Object.keys(a)};a.affinityToBrands=n("affinityToBrands",this.affinities.affinityToBrands,!1,e.cleanedBrandMap),a.affinityToCategories=n("affinityToCategories",this.affinities.affinityToClientCategories,!0),a.affinityToCategories.length||(a.affinityToCategories=n("affinityToCategories",this.affinities.affinityToRegularCategories,!0))};if(u(t),!l&&i&&u(i),l&&(a.affinityToCategories.length>s&&(a.affinityToCategories=[],d.affinityToCategories={},c={}),a.affinityToBrands.length>s&&(a.affinityToBrands=[],d.affinityToBrands={}),a.affinityToCategories.length||a.affinityToBrands.length||(l=!1)),l){const t=dal.session.getOne("affinityTimestamps")||{affinityToBrands:{},affinityToCategories:{}};Object.entries(d).forEach(([i,r])=>{t[i]={...t[i],...r},"affinityToBrands"===i?Object.keys(r).forEach(t=>{const i=e.brandNameToId[t];i?e.detectedBrands[i]=1:aiLoggerManager.warn(t,"checkGroupsAffinity: Brand ID does not found!")}):Object.keys(r).forEach(t=>{t.indexOf("||")>0&&(t=t.split("||")[0]);const i=e.affinities.affinityToClientCategories[t]||e.affinities.affinityToRegularCategories[t],r=e.categoryNameToId[i];r?(e.detectedCategories[r]=1,e.detectedCategoryKeywords[`${r}|${t}`]=1):aiLoggerManager.warn(`categoryName: ${i}, keyword: ${t}`,"checkGroupsAffinity: Category ID does not found!")})});const i={affinityTimestamps:t,affinityCategoryKeywords:Object.keys(t.affinityToCategories||{}).reduce((e,t)=>{let i=t;return i.indexOf("||")>0&&(i=i.split("||")[0]),e[t]=this.affinities.affinityToClientCategories[i]||this.affinities.affinityToRegularCategories[i],e},{})};aiLoggerManager.info(JSON.stringify(i),"AffinityTimestamps set"),dal.session.set(i),n&&a.affinityToCategories.length&&(a.pageCategory=a.affinityToCategories[0]);const r={};[a.affinityToBrands,a.affinityToCategories].forEach(t=>{t.forEach(t=>{const i=e.affinityNameToFeature[t];i&&(r[i]=1)})}),affinityAccumulator.add({brands:a.affinityToBrands,categories:a.affinityToCategories,keywords:Object.keys(c)}),wdl.set(a),wdl.setAffinityFeatures(r),0!==coreReports.cycle&&coreReports.shouldSend&&!coreReports.cyclesAreActive&&(coreReports.cyclesAreActive=!0),storageManagers.persistAll()}const g={},h=wdl.get("affinityToBrands","affinity"),f=wdl.get("affinityToCategories","affinity");g.HasAffinityToBrand=+!(!h||!h.length),g.HasAffinityToCategory=+!(!f||!f.length),wdl.set(g)}getAffinitiesToSend(){const t={categories:coreUtils.asNumbers(Object.keys(e.detectedCategories)),category_keywords:Object.keys(e.detectedCategoryKeywords),brands:coreUtils.asNumbers(Object.keys(e.detectedBrands))};return e.detectedCategories={},e.detectedCategoryKeywords={},e.detectedBrands={},t}async initAffinities(e){e=e||{};const t=configurationsGetters.domain,i=configurationsGetters.mappedDomain,r={},n=dal.session.getOne("affinityTimestamps")||{affinityToBrands:{},affinityToCategories:{}},s=this.__initCategoryAffinitiesWithKeywords(e.c.r,t,i),a=this.__initCategoryAffinitiesWithKeywords(e.c.c,t,i),o=this.__initBrandAffinities(e.b,t,i),c=Object.entries(dal.session.getOne("affinityCategoryKeywords")||{}).reduce((e,[t,i])=>(e[i]=e[i]||[],t.indexOf("||")>0&&(t=t.split("||")[0]),e[i].push(t),e),{});return Object.keys(n.affinityToBrands).forEach(e=>{c[e]=[e],c[aiUtils.onlyLettersAndSpace(e)]=[e]}),await coreUtils.yieldToMain(),["affinityToBrands","affinityToCategories"].forEach(e=>{r[e]=[];const t={};(wdl.get(e,"affinity")||[]).forEach(i=>{const s=i.toLowerCase(),a="affinityToBrands"===e?c[s]||c[aiUtils.onlyLettersAndSpace(s)]:(c[s]||[]).map(e=>`${e}||${s}`);r[e].push(i),a.forEach(i=>t[i]=n[e][i])}),n[e]=t}),wdl.set({HasAffinityToBrand:+!(!r.affinityToBrands||!r.affinityToBrands.length),HasAffinityToCategory:+!(!r.affinityToCategories||!r.affinityToCategories.length)}),dal.session.set({affinityTimestamps:n}),{affinityToBrands:o,affinityToClientCategories:a,affinityToRegularCategories:s}}__initBrandAffinities(t,i,r){const n={},s=t=>{const i=t[0],r=t[1],s=i.split("||"),a=s[0],o=s[1],c=a.toLowerCase();e.cleanedBrandMap[aiUtils.onlyLetters(c)]=a,e.affinityNameToFeature[a]=r,n[c]=a,e.brandNameToId[c]=+o};return t._&&Object.entries(t._).forEach(s),t[i]&&Object.entries(t[i]).forEach(s),r&&t[r]&&Object.entries(t[r]).forEach(s),n}__initCategoryAffinitiesWithKeywords(t,i,r){const n={};if(!t)return n;const s=t=>{const i=t[0],r=t[1],s=i.split("||"),a=s[0],o=aiUtils.onlyLetters(a.toLowerCase()),c={};e.cleanedCategoryMap[o]=a;const l=s[1];e.categoryNameToId[a]=+l,e.affinityNameToFeature[a]=r.f,r.k.forEach(e=>{c[e]=1,n[e]=a;const t=aiUtils.singularToPlural(e);n[t]=a}),r.ke&&(e.exclusions[a]=e.exclusions[a]||{},r.ke.forEach(t=>{c[t]&&delete c[t],e.exclusions[a][t]=1;const i=aiUtils.singularToPlural(t);e.exclusions[a][i]=1})),e.categoryKeywords[a]=e.categoryKeywords[o]=Object.keys(c)};return t._&&Object.entries(t._).forEach(s),t[i]&&Object.entries(t[i]).forEach(s),r&&r!==i&&t[r]&&Object.entries(t[r]).forEach(s),n}isExcludedKeyword(t,i){const r=e.exclusions[t];if(!r)return!1;const n=aiUtils.tokenizePreparedWords(i);for(let e=0,t=n.length;t>e;e++)if(r[n[e]])return!0;return!1}};return e})(),customAffinity=(()=>{const e=new class{init(){this.detectedAffinities={},this.idToNameMapping={},this.idToConfigMapping={},this.nameToIdMapping={},this.displayNameMapping={},this.idToDisplayNameMapping={},this.eventsToBind={},this.probes={},this.cleanNameMap={},this.initAffinities(configurationsGetters.configurations.affinities),this.checkForExpiredAffinities(),notifier.retroBind("pageDataCollected",e.checkAffinities),Object.keys(this.eventsToBind).forEach(t=>{notifier.bind(t+"Changed",()=>{e.checkEventAffinities(t)})})}getAffinitiesToSend(){const t=Object.keys(e.detectedAffinities);return e.detectedAffinities={},t}initAffinities(t){const i=(t||{}).ca;if(!i||!Object.keys(i).length)return;const r=configurationsGetters.domain,n=configurationsGetters.mappedDomain,s=t=>{Object.keys(t).forEach(i=>{const r=t[i],n=r.n,s=r.dn||n,a=s.toLowerCase();e.cleanNameMap[aiUtils.onlyLetters(a)]=s,e.idToConfigMapping[i]=r,e.idToNameMapping[i]=n,e.nameToIdMapping[n]=i,e.displayNameMapping[a]={displayName:s,id:i},e.idToDisplayNameMapping[i]=a;const o="or"===r.op?aiUtils.orBunch:aiUtils.andBunch;let c=!1;const l=r.r.map(t=>{if("e"===t.s){const r=wdl.userEventIdToNameMapping[t.v];r&&(e.eventsToBind[r]=e.eventsToBind[r]||{},e.eventsToBind[r][i]=1,c=!0)}return generateTargetReachedProbe(t)});e.probes[i]=()=>o(l)})};i._&&s(i._),i[r]&&s(i[r]),n&&r!==n&&i[n]&&s(i[n])}checkForExpiredAffinities(){const t=session.sessionWasExpired,i={},r={},n={},s=dal.session.getOne("customAffinityTimestamps")||{};Object.keys(s).forEach(a=>{const[o,c]=a.split("||");let l;switch((e.idToConfigMapping[c]||{}).dp||"U"){case"C":case"P":l=!0;break;case"S":l=t;break;default:l=!1}const d=e.idToNameMapping[c];d||(l=!0),l||"affinityTo"+o===d||(s[`${d}||${c}`]=s[a],delete s[a]),l?(d&&(n[d]=0),delete s[a]):(r[c]=1,i[d]=1)}),dal.session.set({customAffinityTimestamps:s}),wdl.setAffinityFeatures(i,!0),Object.keys(n).length&&wdl.setAffinityFeatures(n,!0)}checkAffinities(){e._checkAffinities(Object.keys(e.probes)),notifier.fire("customAffinitiesChecked")}checkEventAffinities(t){e.eventsToBind[t]&&e._checkAffinities(Object.keys(e.eventsToBind[t]))}_checkAffinities(t){const i={};if(t.forEach(t=>{e.probes[t]()&&(e.detectedAffinities[t]=1,i[e.idToNameMapping[t]]=1)}),Object.keys(i).length){aiLoggerManager.info(i,"Custom Affinities detected");const t=dal.session.getOne("customAffinityTimestamps")||{},r=Date.now();Object.keys(i).forEach(i=>{const n=e.nameToIdMapping[i];n&&(i=i.replace("affinityTo",""),t[`${i}||${n}`]=r)}),dal.session.set({customAffinityTimestamps:t}),wdl.setAffinityFeatures(i,!0),affinityAccumulator.add({custom:Object.keys(i).map(e=>e.replace(/^affinityTo/,""))}),0!==coreReports.cycle&&coreReports.shouldSend&&!coreReports.cyclesAreActive&&(coreReports.cyclesAreActive=!0),storageManagers.persistAll()}}};return e})(),calculationsCycle=(()=>{const e=new class{constructor(){this.callbacks={},this.results={},this.ready=!1}async init(){this.ready||(this.ready=!0,setInterval(()=>{notifier.fire("cycle"),Object.entries(e.callbacks).forEach(([e,t])=>{if(t)try{const e=t();e&&(this.results={...this.results,...e})}catch(t){aiLoggerManager.error(`Unable to calculate ${e}: ${t}`,"CalculationsCycle")}}),Object.keys(this.results).length&&wdl.isReady&&(wdl.set(this.results),this.results={})},configurationsGetters.params.calculationsInterval||2e3),aiLoggerManager.info("Init complete","CalculationsCycle"))}add(e,t){const i=!this.callbacks[e];this.callbacks[e]=t,i&&aiLoggerManager.info(e+" calculation added","CalculationsCycle")}remove(e){this.callbacks[e]&&delete this.callbacks[e],aiLoggerManager.info(e+" calculation removed","CalculationsCycle")}runSpecific(e){if(this.callbacks[e])try{const t=this.callbacks[e]();t&&(this.results={...this.results,...t})}catch(t){aiLoggerManager.error(`Unable to calculate ${e}: ${t}`,"CalculationsCycle")}else aiLoggerManager.error("No calculation found for "+e,"CalculationsCycle")}};return e})(),{interactions:interactions,generateTargetReachedProbe:generateTargetReachedProbe}=(()=>{const{getCloseButton:e}={getCloseButton:(e,t,i="exit-btn",r="wandz-interaction-close-btn",n="span")=>{let s=e.closeButtonConfig?.offsets?.[t]||e.closeButtonConfig?.offsets?.desktop;s||(s={offsetX:0,offsetY:0});const a=e.closeButtonConfig?.background||{size:32,color:"#00000000",borderColor:"#00000000",radius:50},o=e.closeButtonConfig?.background?.size||32,c=.375*o,l=e.closeButtonConfig?.color||"#000000";return{html:`<${n} id="${r}" class="${i}"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.87097 0.366057C10.3591 -0.121966 11.1504 -0.122072 11.6385 0.366057C12.1261 0.854212 12.1264 1.64566 11.6385 2.13363L7.76941 6.0018L11.6385 9.87094L11.7245 9.96567C12.1243 10.4566 12.0959 11.1811 11.6385 11.6385C11.1811 12.096 10.4567 12.1243 9.96569 11.7245L9.87097 11.6385L6.00085 7.76938L2.13366 11.6375C1.64563 12.1255 0.85426 12.1253 0.366085 11.6375C-0.121993 11.1494 -0.122063 10.3581 0.366085 9.86996L4.23327 6.0018L0.366085 2.13461C-0.12203 1.64652 -0.121894 0.855216 0.366085 0.367033C0.854135 -0.121035 1.64547 -0.121806 2.13366 0.366057L6.00183 4.23422L9.87097 0.366057Z" fill="#2F2F2F"/></svg></${n}>`,styles:`\n#${r} {\n    position: absolute;\n    top: ${s.offsetY}px;\n    right: ${s.offsetX}px;\n    line-height: ${c}px;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    overflow: hidden;\n    width: ${o}px;\n    height: ${o}px;\n    background-color: ${a.color};\n    border-radius: ${a.radius}px;\n    box-shadow: inset 0 0 0 1.5px ${a.borderColor};\n}\n#${r} svg {\n    height: ${c}px;\n    width: ${c}px;\n}\n#${r} svg path {\n    fill: ${l};\n}\n#${r}::after {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background-color: #ffffff;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n    pointer-events: none;\n}\n#${r}:hover::after {\n    opacity: 0.3;\n}\n`}}};class t{constructor(e,t=!1){this.hostId="wandz-interaction-container",this.wrapperId="wandz-interaction-wrapper",this.overlayId="wandz-interaction-overlay",this.MAX_Z_INDEX=2147483646,this.animationOpenType="fadeIn 1s forwards",this.animationCloseType="fadeOut 1s forwards",this.closeBtnId="wandz-interaction-close-btn",this.interactionGuid=e,this.reminderFirst=t,this.host=null,this.extraElement=null}show(e,t,i,r=null){if(!this.interactionGuid||!e)return void aiLoggerManager.warn(`Unable to show the popup - guid: ${this.interactionGuid}; position: ${e}`);const n=configurationsGetters.configurations.tag;let s=configurationsGetters.params.interactionsDomain||globals.cdnUrl;s.endsWith("/")||(s+="/");const a=`${s}${configurationsGetters.params.interactionsPath||"interactions-htmls"}/${n}_${this.interactionGuid}.html`;aiLoggerManager.info(a,"popupManager - downloading the popup:");const o=new NmgWorker(e=>{const t=e.url;fetch(t).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.text()},e=>postMessage(e)).then(e=>postMessage(e),e=>postMessage(e))},n=>{n instanceof Error?aiLoggerManager.error(n,"popupManager.show-fetchHTML-WebWorker"):this.processWithHtml(n,e,t,i,r)},{fallbackToMainThread:!0});o.run({url:a})}processWithHtml(e,t,r,n,s=null){aiLoggerManager.info(this.interactionGuid,"popupManager: start HTML rendering"),this.initShadowRoot("Popup"),this.injectExtraCss(),this.injectWrapper(!!r),r&&this.addOverlay(r),this.injectHtml(e),this.addCloseButton(n,"Popup",s),this.positioningWrapper(t),this.bindListeners(),document.fonts.ready.then(function(){this.displayPopup(!0),i.storeAndInformAboutChanges({guid:this.interactionGuid,wasShown:!0}),aiLoggerManager.info(this.interactionGuid,"popupManager: HTML rendering FINISHED")}.bind(this))}initShadowRoot(e){const t=document.createElement("div");t.id=this.hostId,document.body.appendChild(t),this.host=t,this.host._entityType=e,this.shadowRoot=t.attachShadow({mode:"open"})}injectExtraCss(e){if(e){const t=document.createElement("div");t.innerHTML=e,this.extraElement=t,document.body.appendChild(t)}else{const e=document.createElement("style");e.type="text/css",e.innerText="@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes fadeOut{from{opacity:1}to{opacity:0}}",this.shadowRoot.appendChild(e)}}injectWrapper(e){const t=document.createElement("div");t.id=this.wrapperId,t.style.display="none",t.style.position="fixed",t.style.zIndex=""+this.MAX_Z_INDEX,e||(t.style.border="1px solid #D8DBE0"),t.style.maxHeight=window.innerHeight-96+"px",this.wrapper=t,this.shadowRoot.appendChild(t)}addOverlay(e){const t=document.createElement("div");t.id=this.overlayId,t.style.display="block",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.zIndex=""+(this.MAX_Z_INDEX-1),t.style.backgroundColor=e,t.onclick=function(e){e.preventDefault(),e.stopPropagation(),this.closePopup("Popup","Closed")}.bind(this),this.shadowRoot.appendChild(t)}injectHtml(e){const t=document.createElement("div");t.innerHTML=e,t.querySelectorAll('link[rel="stylesheet"]').forEach(e=>{document.head.querySelector(`link[href="${e.href}"]`)||document.head.appendChild(e.cloneNode(!0)),e.remove()}),this.wrapper.innerHTML=t.innerHTML,this.wrapper.querySelectorAll("script").forEach(e=>{const t=document.createElement("script");t.textContent=e.textContent.replaceAll("document.",`document.querySelector('#${this.hostId}').shadowRoot.`),this.wrapper.appendChild(t),this.wrapper.removeChild(t)})}addCloseButton(t,i,r){const{html:n,styles:s}=e({closeButtonConfig:r,closeButtonColor:t},wdl.device===Devices.PC?"desktop":"mobile","exit-btn",this.closeBtnId,"span"),a=document.createElement("div");a.innerHTML=n.trim();const o=a.firstChild;o.onclick=function(e){e.preventDefault(),e.stopPropagation(),this.closePopup(i)}.bind(this),this.wrapper.appendChild(o);const c=document.createElement("style");c.type="text/css",c.innerText=s,this.wrapper.appendChild(c)}displayPopup(e){this.wrapper.style.display="block",this.wrapper.style.animation=this.animationOpenType,e&&(notifier.fire("interactionPopupDisplayed",this.interactionGuid),notifier.fire("_interactionPopupDisplayed",this.interactionGuid),userEvents.bindClickListenerToShadowRoot(this.shadowRoot))}closePopup(e="Popup",t="Closed"){this.wrapper.style.animation=this.animationCloseType,this.wrapper.addEventListener("animationend",function(){this.wrapper.style.display="none",this.shadowRoot.innerHTML="",this.host.remove(),this.host=null,this.extraElement&&(this.extraElement.remove(),this.extraElement=null),notifier.fire(`interaction${e}${t}`,this.interactionGuid),notifier.fire(`_interaction${e}${t}`,this.interactionGuid),"Popup"===e&&"Closed"===t&&i.storeAndInformAboutChanges({guid:this.interactionGuid,isClosed:!0},!0)}.bind(this),{once:!0})}positioningWrapper(e){let t=configurationsGetters.params.interactionsZeroMarginSize;coreUtils.isUndefined(t)&&(t=48);const i=t+"px",r="50%",n="translateX(-50%)",s="translateY(-50%)";if(this.checkSticky(e)){switch(e){case PopupPositions.TopCenter:this.wrapper.style.top="0";break;case PopupPositions.BottomCenter:this.wrapper.style.bottom="0"}this.wrapper.style.left="0",this.wrapper.style.width="100%",this.overloadInnerCss()}else switch(e){case PopupPositions.TopLeft:this.wrapper.style.top=i,this.wrapper.style.left=i;break;case PopupPositions.TopCenter:this.wrapper.style.top=i,this.wrapper.style.left=r,this.wrapper.style.transform=n;break;case PopupPositions.TopRight:this.wrapper.style.top=i,this.wrapper.style.right=i;break;case PopupPositions.MiddleLeft:this.wrapper.style.top=r,this.wrapper.style.transform=s,this.wrapper.style.left=i;break;case PopupPositions.MiddleCenter:this.wrapper.style.top=r,this.wrapper.style.transform="translate(-50%, -50%)",this.wrapper.style.left=r;break;case PopupPositions.MiddleRight:this.wrapper.style.top=r,this.wrapper.style.transform=s,this.wrapper.style.right=i;break;case PopupPositions.BottomLeft:this.wrapper.style.bottom=i,this.wrapper.style.left=i;break;case PopupPositions.BottomCenter:this.wrapper.style.bottom=i,this.wrapper.style.left=r,this.wrapper.style.transform=n;break;case PopupPositions.BottomRight:this.wrapper.style.bottom=i,this.wrapper.style.right=i}}checkSticky(e){let t=!0;const i=configurationsGetters.params.interactionsSticky;if(coreUtils.isUndefined(i)||(t=!!i),t&&(t=[PopupPositions.TopCenter,PopupPositions.BottomCenter].indexOf(e)>=0),t){let e=configurationsGetters.params.interactionsStickyMaxHeight;coreUtils.isUndefined(e)||(t=this.calculateWrapperHeight()<=e)}return t}calculateWrapperHeight(){this.wrapper.style.visibility="hidden",this.wrapper.style.display="block";const e=this.wrapper.offsetHeight;return this.wrapper.style.display="none",this.wrapper.style.visibility="",e}overloadInnerCss(){const e=document.createElement("style");e.type="text/css",e.innerText=".bee-popup-container{width:100%}@media(max-width:520px){.bee-popup-container{width:100%}}.bee-popup-container .bee-popup-row-content{max-width:100%}@media(max-width:520px){.bee-popup-row-content:not(.no_stack){display:block;max-width:350px}}",this.wrapper.appendChild(e)}bindListeners(){aiLoggerManager.info("bind listeners","Interactions: popupManager:");const e=function(e){aiLoggerManager.info(this.interactionGuid,"Interaction clicked:"),notifier.fire("interactionPopupClicked",this.interactionGuid,e.currentTarget),notifier.fire("_interactionPopupClicked",this.interactionGuid,e.currentTarget),"true"===e.currentTarget.getAttribute("close-onclick")&&(aiLoggerManager.info(this.interactionGuid,"Interactions: Closing popup on click"),this.closePopup())}.bind(this);this.wrapper.querySelectorAll("img, a, button, .bee-popup-button-content, .bee-popup-form-option-wrapper").forEach(t=>{coreUtils.addClickHandler("popupManager.bindListeners",t,e,!0)})}showReminder(e,t,r,n,s){this.interactionGuid&&e?(aiLoggerManager.info(this.interactionGuid,"popupManager: start Reminder rendering"),this.initShadowRoot("Reminder"),this.injectExtraCss(),s&&this.injectExtraCss(s),this.injectWrapper(!1),this.injectHtml(n),this.wrapper.style.backgroundColor=r,this.wrapper.style.border="0px solid "+r,this.wrapper.style.padding="8px 16px",this.wrapper.style.cursor="pointer",this.wrapper.style.overflow="hidden",t&&(this.addCloseButton(t,"Reminder"),this.wrapper.style.paddingRight="40px"),this.positioningReminderWrapper(e),this.addBordersWrapper(e),this.bindReminderListeners(),this.displayPopup(this.reminderFirst),this.reminderFirst&&i.storeAndInformAboutChanges({guid:this.interactionGuid,wasShown:!0}),aiLoggerManager.info(this.interactionGuid,"popupManager: Reminder rendering FINISHED")):aiLoggerManager.warn(`Unable to show the reminder - guid: ${this.interactionGuid}; position: ${e}`,"showReminder")}getClientDimensionsOfHiddenWrapper(){const e=this.wrapper.style.display,t=this.wrapper.style.zIndex;this.wrapper.style.zIndex="-1",this.wrapper.style.display="block";const i=this.wrapper.clientHeight,r=this.wrapper.clientWidth;return this.wrapper.style.display=e,this.wrapper.style.zIndex=t,{clientHeight:i,clientWidth:r}}positioningReminderWrapper(e){const t="0",i="translateX(-50%)",r="50%",{clientHeight:n,clientWidth:s}=this.getClientDimensionsOfHiddenWrapper();switch(e===ReminderPositions.LeftTop&&(this.wrapper.style.transformOrigin="left bottom",this.wrapper.style.transform=`rotate(90deg) translate(-${n}px, 0)`),e===ReminderPositions.LeftBottom&&(this.wrapper.style.transformOrigin="right bottom",this.wrapper.style.transform=`rotate(90deg) translate(0, ${s}px)`),e===ReminderPositions.RightTop&&(this.wrapper.style.transformOrigin="right bottom",this.wrapper.style.transform=`rotate(-90deg) translate(${n}px, 0)`),e===ReminderPositions.RightBottom&&(this.wrapper.style.transformOrigin="left bottom",this.wrapper.style.transform=`rotate(-90deg) translate(0, ${s}px)`),e){case ReminderPositions.TopLeft:case ReminderPositions.LeftTop:this.wrapper.style.top=t,this.wrapper.style.left=t;break;case ReminderPositions.TopCenter:this.wrapper.style.top=t,this.wrapper.style.left=r,this.wrapper.style.transform=i;break;case ReminderPositions.TopRight:case ReminderPositions.RightTop:this.wrapper.style.top=t,this.wrapper.style.right=t;break;case ReminderPositions.LeftCenter:this.wrapper.style.top=r,this.wrapper.style.left=t,this.wrapper.style.transformOrigin="left bottom",this.wrapper.style.transform=`rotate(90deg) translateX(-50%) translate(-${n}px, 0)`;break;case ReminderPositions.RightCenter:this.wrapper.style.top=r,this.wrapper.style.right=t,this.wrapper.style.transformOrigin="right bottom",this.wrapper.style.transform=`rotate(-90deg) translateX(50%) translate(${n}px, 0)`;break;case ReminderPositions.LeftBottom:case ReminderPositions.BottomLeft:this.wrapper.style.bottom=t,this.wrapper.style.left=t;break;case ReminderPositions.BottomCenter:this.wrapper.style.bottom=t,this.wrapper.style.left=r,this.wrapper.style.transform=i;break;case ReminderPositions.RightBottom:case ReminderPositions.BottomRight:this.wrapper.style.bottom=t,this.wrapper.style.right=t}}addBordersWrapper(e){0>[ReminderPositions.TopLeft,ReminderPositions.TopCenter,ReminderPositions.TopRight].indexOf(e)?this.wrapper.style.borderRadius="8px 8px 0px 0px":this.wrapper.style.borderRadius="0px 0px 8px 8px"}bindReminderListeners(){coreUtils.addClickHandler("bindReminderListeners",this.wrapper,function(e){e.target.closest("#"+this.closeBtnId)||(this.closePopup("Reminder","Clicked"),this.reminderFirst&&(notifier.fire("interactionPopupClicked",this.interactionGuid,e.currentTarget),notifier.fire("_interactionPopupClicked",this.interactionGuid,e.currentTarget)))}.bind(this))}}const i=new class{constructor(){this.storageManager=null,this.config={},this.displayFrequencyDeniedGuids={},this.configNames={},this.mainInteractionGuid="",this.singleGuids={},this.singleProbes={},this.multiGuids={},this.multiProbes={},this.device="",this.dataToSend={},this.popupManager=null,this.targetReachedProbes={},this.secondaryTargetReachedProbes={},this.waitForTargetReachedInteractions={},this.onceNotified=!1,this.isLiveQA=!1,this.hasNewTestGroupCalculated=!1,this.isReady=!1,this.allDataWasReturned=!1}async init(){this.storageManager=storageManagers.getStorageManager(__INJECTIONS__.isDemo?"wandz-interactions-demo":"wandz-interactions"),this.storageManager.forcePersist=!0,this.storageManager.forceLoad=!0,session.sessionWasExpired&&this.clearInteraction("",!0),n.reset(),this.singleProbes={},this.multiProbes={},this.targetReachedProbes={},this.secondaryTargetReachedProbes={},this.waitForTargetReachedInteractions={},this.config={},this.configNames={},this.singleGuids={},this.multiGuids={},(configurationsGetters.interactions||[]).forEach(e=>{this.config[e.guid]=e,this.configNames[e.n.toLowerCase()]=e,e.i?this.multiGuids[e.guid]=e:this.singleGuids[e.guid]=e}),this.initDisplayFrequency(),this.device="",this.dataToSend={},this.needUserActivityHandler=!1,this.needExitIntentEvent=!1,this.onceNotified=!1,this.isLiveQA=liveQA.isTestingMode,this.hasNewTestGroupCalculated=!1;let{mainInteraction:e,allInteractions:t}=this.getStoredInteraction();e.guid&&!this.checkStoredInteraction(e)&&(this.clearInteraction(e.guid),delete t[e.guid],e={});const i=[],r=[];let s=null;Object.keys(t).forEach(e=>{const n=t[e];if(!this.checkStoredInteraction(n))return this.clearInteraction(e),void delete t[e];r.push(e),this.needToReachTargetCheck(n)&&i.push(n),n.isTest&&this.getInteractionConfig(e).r&&!n.reminderClosed&&!n.reminderDisabled&&(s=e)}),this.mainInteractionGuid=e.guid,i.length&&(aiLoggerManager.info(i,"Interactions: Waiting for target reached"),notifier.bind("pageDataCollected",function(){this.startWaitingForTargetReached(i)}.bind(this))),r.length&&(aiLoggerManager.info(r,"Interactions: Stored interactions loaded"),notifier.bind("pageDataCollected",function(){r.forEach(this.notifyInteractionChanged.bind(this))}.bind(this))),s&&(aiLoggerManager.info(s,"Interactions: has TEST group and configured reminder"),notifier.bind("pageDataCollected",function(){this.showInteractionReminder(s)}.bind(this)));let a=!1;const o=(e,i)=>{Object.keys(e).forEach(r=>{if(t[r])return;const n=e[r];i[r]=this.prepareProbe(n),a=!0})};this.mainInteractionGuid||o(this.singleGuids,this.singleProbes),o(this.multiGuids,this.multiProbes),aiLoggerManager.info(a,"Interactions: Prepared interaction probes:"),a?notifier.bind("pageDataCollected",this.start.bind(this)):notifier.bind("pageDataCollected",function(){this.notifyInteractionChanged()}.bind(this)),notifier.retroBind("showInteractionReminder",this.showInteractionReminder.bind(this)),notifier.retroBind("testInteractionAppearance",this.testInteractionAppearance.bind(this)),notifier.retroBind("pageDataCollected",this.livePreview.bind(this)),this.allDataWasReturned=!1,this.isReady=!0}needToReachTargetCheck(e){return!e.isReached&&e.targetRule||!e.isSecondaryReached&&e.secondaryTargetRule}getForceInteractionGuid(){const e=liveQA.guid;return e&&(this.singleGuids[e]||this.multiGuids[e])?e:""}getForceInteractionGroup(){return(coreUtils.getQueryParamsAsObject()||{})["wandz-force-interaction-group"]||""}getActiveInteractionData(){if(!i.isReady)return{};const{allInteractions:e}=i.getStoredInteraction();if(!e||!Object.keys(e).length)return{};const t={};return Object.values(e).forEach(e=>{void 0!==e.isTest&&(t[e.guid]={group:e.isTest?"test":"control",isClicked:+(e.isClicked||0),isDisplayed:+(e.wasShown||0),isMulti:+(e.isMulti||0),isLiveQA:+(e.isLiveQA||0)},e.targetRule?"averageValue"===e.targetRule.op?t[e.guid].targetValue=e.targetValue:t[e.guid].isTargetReached=+(e.isReached||0):t[e.guid].isTargetReached=0,e.secondaryTargetRule?"averageValue"===e.secondaryTargetRule.op?t[e.guid].secondaryTargetValue=e.secondaryTargetValue:t[e.guid].isSecondaryTargetReached=+(e.isSecondaryReached||0):t[e.guid].isSecondaryTargetReached=0)}),i.allDataWasReturned=!0,{interactions:t}}getChanges(){if(!i.isReady)return{};if(!i.allDataWasReturned)return i.getActiveInteractionData();const e=i.dataToSend;return e&&Object.keys(e).length?(i.dataToSend={},{interactions:e}):{}}getStoredInteraction(){return{mainInteraction:i.storageManager.getItem("interaction")||{},allInteractions:i.storageManager.getItem("allInteractions")||{}}}prepareProbe(e){return e.dt&&(e.dt.i&&(this.needUserActivityHandler=!0),e.dt.e&&(this.needUserActivityHandler=!0,this.needExitIntentEvent=!0)),()=>{let t=!0;return!(e.isTest&&!i.isLiveQA)&&(e.u&&(t=("or"===e.u.op?aiUtils.orBunch:aiUtils.andBunch)(i.getUrlCheckers(e.u.r))),t&&e.t&&(t=aiUtils.checkForTarget(e.t)),t&&e.dt&&(t=aiUtils.andBunch(i.getDisplayCheckers(e.dt))),t)}}start(){aiLoggerManager.info("Start checking for eligible interaction","Interactions: "),this.needUserActivityHandler&&(n.isReady()||n.init(),this.needExitIntentEvent&&notifier.bind("exitIntent",this.performCheckAll.bind(this))),this.device=wdl.device.toLowerCase(),calculationsCycle.add("interactions",this.performCheckAll.bind(this))}performCheckAll(){if(this.mainInteractionGuid&&!Object.keys(this.multiProbes).length)return void this.stopCalculations();const e=this.getEligibleInteractions();if(e.force)return aiLoggerManager.info(e.force,"Interactions: FORCE Eligible interaction detected"),void this.performInteraction([e.force],!1,e.forceInteractionGuid);e.single.length&&(aiLoggerManager.info(e.single,"Interactions: SINGLE Eligible interactions detected"),this.performInteraction(e.single,!1,e.forceInteractionGuid)),e.multi.length&&(aiLoggerManager.info(e.multi,"Interactions: MULTI Eligible interactions detected"),this.performInteraction(e.multi,!0,e.forceInteractionGuid)),this.notifyInteractionChangedOnce()}getEligibleInteractions(){const e=this.getForceInteractionGuid();if(e&&liveQA.forceShow){const t=this.getInteractionConfig(e);if(t)return{force:t,forceInteractionGuid:e}}return{single:this.mainInteractionGuid?[]:this._getEligibleInteractions(this.singleProbes,"single",e),multi:this._getEligibleInteractions(this.multiProbes,"multi",e),forceInteractionGuid:e}}_getEligibleInteractions(e,t,i){return Object.keys(e).reduce((r,n)=>{if(i&&i!==n)return r;if(this.displayFrequencyDeniedGuids[n])return r;if(e[n]()){const e=this.config[n];aiLoggerManager.info(`[${n}][${e.n}][${e.cp||"A"}] interaction (${t}) is eligible to show.`,"getEligibleInteractions"),r.push(e)}return r},[])}getUrlCheckers(e){return e.map(e=>r(e))}getDisplayCheckers(e){const t=[];return e.td&&e.td.value&&t.push(()=>(("w"===e.td.scope?wdl.get("timeOnSiteValue","aiFeature"):wdl.get("timeOnPageValue","aiFeature"))||0)>=e.td.value),e.ps&&t.push(()=>aiUtils.getPageScrollPercentage()>=e.ps),e.pvc&&t.push(()=>(wdl.get("pageCount","aiFeature")||0)>=e.pvc),e.i&&(n.isReady()||n.init(),t.push(()=>(n.getInactivitySeconds()||0)>=e.i)),e.e&&(n.isReady()||n.init(),t.push(()=>{if("pc"===i.device)return 20>=(n.getLastMousePosition()||0);{const e=n.getInactivitySeconds();return configurationsGetters.params.mobileExitIntentOnFastScroll&&wdl.get("scrollSpeed","aifeature")>=(configurationsGetters.params.mobileExitIntentOnFastScrollScoreThreshold||3)||(e||0)>=30}})),t.length||t.push(()=>!0),t}performInteraction(e,t=!1,r=""){if(!t){const t=e.reduce((e,t)=>{const i=t.cp||"A";return e[i]||(e[i]=[]),e[i].push(t),e},{}),i=Object.keys(t);i.length>1&&(i.sort((e,t)=>t.localeCompare(e)),e=t[i[0]]),e=[e[Math.floor(Math.random()*e.length)]]}let n=this.getForceInteractionGroup();r&&(n="test");let s=!1;const a="USER"===configurationsGetters.params.interactionTestGroupStickiness;e.sort((e,t)=>(t.cp||"A").localeCompare(e.cp||"A")).forEach(e=>{if(i.hasNewTestGroupCalculated)return;let r;const o=(e.ct||{}).tgs||(configurationsGetters.params.interactionTestGroupStickiness||"S")[0];if("U"===o||"S"!==o&&a){const t=i.storageManager.getItem("interactionGroups")||{},s=t[e.guid];r=s?s.isTest:100*Math.random()<=e.ct.tg,n&&(r="test"===n),t[e.guid]={isTest:r},i.storageManager.setItem("interactionGroups",t)}else r=100*Math.random()<=e.ct.tg,n&&(r="test"===n);this.storeInteraction(e,r),t?delete this.multiProbes[e.guid]:this.mainInteractionGuid=e.guid,this.mainInteractionGuid&&!Object.keys(this.multiProbes).length&&this.stopCalculations(),r?(s||this.refreshClickListenerNotifier(),i.hasNewTestGroupCalculated=!0,s=!0,this.showInteraction(e),this.stopCalculations()):aiLoggerManager.info(e,`performInteraction: interaction is eligible but in Control group (${e.ct.tg})`);const{allInteractions:c}=this.getStoredInteraction(),l=c[e.guid],d=this.checkTargetReached(l);this.storeAndInformAboutChanges({guid:e.guid,isTest:r,isReached:d.isReached||void 0,targetValue:d.targetValue||void 0,isSecondaryReached:d.isSecondaryReached||void 0,secondaryTargetValue:d.secondaryTargetValue||void 0}),(!d.isReached&&e.ct.rule||!d.isSecondaryReached&&d.hasSecondary)&&(Object.keys(this.waitForTargetReachedInteractions).length?this.waitForTargetReachedInteractions[e.guid]=l:this.startWaitingForTargetReached([l])),this.notifyInteractionChanged(e.guid)})}notifyInteractionChanged(e){notifier.fire("interactionChanged",e),notifier.fire("_interactionChanged",e)}notifyInteractionChangedOnce(){this.onceNotified||(this.onceNotified=!0,notifier.fire("interactionChanged",""),notifier.fire("_interactionChanged",""))}clearInteraction(e,t){if(t)return i.storageManager.setItem("interaction",null),void i.storageManager.setItem("allInteractions",null);if(!e)return;let{mainInteraction:r,allInteractions:n}=i.getStoredInteraction();r.guid===e&&i.storageManager.setItem("interaction",null),n[e]&&(delete n[e],i.storageManager.setItem("allInteractions",n))}storeInteraction(e,t){if(!e)return i.storageManager.setItem("interaction",null),void i.storageManager.setItem("allInteractions",null);e.i||i.storageManager.setItem("interaction",{guid:e.guid,name:e.n,targetRule:e.ct.rule,secondaryTargetRule:e.ct.secRule?e.ct.secRule:void 0,isTest:t,isLiveQA:e.isTest});const r=i.storageManager.getItem("allInteractions")||{};r[e.guid]={guid:e.guid,name:e.n,targetRule:e.ct.rule,secondaryTargetRule:e.ct.secRule?e.ct.secRule:void 0,isTest:t,isLiveQA:e.isTest,isMulti:e.i},i.storageManager.setItem("allInteractions",r)}showInteraction(e,i=!1){aiLoggerManager.info(e,"showInteraction"),this.popupManager&&this.popupManager.guid!==e.guid&&this.popupManager.host&&(aiLoggerManager.info(this.popupManager.guid,`Interaction: Old ${this.popupManager.host._entityType} closed before showing new one`),this.popupManager.closePopup(this.popupManager.host._entityType));const r=e.r&&e.r.f&&!i;this.popupManager=new t(e.guid,r);try{r?(aiLoggerManager.info(e,"showInteraction: reminderFirst"),this.showInteractionReminder(e.guid)):this.popupManager.show(e.p,e.wo,e.cbc,e.cbcfg)}catch(e){aiLoggerManager.error(e,"showInteraction: Unable to show the interaction!")}e.r&&(this.setEnabledReminder(e.guid),notifier.unbind("_interactionPopupClosed"),notifier.bind("_interactionPopupClosed",function(e){this.showInteractionReminder(e)}.bind(this)))}startWaitingForTargetReached(e){this.waitForTargetReachedInteractions={},e.forEach(e=>{this.waitForTargetReachedInteractions[e.guid]=e}),calculationsCycle.add("interactionsWaitForTargetReached",function(){Object.values(this.waitForTargetReachedInteractions).forEach(e=>{this.checkTargetReached(e)})}.bind(this))}stopWaitingForTargetReached(e){delete this.waitForTargetReachedInteractions[e],Object.keys(this.waitForTargetReachedInteractions).length||calculationsCycle.remove("interactionsWaitForTargetReached")}stopCalculations(){calculationsCycle.remove("interactions")}checkTargetReached(e){const t={guid:"",isReached:!1,isSecondaryReached:!1,hasSecondary:!1,targetValue:void 0,secondaryTargetValue:void 0};if(!e)return t;const{allInteractions:i,mainInteraction:n}=this.getStoredInteraction();if(!(e=i[e.guid]))return t;let s={guid:e.guid,isReached:e.isReached,isSecondaryReached:e.isSecondaryReached,targetValue:e.targetValue,secondaryTargetValue:e.secondaryTargetValue,hasSecondary:!1};if(!e.isReached&&e.targetRule){this.targetReachedProbes[e.guid]||(this.targetReachedProbes[e.guid]=r(e.targetRule,!1));const t=this.targetReachedProbes[e.guid]();s.isReached=t.isReached,s.targetValue=t.targetValue}if(!e.isSecondaryReached&&e.secondaryTargetRule){this.secondaryTargetReachedProbes[e.guid]||(this.secondaryTargetReachedProbes[e.guid]=r(e.secondaryTargetRule,!1));const t=this.secondaryTargetReachedProbes[e.guid]();s.isSecondaryReached=t.isReached,s.secondaryTargetValue=t.targetValue,s.hasSecondary=!0}return s.isReached===e.isReached&&s.isSecondaryReached===e.isSecondaryReached&&s.targetValue===e.targetValue&&s.secondaryTargetValue===e.secondaryTargetValue||this.storeAndInformAboutChanges(s),!s.isReached||!s.isSecondaryReached&&s.hasSecondary||this.stopWaitingForTargetReached(e.guid),s}storeAndInformAboutChanges(e,t=!1){const r=e.guid;if(!r)return void aiLoggerManager.warn(e,"Interactions: storeAndInformAboutChanges: guid is not provided!");e.wasShown&&this.updateAppearsAt(r);const{mainInteraction:n,allInteractions:s}=this.getStoredInteraction(),a=s[r];e.isLiveQA=this.config[r].isTest,!e.isClosed||a.isClicked||e.isClicked||(notifier.fire("interactionPopupClosedWithoutClick",r),notifier.fire("_interactionPopupClosedWithoutClick",r)),s[r]={...a,...e},i.storageManager.setItem("allInteractions",s),n.guid===r&&i.storageManager.setItem("interaction",{...n,...e}),wdl.loadStoredInteraction(!0),t||(this.dataToSend[r]=this.dataToSend[r]||{},void 0!==e.isTest&&(this.dataToSend[r].group=e.isTest?"test":"control"),void 0!==e.isReached&&(this.dataToSend[r].isTargetReached=+e.isReached),void 0!==e.isSecondaryReached&&(this.dataToSend[r].isSecondaryTargetReached=+e.isSecondaryReached),void 0!==e.targetValue&&(this.dataToSend[r].targetValue=e.targetValue),void 0!==e.secondaryTargetValue&&(this.dataToSend[r].secondaryTargetValue=e.secondaryTargetValue),void 0!==e.isClicked&&(this.dataToSend[r].isClicked=+e.isClicked),void 0!==e.wasShown&&(this.dataToSend[r].isDisplayed=+e.wasShown),this.dataToSend[r].isLiveQA=+a.isLiveQA,this.dataToSend[r].isMulti=+(a.isMulti||0),coreReports.shouldSend=!0,coreReports.cyclesAreActive=!0)}getInteractionConfig(e){return this.config[e]||this.configNames[e.toLowerCase()]}testInteractionAppearance(e,t=!1){if(!e)return void aiLoggerManager.error("guidOrName is not provided!","testInteractionAppearance");const i=this.getInteractionConfig(e);i?this.showInteraction(i,t):aiLoggerManager.error(`Interaction with guid or name: ${e} not found!`,"testInteractionAppearance")}showInteractionReminder(e){if(!e)return void aiLoggerManager.error("guidOrName is not provided!","showInteractionReminder");const i=this.getInteractionConfig(e);if(!i)return void aiLoggerManager.error(`Interaction with guid or name: ${e} not found!`,"showInteractionReminder");if(!i.r)return void aiLoggerManager.error(`Interaction with guid or name: ${e} has no reminder!`,"showInteractionReminder");const r=new t(i.guid,i.r.f);this.popupManager=r;const n=i.r;try{r.showReminder(n.p,n.cbc,n.bgc,n.t,n.st)}catch(e){aiLoggerManager.error(e,"showInteraction: Unable to show the interaction!")}notifier.unbind("_interactionReminderClosed"),notifier.bind("_interactionReminderClosed",function(e){aiLoggerManager.info(e,"Interaction Reminder closed:"),this.storeAndInformAboutChanges({guid:e,reminderClosed:!0})}.bind(this)),notifier.unbind("_interactionReminderClicked"),notifier.bind("_interactionReminderClicked",function(e){aiLoggerManager.info(e,"Interaction Reminder clicked:"),this.refreshClickListenerNotifier(),this.testInteractionAppearance(e,!0)}.bind(this))}checkStoredInteraction(e){const t=this.getInteractionConfig(e.guid);if(!t)return aiLoggerManager.warn(e.guid,"checkStoredInteraction: Stored interaction wasn't found in the config:"),!1;if((t.isTest||e.isLiveQA)&&!this.isLiveQA)return aiLoggerManager.warn(e.guid,"checkStoredInteraction: Stored interaction is for a test, but it's no LiveQA runtime:"),!1;if(e.isTest&&!e.wasShown)return aiLoggerManager.warn(e.guid,"checkStoredInteraction: Stored interaction is belong to TEST group, but it wasn't shown:"),!1;const i=this.getForceInteractionGuid();return!i||i===e.guid||(aiLoggerManager.warn(e.guid,"checkStoredInteraction: Stored interaction is not the forced one:"),!1)}refreshClickListenerNotifier(){notifier.unbind("_interactionPopupClicked"),notifier.bind("_interactionPopupClicked",function(e,t){this.storeAndInformAboutChanges({guid:e,isClicked:!0,clickedElement:{text:(t.innerText||t.textContent||"").trim(),tagName:t.tagName.toLowerCase(),attributes:t.getAttributeNames().reduce((e,i)=>(e[i]=t.getAttribute(i),e),{})}})}.bind(this))}setEnabledReminder(e){const{allInteractions:t,mainInteraction:r}=this.getStoredInteraction();let n=!1;const s=i=>{i.guid&&(i.guid===e&&i.reminderDisabled&&(i.reminderDisabled=t[i.guid].reminderDisabled=!1,n=!0),i.guid===e||i.reminderDisabled||(i.reminderDisabled=t[i.guid].reminderDisabled=!0,n=!0))};s(r),Object.values(t).forEach(s),n&&(aiLoggerManager.info(`${e} [${t[e].name}]`,"Interactions: setEnabledReminder: new Reminder set"),i.storageManager.setItem("interaction",r),i.storageManager.setItem("allInteractions",t))}livePreview(){const e=this.getLivePreviewConfig();if(!e)return;aiLoggerManager.info(e,"Interactions: livePreview: Live Preview config found");const t=this.compressLiveConfig(e);this.stopCalculations(),this.showInteraction(t)}getLivePreviewConfig(){try{const e=(coreUtils.getQueryParamsAsObject()||{}).wandz_live_view;if(e)return JSON.parse(decodeURIComponent(e))}catch(e){aiLoggerManager.error(e,"Interactions: getLivePreviewConfig: Unable to parse live preview config")}}compressLiveConfig(e){const t=e.closeButtonConfig||{};return{guid:e.guid,isTest:e.isTest||!1,p:e.position,wo:e.websiteOverlay,cbc:e.closeButtonColor||t.strokeColor||"#000",cbcfg:e.closeButtonConfig}}initDisplayFrequency(){this.displayFrequencyDeniedGuids={};const e=this.getDefaultFrequency(),t=this.getFrequencyThresholds(),i=this.getAppearsAt();let r=!1;Object.entries(i).forEach(([n,s])=>{if(!this.config[n])return delete i[n],void(r=!0);const a=this.config[n].df||e;if("U"===a)return this.displayFrequencyDeniedGuids[n]=!0,void aiLoggerManager.info(`Interaction ${n} (${this.config[n].n}) display frequency rule (${a}) prevents it from showing`,"Interactions: checkDisplayFrequency");s!==t[a]?(delete i[n],r=!0):(this.displayFrequencyDeniedGuids[n]=!0,aiLoggerManager.info(`Interaction ${n} (${this.config[n].n}) display frequency rule (${a}) prevents it from showing`,"Interactions: checkDisplayFrequency"))}),r&&this.setAppearsAt(i)}getDefaultFrequency(){let e=configurationsGetters.params.interactionDisplayFrequency||"SameSession";return e="UsersLifetime"===e?"U":"SameDay"===e?"D":"S",e}getFrequencyThresholds(){return{S:dal.session.getOne("session_id"),D:(()=>{const e=new Date;return e.setHours(0,0,0,0),e.getTime()})()}}getAppearsAt(){return i.storageManager.getItem("appearsAt")||{}}setAppearsAt(e){i.storageManager.setItem("appearsAt",e)}updateAppearsAt(e){const t=i.config[e];if(!t)return;const r=i.getAppearsAt(),n=t.df||i.getDefaultFrequency();r[e]="U"===n?1:"D"===n?i.getFrequencyThresholds().D:i.getFrequencyThresholds().S,i.setAppearsAt(r)}},r=(e,t=!0)=>{const i="averageValue"===e.op;let r,n,s=e.v;switch(e.s){case SourceTypes.URL:r=()=>(window.location.href||"").toLowerCase(),e.op||(e.op=StringComparisonOperators.CONTAINS);break;case SourceTypes.PAGE_TITLE:r=()=>(document.title||"").toLowerCase(),e.op||(e.op=StringComparisonOperators.CONTAINS);break;case SourceTypes.SECTION:r=()=>wdl.get("pageType","aiFeature")||"",e.op||(e.op=StringComparisonOperators.EXACT_MATCH);break;case SourceTypes.AUDIENCE:case SourceTypes.CUSTOM_AUDIENCE:r=()=>wdl.get(e.fid,"audience")||0,s=1;break;case SourceTypes.EVENT:r=()=>+!!wdl.get(e.v,"event"),s=1;break;case SourceTypes.AFFINITY_TO_CATEGORY:r=()=>(wdl.get("affinityToCategories","affinity")||[]).map(e=>brandAndCategoryAffinity.categoryNameToId[e]);break;case SourceTypes.AFFINITY_TO_BRAND:r=()=>(wdl.get("affinityToBrands","affinity")||[]).map(e=>brandAndCategoryAffinity.brandNameToId[e]);break;case SourceTypes.AFFINITY_TO_COLOR:r=()=>{const e=wdl.getBranch(AFFINITY_PATH)||{},t="affinityInteractionsWith";return Object.keys(e).filter(i=>i.startsWith(t)&&e[i]).map(e=>e.replace(t,"").toLowerCase())};break;case SourceTypes.AFFINITY_TO_CUSTOM:r=()=>{const e=wdl.getBranch(CUSTOM_AFFINITIES_PATH)||{};return Object.keys(e).filter(t=>e[t]).map(e=>customAffinity.nameToIdMapping[e])};break;case SourceTypes.AI_FEATURE:r=()=>wdl.getByID(e.fid);break;case SourceTypes.CUSTOM_AI_FEATURE:r=()=>wdl.getCustomByID(e.fid);break;case SourceTypes.WDL:default:r=()=>wdl.get(e.v)||0,s=1}return n="isIn"===e.op&&Array.isArray(s)?(t,i)=>{if(!(t&&i&&t.length&&i.length))return!1;if(Array.isArray(t)||"u"===e.s)for(let e=0,r=i.length;r>e;e++)if(t.indexOf(i[e])>=0)return!0;return i.indexOf(t)>=0}:aiUtils.getComparator(e.op||"greaterThanOrEqualTo"),r&&n?()=>i?t?r():{targetValue:r()}:t?n(r(),s):{isReached:n(r(),s)}:()=>!t&&{isReached:!1}},n=new class{constructor(){this.ready=!1,this.lastEventTime=0,this.lastEventTimestamp=0,this.lastEventClientY=500,this.threshold=100,this.exitIntentThreshold=1e3,this.lastExitIntentEventTimestamp=0}isReady(){return n.ready}reset(){document.removeEventListener("mousemove",n.saveTimeStamp,!1),document.removeEventListener("click",n.saveTimeStamp,!1),document.removeEventListener("keydown",n.saveTimeStamp,!1),document.removeEventListener("touchstart",n.saveTimeStamp,!1),document.removeEventListener("scroll",n.saveTimeStamp,!1),n.ready=!1}init(){document.addEventListener("mousemove",n.saveTimeStamp,!1),document.addEventListener("click",n.saveTimeStamp,!1),document.addEventListener("keydown",n.saveTimeStamp,!1),document.addEventListener("touchstart",n.saveTimeStamp,!1),document.addEventListener("scroll",n.saveTimeStamp,!1),n.ready=!0,n.lastEventTime=Date.now(),n.lastEventTimestamp=performance.now(),n.lastEventClientY=500,n.lastExitIntentEventTimestamp=0;let e=0;configurationsGetters.params.mobileExitIntentOnFastScroll&&[Devices.TABLET,Devices.MOB].includes(wdl.device)&&notifier.bind("set-scroll-speed",t=>{if(t>=(configurationsGetters.params.mobileExitIntentOnFastScrollScoreThreshold||3)){const t=performance.now();t-e<n.threshold||(e=t,n.lastExitIntentEventTimestamp&&t-e<n.exitIntentThreshold||(n.lastExitIntentEventTimestamp=t,notifier.fire("exitIntent")))}})}getInactivitySeconds(){return n.lastEventTime?(Date.now()-n.lastEventTime)/1e3:0}getLastMousePosition(){return n.lastEventClientY}saveTimeStamp(e){e.timeStamp-n.lastEventTimestamp<n.threshold||(void 0!==e.clientY&&(n.lastEventClientY=e.clientY),n.lastEventTimestamp=e.timeStamp,n.lastEventTime=Date.now(),n.lastEventClientY>20||n.lastExitIntentEventTimestamp&&e.timeStamp-n.lastExitIntentEventTimestamp<n.exitIntentThreshold||(n.lastExitIntentEventTimestamp=e.timeStamp,notifier.fire("exitIntent")))}};return{interactions:i,generateTargetReachedProbe:r}})(),activations=new class{init(){this.activations={},this.boundActivations={}}add(e,t,i,r=!0){this.activations[e]=this.activations[e]||[],this.activations[e].push(t),this.boundActivations[e]||(notifier.bind(e+"Changed",t=>{this.runActivations(e,t)}),this.boundActivations[e]=!0),r&&i&&this.needToRunBackwards(i.value,i.defaultValue)&&(aiLoggerManager.info(`${e} was already calculated - run the activation (${JSON.stringify(i)})`,"activations.add"),this.runActivation(e,i.value,t))}runActivations(e,t){(this.activations[e]||[]).forEach(i=>this.runActivation(e,t,i))}runActivation(e,t,i){try{const r={dal:dal,utils:coreUtils,aiUtils:aiUtils,sUtils:aiUtils.sUtils,wdl:wdl,conf:configurationsGetters,fire:notifier.fire.bind(notifier),calculationsCycle:calculationsCycle};i.call(r,e,t)}catch(t){aiLoggerManager.error(`Failed activation [${e}]: ${t}`,"activations.runActivation")}}needToRunBackwards(e,t){return!(coreUtils.isNullish(e)||"null"===e||""===e||coreUtils.isArray(e)&&!e.length||coreUtils.isString(e)&&e===t||coreUtils.isNumber(e)&&0>e&&e===t)}},wdl=(()=>{const e=["timeOffTabValue","timeOnSiteValue","timeOnPageValue"],t=["pageType","pageCategory","inCart","inCheckout","inConfirmationPage","purchase","numberApplyCouponsOnPage","numberOfCreditCardTriesOnPage","numberOfLoginTriesOnPage","numberOfSubmitOrdersOnPage"],i=new class{constructor(){this.sendFeaturesInStack=!1,this.wdlObject={},this.isReady=!1}get wdlShortName(){return this._wdlShortName||""}set wdlShortName(e){e&&!this._wdlShortName&&(this._wdlShortName=e)}get wdlLongName(){return this._wdlLongName||""}set wdlLongName(e){e&&!this._wdlLongName&&(this._wdlLongName=e)}get device(){return this._device||(this._device=coreUtils.getDevice(),void 0!==this._device&&"undefined"!==this._device||(this._device=Devices.PC)),this._device}get browser(){return this._browser||(this._browser=this.get("browser","aiFeature")),this._browser}async init(e){const t=__INJECTIONS__.isDemo;this.wdlShortName=t?"WDLdemo":"WDL",this.wdlLongName=t?"wandzDataLayerDemo":"wandzDataLayer",(e||!window[this.wdlShortName]||coreUtils.isArray(window[this.wdlShortName]))&&(performanceMeasurer.start("WDL Init"),aiLoggerManager.info("Start to init DataLayer...","WDL Init"),this.collectedFeatures={},this.collectedCustomFeatures={},this.storageManager=storageManagers.getStorageManager(),configurationsGetters.params.send_back_ai_features_on_stack&&(this.sendFeaturesInStack=!0),this.aiFeaturesConfig=configurationsGetters.aiFeatures,e||this.initBaseWDLSkeleton(),this.loadStoredWdlObject(),this.initFeatureNameObjectLinks(),this.loadFeatureLastUpdatedObject(),this.loadStoredInteraction(),this.loadActivations(),this.exposeWdlObject(),this.stamps={S:""+(dal.session.getOne("sst")||""),P:""+(dal.session.getOne("pvst")||""),C:"1"},notifier.bind("hook-cycle",e=>{i.stamps.C=""+e}),window.__dbn_on__&&(aiLoggerManager.info("Expose some modules to the global context (window.wndz object) because of window.__dbn_on__="+window.__dbn_on__,"WDL Init"),window.wndz=window.wndz||{},window.wndz={...window.wndz,wdl:i,utils:{ai:aiUtils,core:coreUtils},userEvents:userEvents,interactions:interactions,configurationsGetters:configurationsGetters,calculationsCycle:calculationsCycle,detectPageType:pageTypeDetector.detect.bind(pageTypeDetector)}),this.RECALCULATE_USER_FEATURE=864e5*(configurationsGetters.params.userFeaturesExpiringDays||30),aiLoggerManager.info("DataLayer is ready","WDL Init"),this.isReady=!0,notifier.fire("wdl-ready"),session.sessionWasExpired&&notifier.fire("new-session"),session.isNewUser&&(notifier.fire("new-user"),notifier.fire("new-session")),performanceMeasurer.end("WDL Init"))}initBaseWDLSkeleton(){this.wdlObject={attributes:{wandzAttributes:{device:{environment:{battery:{},resolution:{}},general:{},settings:{},installs:{shopping:{installed:{},interacted:{},popped:{}}},languages:{}},journey:{accessibility:{},flow:{},interactions:{},languages:{},memory:{},performance:{},privacy:{},time:{}},visitor:{general:{},history:{}}},customAttributes:{}},aiFeatures:{wandzAiFeatures:{},customAiFeatures:{}},audiences:{customAudiences:{},wandzAudiences:{}},predictions:{},events:{},affinity:{},activations:{search:{},interactions:{},custom:{}}}}loadStoredWdlObject(){const e=this.storageManager.getItem(WDLStorageKeys.MAIN_STORAGE);e&&(!e[ATTRIBUTES_NAME]&&e[OLD_ATTRIBUTES_NAME]&&(e[ATTRIBUTES_NAME]={[WANDZ_ATTRIBUTES_NAME]:e[OLD_ATTRIBUTES_NAME][OLD_WANDZ_ATTRIBUTES_NAME],[CUSTOM_ATTRIBUTES_NAME]:e[OLD_ATTRIBUTES_NAME][OLD_CUSTOM_ATTRIBUTES_NAME]}),this.wdlObject=e)}loadFeatureLastUpdatedObject(){const e=this.storageManager.getItem(WDLStorageKeys.FEATURE_LAST_UPDATED);this.featureLastUpdated=e||{};const t=this.storageManager.getItem(WDLStorageKeys.CUSTOM_FEATURE_LAST_UPDATED);this.customFeatureLastUpdated=t||{}}loadStoredInteraction(e=!1){const{allInteractions:t,mainInteraction:i}=interactions.getStoredInteraction();this.wdlObject.activations=this.wdlObject.activations||{},i&&0!==Object.keys(i).length?this.wdlObject.activations.interactions=this._extractInteractionData(i):this.wdlObject.activations.interactions=null,t&&Object.keys(t).length>0?(this.wdlObject.activations.allInteractions={},Object.keys(t).forEach(e=>{const i=this._extractInteractionData(t[e]);this.wdlObject.activations.allInteractions[i.campaignName]=i})):this.wdlObject.activations.allInteractions=null,this.wdlObject.interactions=this.wdlObject.activations.interactions,this.wdlObject.allInteractions=this.wdlObject.activations.allInteractions,e&&this.exposeWdlObject()}_extractInteractionData(e){return{campaignName:e.name||"",group:e.name?e.isTest?"test":"control":"",isClicked:e.isClicked||0,reachedTarget:e.isReached||0,targetValue:e.targetValue,reachedSecondaryTarget:e.isSecondaryReached||0,secondaryTargetValue:e.secondaryTargetValue,clickedElement:e.clickedElement||{}}}storeSearch(e,t){this.wdlObject.activations=this.wdlObject.activations||{},e&&0!==Object.keys(e).length&&t?(this.wdlObject.activations.search={name:e.name||"",group:t,groupSize:e.testGroupSize||0},e.isTest&&(this.wdlObject.activations.search.isLiveQA=!0)):this.wdlObject.activations.search=null,this.exposeWdlObject()}storeAbTests(e){this.wdlObject.activations=this.wdlObject.activations||{},e&&0!==Object.keys(e).length?(this.wdlObject.activations.custom={},Object.values(e).forEach(e=>{this.wdlObject.activations.custom[e.name]={name:e.name,guid:e.guid,group:e.testGroup,groupSize:e.testGroupSize,targetReached:e.isAbTestTarget,targetValue:e.targetValue,secondaryTargetReached:e.isAbTestSecondaryTarget,secondaryTargetValue:e.secondaryTargetValue,isAbTestInteracted:e.isAbTestInteracted||0,abTestInteractedValue:e.abTestInteractedValue||""},e.isTest&&(this.wdlObject.activations.custom[e.name].isLiveQA=!0)})):this.wdlObject.activations.custom=null,this.exposeWdlObject()}storeAdaptiveCarousel(e){this.wdlObject.activations=this.wdlObject.activations||{},e&&0!==Object.keys(e).length?(this.wdlObject.activations.carousel={},Object.values(e).forEach(e=>{this.wdlObject.activations.carousel[e.name]={name:e.name,guid:e.guid,group:e.testGroup,groupSize:e.testGroupSize,targetReached:e.isPrimaryTarget,targetValue:e.targetValue,secondaryTargetReached:e.isSecondaryTarget,secondaryTargetValue:e.secondaryTargetValue,isViewed:e.isViewed||0,isReordered:e.isReordered||0,isClicked:e.isClicked||0,clickedItemIdx:0>e.clickedItemIdx?null:e.clickedItemIdx,clickedItemType:e.clickedItemType||"",clickedItemTerms:e.clickedItemTerms||null},e.isTest&&(this.wdlObject.activations.carousel[e.name].isLiveQA=!0)})):this.wdlObject.activations.carousel=null,this.exposeWdlObject()}exposeWdlObject(e=!0){!this.wdlObject[ATTRIBUTES_NAME]&&this.wdlObject[OLD_ATTRIBUTES_NAME]&&(this.wdlObject[ATTRIBUTES_NAME]={[WANDZ_ATTRIBUTES_NAME]:this.wdlObject[OLD_ATTRIBUTES_NAME][OLD_WANDZ_ATTRIBUTES_NAME],[CUSTOM_ATTRIBUTES_NAME]:this.wdlObject[OLD_ATTRIBUTES_NAME][OLD_CUSTOM_ATTRIBUTES_NAME]}),this.wdlObject[OLD_ATTRIBUTES_NAME]={[OLD_WANDZ_ATTRIBUTES_NAME]:(this.wdlObject[ATTRIBUTES_NAME]||{})[WANDZ_ATTRIBUTES_NAME],[OLD_CUSTOM_ATTRIBUTES_NAME]:(this.wdlObject[ATTRIBUTES_NAME]||{})[CUSTOM_ATTRIBUTES_NAME]},e&&this.saveObjects();const t=JSON.parse(JSON.stringify(this.wdlObject));t.get=this.getFunction,t.push=this.pushFunction.bind(this),t.sUtils=aiUtils.sUtils,t.testInteractionAppearance=this.testInteractionAppearance.bind(this),t.getDisplayNamesByGuid=this.getDisplayNamesByGuid.bind(this),window[this.wdlLongName]=window[this.wdlShortName]=t}getFunction(e,t=""){try{const r=i.getWithDefault(e,t);return void 0===r.value?r.defaultValue:r.value}catch(i){return void aiLoggerManager.error(i,`WDL.getFunction: Failed to get the ${e} field (${t}).`)}}get(e,t=""){return this.extractFeature(e,t)}getByID(e){const t=this.aiFeatureIdToNameMapping[e];return t?this.extractFeature(t,"aiFeature"):(aiLoggerManager.warn(`Feature with ID [${e}] does not found!`,"WDL.getByID"),null)}getCustomByID(e){let t=this.customAiFeatureIdToNameMapping[e];return t?this.extractFeature(t,"aiFeature"):(t=this.userEventIdToNameMapping[e],t?this.extractFeature(t,"event"):(aiLoggerManager.warn(`Custom AI Feature with ID [${e}] does not found!`,"WDL.getCustomByID"),null))}getDefaultFeatureValueById(e,t){let i=t?this.customAiFeatureIdToNameMapping[e]:this.aiFeatureIdToNameMapping[e];if(i)return t?configurationsGetters.customAiFeatures[i].dv:this.aiFeaturesConfig[i][0];aiLoggerManager.warn(`${t?"Custom ":""}AI Feature with ID [${e}] does not found!`,"WDL.getDefaultFeatureValueById")}set(t,i=!1,r=!1){const n=[];let s=0;return Object.entries(t).forEach(([t,r])=>{let a="",o=this.aiNameToObjMapping[t];o||(a=this.customAiFeatureIdToNameMapping[t]||this.userEventIdToNameMapping[t],a&&(o=this.aiNameToObjMapping[a]));const c=a||t;if(!o)return aiLoggerManager.warn(`[${t}] feature name is not defined!`,"WDL.set"),null;if(o[c]!==r){if((coreUtils.isNullish(r)||"null"===r)&&(r=this.aiFeaturesConfig[c][0]),o[c]===r)return null;const a=i||void 0===o[c],l=this.userEventNameToIdMapping[t]||this.userEventIdToNameMapping[t];if(!a&&coreUtils.isArray(r)){const e=r.filter(e=>-1===o[c].indexOf(e));if(!e.length)return null;o[c]=o[c].concat(e),this.collectedFeatures[t]=e,n.push(`[${t}] extended by ${JSON.stringify(e)}`),notifier.fire(t+"Changed",e)}else l||(this.collectedFeatures[t]=r),o[c]=r,n.push(`[${t}${l?`(event "${c}")`:""}] set to [${r}]`),notifier.fire(t+"Changed",r),l&&t!==c&&notifier.fire(c+"Changed",r);s++,l&&r&&this.userEventIdToNameMapping[t]&&(coreReports.deltaToSend.event_ids||(coreReports.deltaToSend.event_ids=[]),coreReports.deltaToSend.event_ids.push(t),coreReports.deltaToSend.accumulated_events||(coreReports.deltaToSend.accumulated_events={}),coreReports.deltaToSend.accumulated_events[t]=r),this.updateLastUpdated(t),-1===e.indexOf(t)&&(coreReports.shouldSend=!0,a&&!coreReports.cyclesAreActive&&(coreReports.cyclesAreActive=!0))}}),n.length&&(coreReports.shouldSend&&n.filter(t=>{for(let i=0,r=e.length;r>i;i++)if(-1!==t.indexOf(e[i]))return!1;return!0}).length&&aiLoggerManager.info(n.join("\n"),"WDL.set"),this.saveObjects(r),this.exposeWdlObject(!1)),s}saveObjects(e=!1){window.__wandz_wdl_save_disabled||(this.storageManager.setItem(WDLStorageKeys.MAIN_STORAGE,this.wdlObject,e),this.storageManager.setItem(WDLStorageKeys.FEATURE_LAST_UPDATED,this.featureLastUpdated,e),this.storageManager.setItem(WDLStorageKeys.CUSTOM_FEATURE_LAST_UPDATED,this.customFeatureLastUpdated,e))}clear(){this.featureLastUpdated={},this.customFeatureLastUpdated={},this.initBaseWDLSkeleton(),this.initFeatureNameObjectLinks(),this.exposeWdlObject()}needToRecalculate(e,t=!1){for(let i=0,r=e.length;r>i;i++){const r=e[i];if(!this.aiFeaturesConfig[r])continue;const n=this.featureLastUpdated[r],s=this.getFeatureStamp(r);let a=!0;if(n&&"U"===this.aiFeaturesConfig[r][1]&&(+s-+n>this.RECALCULATE_USER_FEATURE||(a=!1)),n!==s){const e=this.aiFeaturesConfig[r][2],i=this.aiFeaturesConfig[r][4],n=this.aiFeaturesConfig[r][0],s=this.get(r,"aiFeature");if(!s||coreUtils.isArray(s)&&!s.length)return!t||void 0===s;if(e){if(!aiUtils.getComparator(i)(s,e,n))return!0}else if(a)return!0}}return!1}needToRecalculateCustom(e){for(let t=0,i=e.length;i>t;t++){const i=e[t],r=configurationsGetters.customAiFeatures[i];if(!r)continue;const n=this.customFeatureLastUpdated[r.id],s=this.getFeatureStamp(r.id+"",r.cf||"C");let a=!0;if(n&&"U"===r.cf&&(+s-+n>this.RECALCULATE_USER_FEATURE||(a=!1)),n!==s){const e=r.sv,t=r.so,n=r.dv,s=this.get(i,"aiFeature");if(!s||coreUtils.isArray(s)&&!s.length)return!0;if(e){if(!aiUtils.getComparator(t)(s,e,n))return!0}else if(a)return!0}}return!1}getCollectedFeatures(){const e={...this.collectedFeatures};return this.collectedFeatures={},e}getCollectedCustomFeatures(){const e={...this.collectedCustomFeatures};return this.collectedCustomFeatures={},e}getBranch(e){return this.extractObjByPath(e)}getTotallyAllFeatures(e=!1){const t={};return Object.keys(this.aiFeaturesConfig).forEach(r=>{let n=i.get(r,"aiFeature");if(coreUtils.isNullish(n)||"null"===n){if(e)return;n=this.aiFeaturesConfig[r][0]}const s=this.userEventNameToIdMapping[r];t[r]=s&&n?+!!n:n}),t}getFeaturesList(e,t=!1){return e.reduce((e,r)=>{const n=i.get(r);if(t&&(coreUtils.isNullish(n)||"null"===n))return e;const s=this.userEventNameToIdMapping[r]||this.userEventIdToNameMapping[r];return e[r]=s&&n?+!!n:n,e},{})}setPredictions(e){const t=[];return e.forEach(e=>{const i=e.modelName,r=e.predictionResult,n=this.predictionsObj[i],s=!n,a=!s&&n.prediction!==r.prediction,o=!s&&n.prediction_score!==r.prediction_score;(s||a||o)&&(this.aiNameToObjMapping[i]||(this.aiNameToObjMapping[i]=this.predictionsObj),this.predictionsObj[i]={...r},(s||a)&&notifier.fire(i+"Changed",r.prediction),t.push(`Prediction [${i}] set to ${JSON.stringify(r)}`))}),t.length&&(coreReports.shouldSend=!0,coreReports.cyclesAreActive||(coreReports.cyclesAreActive=!0),this.exposeWdlObject(),aiLoggerManager.info(t.join("\n"),"WDL.setPredictions")),e}setCustomAiFeatures(e){const t=[];let i=0;return Object.entries(e).forEach(([e,r])=>{if(this.customAiFeaturesObj[e]!==r){if(this.aiNameToObjMapping[e]||(this.aiNameToObjMapping[e]=this.customAiFeaturesObj),(coreUtils.isNullish(r)||"null"===r)&&(r=configurationsGetters.customAiFeatures[e].dv),this.customAiFeaturesObj[e]===r)return null;this.customAiFeaturesObj[e]=r,notifier.fire(e+"Changed",r),t.push(`Custom AI Feature [${e}] set to [${r}]`),i++,this.updateLastUpdatedCustom(e)}}),i&&(coreReports.shouldSend=!0,coreReports.cyclesAreActive||(coreReports.cyclesAreActive=!0),this.exposeWdlObject(),aiLoggerManager.info(t.join("\n"),"WDL.setCustomAiFeatures")),i}setAffinityFeatures(e,t=!1){const i=[];let r=0;return Object.entries(e).forEach(([e,n])=>{t&&(this.customAffinitiesObj[e]=n),this.customAiFeaturesObj[e]!==n&&(this.aiNameToObjMapping[e]||(this.aiNameToObjMapping[e]=this.customAiFeaturesObj),this.customAiFeaturesObj[e]=n,notifier.fire(e+"Changed",n),i.push(`Custom AI Feature [${e}] set to [${n}]`),r++)}),i.length&&(this.exposeWdlObject(),aiLoggerManager.info(i.join("\n"),"WDL.setAffinityFeatures")),r}setShoppingExtensions(e){const t=[],i={};let r=0;const n=this.extractObjByPath(INSTALLS_SHOPPING_FEATURES_PATH);return Object.entries(e).forEach(([e,s])=>{const a=coreUtils.toTitleCase(e);Object.entries(s).forEach(([s,o])=>{n[e][s]!==o&&(n[e][s]=o,notifier.fire(`${s}${a}`,o),t.push(`Extension [${s}] set to [${a} - ${o}]`),r++),o&&(i.engagementWithExtension=1)}),i["numOf"+a]=Object.keys(n[e]).filter(t=>n[e][t]).length}),t.length&&(this.set(i),this.exposeWdlObject(),aiLoggerManager.info(t.join("\n"),"WDL.setShoppingExtensions"),coreReports.cyclesAreActive||(coreReports.cyclesAreActive=!0)),r}setAudiences(e){return this.__setAudiences(e,!1)}setCustomAudiences(e){return this.__setAudiences(e,!0)}__setAudiences(e,t){const i=[];let r=0;const n=this.extractObjByPath(t?CUSTOM_AUDIENCES_PATH:AUDIENCES_PATH);return Object.entries(e).forEach(([e,s])=>{n[e]!==s&&(this.audienceNameToObjMapping[e]||(this.audienceNameToObjMapping[e]=n),n[e]=s,notifier.fire(e+"Changed",s),i.push(`${t?"Custom ":""}Audience [${e}] set to [${s}]`),r++)}),i.length&&(this.exposeWdlObject(),aiLoggerManager.info(i.join("\n"),`WDL.set${t?"Custom":""}Audiences`)),r}setAccumulatedAffinities(e,t){const i=this.extractObjByPath(AFFINITY_PATH);i.accumulatedAffinities=e,i.affinityToColors=t,this.exposeWdlObject(),aiLoggerManager.info(e,"WDL.setAccumulatedAffinities: Affinities"),aiLoggerManager.info(t,"WDL.setAccumulatedAffinities: Colors")}getAccumulatedAffinities(){return this.extractObjByPath(AFFINITY_PATH).accumulatedAffinities||{}}reset(){i.clear(),location.reload()}extractFeature(e,t=""){if(!t)return this.extractFeatureAnyType(e);let i,r,n,s,a;switch(t=t.toLowerCase().trim()){case"model":i=PREDICTIONS_PATH_DOTTED,n=this.modelIdToNameMapping[e];break;case"audience":i=AUDIENCES_PATH_DOTTED,r=CUSTOM_AUDIENCES_PATH_DOTTED,n=this.audienceGuidToNameMapping[e];break;case"aifeature":case"attribute":i=(FeatureNameToPath[e]||[]).join("."),r=CUSTOM_AI_FEATURES_PATH_DOTTED,n=this.customAiFeatureIdToNameMapping[e];break;case"event":i=EVENT_PATH_DOTTED,n=this.userEventIdToNameMapping[e];break;case"affinity":i=AFFINITY_PATH_DOTTED,r=CUSTOM_AFFINITIES_PATH_DOTTED;break;default:return aiLoggerManager.warn(`[${t}] entity type is not defined!`,"WDL.extractFeature"),this.extractFeatureAnyType(e)}try{a=this.pathToObj[i],a&&(s=a[e],void 0===s&&n&&(s=a[n])),void 0===s&&r&&(a=this.pathToObj[r],s=a[e]),void 0===s&&r&&n&&(s=a[n])}catch(i){aiLoggerManager.warn(i,`WDL.extractFeature: Error while extracting [${e}][${t}] feature`)}return s}extractFeatureAnyType(e){let t;try{let i=this.aiNameToObjMapping[e];if(!i){const t=this.customAiFeatureIdToNameMapping[e]||this.userEventIdToNameMapping[e]||this.modelIdToNameMapping[e];t&&(i=this.aiNameToObjMapping[t],i&&(e=t))}if(i||(i=this.audienceNameToObjMapping[e],!i&&this.audienceGuidToNameMapping[e]&&(i=this.audienceNameToObjMapping[this.audienceGuidToNameMapping[e]],i&&(e=this.audienceGuidToNameMapping[e]))),!i)return aiLoggerManager.warn(`[${e}] feature path is not defined!`,"WDL.extractFeature"),null;t=i[e]}catch(e){}return t}extractObjByPath(e){let t=this.wdlObject;try{for(let i=0,r=e.length;r>i;i++){const r=e[i];t[r]||(t[r]={}),t=t[r]}}catch(t){aiLoggerManager.error(`Unable extract path ${e} - some branch does not defined in the Skeleton!`,"WDL.extractObjByPath")}return t}getFeatureStamp(e,t=""){let i;const r=this.aiFeaturesConfig[e];switch(r&&r[1]||t||"C"){case"S":i=this.stamps.S;break;case"P":case"U":i=this.stamps.P;break;default:i=`${this.stamps.P}|${this.stamps.C}`}return i}updateLastUpdated(e){this.featureLastUpdated[e]=this.getFeatureStamp(e)}updateLastUpdatedCustom(e){const t=this.customAiFeatureNameToIdMapping[e],i=configurationsGetters.customAiFeatures[e].cf||"C";this.customFeatureLastUpdated[t]=this.getFeatureStamp(t+"",i)}initFeatureNameObjectLinks(){this.aiNameToObjMapping={},this.aiNameToPathMapping={},this.aiFeatureIdToNameMapping={},this.aiFeatureNameToIdMapping={},this.userEventIdToNameMapping={},this.userEventNameToIdMapping={},this.audienceGuidToNameMapping={},this.audienceNameToObjMapping={},this.pathToObj={};const e=session.sessionWasExpired;e&&aiLoggerManager.warn("Session was expired - clearing session-based features, custom features and shopping extensions.","WDL Init");const i=(e,t,i=!1,r)=>{this.aiNameToObjMapping[e]=this.pathToObj[t],this.aiNameToPathMapping[e]=t,(i||coreUtils.isUndefined(this.pathToObj[t][e]))&&(this.pathToObj[t][e]=r)};Object.keys(this.aiFeaturesConfig).forEach(r=>{this.aiFeatureIdToNameMapping[this.aiFeaturesConfig[r][3]]=r,this.aiFeatureNameToIdMapping[r]=this.aiFeaturesConfig[r][3];let n=FeatureNameToPath[r];if(!n&&r.startsWith("affinityTo")&&(n=AFFINITY_PATH),!n)return void aiLoggerManager.error(`Feature "${r}" has no path!`,"WDL Init");const s=n.join(".");this.pathToObj[s]||(this.pathToObj[s]=this.extractObjByPath(n));let a=t.indexOf(r)>=0;const o=e&&"S"===this.aiFeaturesConfig[r][1];i(r,s,a||o)}),this.pathToObj[EVENT_PATH_DOTTED]||(this.pathToObj[EVENT_PATH_DOTTED]=this.extractObjByPath(EVENT_PATH));const r=configurationsGetters.params.defaultPersistenceEvent||"S";Object.entries(configurationsGetters.userEvents).forEach(([t,n])=>{let s;switch(this.userEventIdToNameMapping[n.id]=t,this.userEventNameToIdMapping[t]=n.id,n.dp||r){case"C":case"P":s=!0;break;case"S":s=e;break;default:s=!1}i(t,EVENT_PATH_DOTTED,s,0)}),this.pathToObj[AUDIENCES_PATH_DOTTED]||(this.pathToObj[AUDIENCES_PATH_DOTTED]=this.extractObjByPath(AUDIENCES_PATH)),Object.entries(configurationsGetters.audiences||{}).forEach(([e,t])=>{this.audienceNameToObjMapping[e]=this.pathToObj[AUDIENCES_PATH_DOTTED],this.audienceGuidToNameMapping[t.guid]=e}),this.pathToObj[CUSTOM_AUDIENCES_PATH_DOTTED]||(this.pathToObj[CUSTOM_AUDIENCES_PATH_DOTTED]=this.extractObjByPath(CUSTOM_AUDIENCES_PATH)),Object.entries(configurationsGetters.customAudiences||{}).forEach(([e,t])=>{this.audienceNameToObjMapping[e]=this.pathToObj[CUSTOM_AUDIENCES_PATH_DOTTED],this.audienceGuidToNameMapping[t.guid]=e}),this.__initPredictions(),this.__initCustomAiFeatures(e),this.__initCustomAffinities(),this.__initShoppingExtensionsBranch(e)}__initPredictions(){const e=this.pathToObj[PREDICTIONS_PATH_DOTTED]=this.extractObjByPath(PREDICTIONS_PATH);Object.keys(e).forEach(t=>delete e[t]),this.predictionsObj=e,this.modelIdToNameMapping=(configurationsGetters.configurations.models||[]).reduce((t,i)=>(t[i.guid]=i.n,this.aiNameToObjMapping[i.n]=e,t),{})}__initCustomAiFeatures(e=!1){this.customAiFeatureIdToNameMapping={},this.customAiFeatureNameToIdMapping={};const t={},i=this.pathToObj[CUSTOM_AI_FEATURES_PATH_DOTTED]=this.extractObjByPath(CUSTOM_AI_FEATURES_PATH);Object.entries(configurationsGetters.customAiFeatures).forEach(([r,n])=>{let s;switch(this.customAiFeatureIdToNameMapping[n.id]=r,this.customAiFeatureNameToIdMapping[r]=n.id,this.aiNameToObjMapping[r]=i,"U"===n.cf&&(t[r]=1),n.dp||"S"){case"C":case"P":s=!1;break;case"S":s=!e;break;default:s=!0}s&&(t[r]=1)}),Object.keys(i).forEach(e=>!t[e]&&delete i[e]),this.customAiFeaturesObj=i}__initCustomAffinities(){const e=this.pathToObj[CUSTOM_AFFINITIES_PATH_DOTTED]=this.extractObjByPath(CUSTOM_AFFINITIES_PATH);this.customAffinitiesObj=e,Object.keys(e).forEach(t=>delete e[t])}__initShoppingExtensionsBranch(e){const t=this.extractObjByPath(INSTALLS_SHOPPING_FEATURES_PATH);e&&(t.installed=t.installed||{},t.interacted={},t.popped={},t.numOfInteracted=0,t.numOfPopped=0)}pushFunction(e){return this.__pushFunction(e)}push(e){return this.__pushFunction(e)}__pushFunction(e,t=!0){if("register"===e.action){let i,r,n;for(const t of["aiFeature","attribute","modelName","audience","affinity","event"])if(e.params[t]){i=e.params[t],r="modelName"===t?"model":t;break}if(!i)return;return t&&(n=this.getWithDefault(i,r)),void activations.add(i,e.params.callback,n,t)}if("inner-event-binding"===e.action){const t=e.params.event,r=e.params.callback,n=e.params.needInitRun;if(t&&r){const e={dal:dal,utils:coreUtils,aiUtils:aiUtils,sUtils:aiUtils.sUtils,wdl:i,conf:configurationsGetters,fire:notifier.fire.bind(notifier),calculationsCycle:calculationsCycle};notifier.bind(t,r.bind(e)),n&&r.apply(e)}}}getWithDefault(e,t=""){let i=this.get(e,t);return i&&this.predictionsObj[e]&&(i=this.predictionsObj[e].prediction),{value:i,defaultValue:this.getDefaultValue(e,t)}}getDefaultValue(e,t=""){return this.aiFeaturesConfig[e]?this.aiFeaturesConfig[e][0]:configurationsGetters.customAiFeatures[e]?configurationsGetters.customAiFeatures[e].dv:void 0}loadActivations(){coreUtils.isArray(window[this.wdlShortName])&&(aiLoggerManager.warn(`WDL is an Array - try to load [${window[this.wdlShortName].length}] activations...`,"WDL.loadActivations"),window[this.wdlShortName].forEach(e=>this.__pushFunction(e,!1)),aiLoggerManager.info("Activations loading completed","WDL.loadActivations"))}testInteractionAppearance(e){notifier.fire("testInteractionAppearance",e)}calculateSortedAffinities(e){let t={byCommon:{categories:[],brands:[],colors:[],custom:[],keywords:{English:[]}},byRecency:{categories:[],brands:[],colors:[],custom:[],keywords:{English:[]}}};const r=e=>Object.keys(e).sort((t,i)=>{let r=e[i]-e[t];return r||(r=t.localeCompare(i)),r}),n=(e,t,i=!0,n=null)=>{const s={};Object.keys(e).forEach(t=>{const r=i?t.replace("accumulatedAffinityTo",""):t;if(n){const i=aiUtils.onlyLetters(r.toLowerCase());if(n[i])return void(s[n[i]]=e[t])}s[r.toLowerCase()]=e[t]}),t.push(...r(s))},s=(e,t)=>{const i={};Object.keys(e).forEach(t=>{const r=configurationsGetters.getKeywordLanguage(t)||"English";i[r]=i[r]||{},i[r][t]=e[t]}),Object.keys(i).forEach(e=>{t[e]=r(i[e])})},a=i.getAccumulatedAffinities();n(a.accumulatedAffinityToCategories,t.byCommon.categories,!0,brandAndCategoryAffinity.cleanedCategoryMap),n(a.accumulatedAffinityToBrands,t.byCommon.brands,!0,brandAndCategoryAffinity.cleanedBrandMap),n(a.accumulatedAffinityToColors,t.byCommon.colors,!0),n(a.accumulatedCustomAffinity,t.byCommon.custom,!0,customAffinity.cleanNameMap),s(a.accumulatedKeywords,t.byCommon.keywords);const o=dal.session.getOne("colorPreferencesFrequencies")||{},c=dal.session.getOne("affinityTimestamps")||{affinityToBrands:{},affinityToCategories:{}},l=dal.session.getOne("customAffinityTimestamps")||{},d={},u={};Object.keys(c.affinityToCategories).forEach(e=>{const t=c.affinityToCategories[e],[i,r]=e.split("||");u[i]=t,t>(d[r]||0)&&(d[r]=t)});const g={};if(Object.keys(l).forEach(e=>{const t=e.split("||")[0];g[t]=l[e]}),n(d,t.byRecency.categories,!1,brandAndCategoryAffinity.cleanedCategoryMap),n(c.affinityToBrands,t.byRecency.brands,!1,brandAndCategoryAffinity.cleanedBrandMap),n(o,t.byRecency.colors,!1),n(g,t.byRecency.custom,!1,customAffinity.cleanNameMap),s(u,t.byRecency.keywords),e)try{e(t)}catch(e){aiLoggerManager.error(e,"WDL.calculateSortedAffinities: Error in callback")}return this.extractObjByPath(AFFINITY_PATH).sorted=t,this.exposeWdlObject(),aiLoggerManager.info(t,"WDL.calculateSortedAffinities"),t}getChangedAudiences(){return audienceDetector.getChangedAudiences.apply(audienceDetector)}getDisplayNamesByGuid(e,t){const i={};return coreUtils.isArray(e)||(e=[e]),e.forEach(e=>{i[e]=e}),"audience"===t?[configurationsGetters.audiences,configurationsGetters.customAudiences].forEach(e=>{Object.entries(e).forEach(([e,t])=>{i[t.guid]&&(i[t.guid]=t.dn||e),i[e]&&(i[e]=t.dn||e)})}):aiLoggerManager.warn(`Entity type [${t}] is not supported in getDisplayNamesByGuid`,"WDL.getDisplayNamesByGuid"),i}};return i})(),aiUtils=(()=>{let e=null;const t=e=>!e||!e.length||1===e.length&&"all"===e[0].toLowerCase(),i=(e,t)=>e.map(e=>e.toLowerCase()).includes((t+"").toLowerCase()),r=(e,t="")=>{for(let i=0,r=e.length;r>i;i++)if(wdl.get(e[i],t))return!0;return!1},n=e=>{try{return e.outerHTML}catch(t){try{return aiLoggerManager.info(e,"getOuterHtml: Unable to perform default method! "+t),(new XMLSerializer).serializeToString(e)}catch(e){aiLoggerManager.error(e,"getOuterHtml: Unable to perform!")}}return""},s=e=>{if(!e)return"";const t={ox:"oxen",child:"children",man:"men",woman:"women",tooth:"teeth",foot:"feet",mouse:"mice",goose:"geese"};if(t[e])return t[e];const i=e.length;if(3>i)return e+"s";const r=e.slice(-2),n=e[i-1];let s=e;return s=["ss","sh","ch"].includes(r)||["x","z"].includes(n)?e+"es":"y"!==n||"aeiou".includes(e[i-2])?"o"!==n||"aeiou".includes(e[i-2])?e+"s":e+"es":e.slice(0,-1)+"ies",s},a=e=>{if(!e)return"";const t=e.length;if(4>t)return e;const i=["shoes","beanies","brownies","cookies","movies","nighties","sweeties"];if(i.includes(e)||i.some(t=>e.endsWith(t)))return e.slice(0,-1);if(e.endsWith("ss"))return e;const r=["clothes","scissors","pants","jeans","shorts","mas","news","darts","billiards"];if(r.includes(e)||r.some(t=>e.endsWith(t)))return e;const n=e[t-1],s=e.slice(-2);if("ies"===e.slice(-3))return e.slice(0,-3)+"y";if("es"===s){const i=e[t-3],r=e[t-4];return!["s","x","z","h"].includes(i)||"s"===i&&"aeiou".includes(r)?e.endsWith("oes")?e.slice(0,-2):e.slice(0,-1):e.slice(0,-2)}return"s"===n?e.slice(0,-1):e},o=e=>{if(!e||!e.length)return e;const t={};return e.reduce((e,i)=>(!(i=i.trim().toLowerCase())||t[i]||t[a(i)]||t[s(i)]||e.push(i),t[i]=1,e),[])};let c,l=[],d="",u="",g="",h=0;const f={waitAndPerform(e,t,i){if(void 0===t&&(t=30),void 0===i&&(i=300),t>0){for(let t=0,i=e.length;i>t;t++){const i=e[t],r=i.lookup();if(r&&r.length)return i.callback(r)}return t--,window.setTimeout(f.waitAndPerform,i,e,t,i)}},collectAffinities(e,t,i="English",r=null){t=t||{},Object.keys(r=r||{}).length&&Object.keys(r).forEach(e=>{r[e.toLowerCase()]=r[e]});const n=void 0===t.b||t.b;let o=void 0===t.c||t.c;const c=void 0===t.k||t.k;let l=void 0===t.col||t.col;const d="English"===i;d||(o=!1,l&&(l=!!Object.keys(r).length));const u=wdl.getBranch(["affinity"]);if(!u)return[];const g=(()=>{if(c)return dal.session.getOne("affinityCategoryKeywords")})()||{},h={};if(Object.keys(u).forEach(e=>{const t=u[e];t&&(l&&e.startsWith("affinityInteractionsWith")?h[e.replace("affinityInteractionsWith","").toLowerCase()]=1:"affinityToBrands"===e&&n&&t.length?t.forEach(e=>h[e.toLowerCase()]=1):"affinityToCategories"===e&&o&&t.length&&t.forEach(e=>h[e.toLowerCase()]=1))}),Object.keys(g).forEach(e=>{const t=g[e];e.includes("||")&&(e=e.split("||")[0]),h[s(e)]||h[a(e)]||(!d&&h[t]&&configurationsGetters.isNotLanguageKeyword(e,i)&&delete h[t],c&&(h[e]=1))}),!d&&l&&Object.keys(h).forEach(e=>{const t=r[e];t&&(h[t]=1,delete h[e])}),Object.keys(h).forEach(e=>{configurationsGetters.isNotLanguageKeyword(e,i)&&delete h[e]}),!Object.keys(h).length)return[];const f=Object.keys(h).sort();return e?f.slice(0,e):f},getAffinityTimestamps(){const e={},t=dal.session.getOne("colorPreferencesFrequencies")||{},i=dal.session.getOne("affinityTimestamps")||{affinityToBrands:{},affinityToCategories:{}},r=(t,i)=>{i>(e[t]||0)&&(e[t]=i)};return Object.keys(t).forEach(i=>e[i.toLowerCase()]=t[i]),Object.keys(i.affinityToBrands||{}).forEach(t=>{e[t.toLowerCase()]=i.affinityToBrands[t]}),Object.keys(i.affinityToCategories||{}).forEach(e=>{const t=i.affinityToCategories[e],n=e.toLowerCase().split("||");r(n[0],t),r(n[1],t)}),e},getSuggestions(e,t,i,r,n,s=5){let a=f.collectAffinities(100,{c:i,b:t,k:r,col:n});return a&&a.length?(e&&(e=e.toLowerCase(),a=a.filter(t=>t.includes(e))),a.length?(a.length>s&&(a=coreUtils.getRandomElements(a,s)),a):[]):[]},generateItems(e,t,i=!1,r="search_type",n="&",s=null){n=n||"&";const a=i?`${n}${r}=adaptive`:"";let o=0;return e.map(e=>{o++;const i=encodeURIComponent(e)+a,r=t.replaceAll("{{keyword}}",e).replaceAll("{{keywordUri}}",i).replaceAll("{{counter}}",o.toString());if(s)try{return s(r,e,i,o)}catch(t){return aiLoggerManager.error(t,`generateItems: Postprocessor failed for keyword "${e}"!`),r}return r}).join("")},debounce(e,t,...i){h&&window.clearTimeout(h),h=window.setTimeout(e,t,...i)},addTopAffinities(e,t,i=5,r="recent",n=null,s=null){if(t=t||[],!e||!e.length){const e=o(s?[...s,...t]:t).slice(0,i);return n?e.map(n):e}let a=!1;if("recent"===r){const t=f.getAffinityTimestamps();t&&Object.keys(t).length&&(a=!0,e=e.sort((e,i)=>(t[i]||0)-(t[e]||0)))}else if("common"===r){const t=wdl.getAccumulatedAffinities();if(t&&Object.keys(t).length){const i={};Object.keys(t).forEach(e=>{const r=t[e]||{},n="accumulatedKeywords"!==e;Object.keys(r).forEach(e=>{const t=n?coreUtils.featureToAffinityName(e.replace("accumulatedAffinityTo","")):e;i[t]=r[e]})}),Object.keys(i).length&&(a=!0,e=e.sort((e,t)=>(i[t]||0)-(i[e]||0)))}}if(!a){const i=t.reduce((e,t,i)=>(e[t]=e[t+"s"]=e[t+"es"]=i+1,e),{});e=e.sort((e,t)=>{const r=i[e],n=i[t];return r&&!n?-1:!r&&n?1:r&&n?r-n:e.localeCompare(t)})}if(n)try{e=e.map(n),t=t.map(n)}catch(e){aiLoggerManager.error(n,`addTopAffinities: Keyword preprocessor failed! ${e}\n`)}return e.length<i&&(e=coreUtils.uniqueArray([...e,...t])),o(s?[...s,...e]:e).slice(0,i)},storeSuggestions(e){l=e,0===coreReports.cycle||coreReports.cyclesAreActive||(coreReports.cyclesAreActive=!0)},storeClicked(e){d=e,0!==coreReports.cycle&&coreReports.updateStack(!0)},storeGroup(e,t,i){u=e,t&&(g=t),void 0!==i&&(c=+i),e||(c=void 0)},getSuggestionsStateToSend(){const e={suggestionsShown:[...l],clickedSuggestionTerm:d,adaptiveSearchGroup:u,adaptiveSearchId:g,adaptive_search_is_live_qa:c};return l=[],d="",e},extractBrands(e){if(!e)return[];const t=e.length;if(t>AFFINITY_MAX_SIZE_STRING_CHECKING||2>t)return aiLoggerManager.warn(t,"sUtils.extractBrands - skip to check - the length is"),[];const i=p(e),r={};return i.forEach(e=>{const t=brandAndCategoryAffinity.affinities.affinityToBrands[e]||brandAndCategoryAffinity.cleanedBrandMap[w(e)];t&&!brandAndCategoryAffinity.isExcludedKeyword(t,e)&&(r[t]=1)}),Object.keys(r)},extractCategories(e){if(!e)return[];const t=e.length;if(t>AFFINITY_MAX_SIZE_STRING_CHECKING||2>t)return aiLoggerManager.warn(t,"sUtils.extractCategories - skip to check - the length is"),[];const i=p(e),r={};return i.forEach(e=>{const t=brandAndCategoryAffinity.affinities.affinityToClientCategories[e];t&&!brandAndCategoryAffinity.isExcludedKeyword(t,e)&&(r[t]=1)}),Object.keys(r).length||i.forEach(e=>{const t=brandAndCategoryAffinity.affinities.affinityToRegularCategories[e];t&&!brandAndCategoryAffinity.isExcludedKeyword(t,e)&&(r[t]=1)}),Object.keys(r)},extractKeywords(e){if(!e)return[];const t=e.length;if(t>AFFINITY_MAX_SIZE_STRING_CHECKING||2>t)return aiLoggerManager.warn(t,"sUtils.extractKeywords - skip to check - the length is"),[];const i=p(e),r={};return i.forEach(e=>{const t=brandAndCategoryAffinity.affinities.affinityToClientCategories[e];t&&!brandAndCategoryAffinity.isExcludedKeyword(t,e)&&(r[e]=1)}),Object.keys(r).length||i.forEach(e=>{const t=brandAndCategoryAffinity.affinities.affinityToRegularCategories[e];t&&!brandAndCategoryAffinity.isExcludedKeyword(t,e)&&(r[e]=1)}),Object.keys(r)},extractColors:e=>e?colorsFromText(e):[],getCategoryKeywords(e,t=null){if(!e)return[];let i=brandAndCategoryAffinity.categoryKeywords[e]||brandAndCategoryAffinity.categoryKeywords[w(e.toLowerCase())]||[];return t&&(i=i.filter(e=>configurationsGetters.getKeywordLanguage(e)===t)),i},extractCustomAffinities(e){if(!e)return[];const t=e.length;if(t>AFFINITY_MAX_SIZE_STRING_CHECKING||2>t)return aiLoggerManager.warn(t,"sUtils.extractCustomAffinities - skip to check - the length is"),[];const i=p(e),r={};return i.forEach(e=>{const t=(customAffinity.displayNameMapping[e]||{}).displayName||customAffinity.cleanNameMap[w(e)];t&&(r[t]=1)}),Object.keys(r)},sortElements(e,t,i,r,n=!0,s=!1){const a=[t];return s&&a.push("custom"),f.sortElementsByFewTypes(e,a,i,r,n?"recent":"common")},sortElementsByFewTypes(e,t,i,r,n="recent"){let s=!1;const a=r.reduce((e,t,i,r)=>(e[t.toLowerCase()]=r.length-i,e),{}),o={};t.forEach(e=>{o[e]={extractedValueKey:"__affinityExtracted_"+e,wasExtractedKey:"__affinityWasExtracted_"+e,extractor:{brand:f.extractBrands,category:f.extractCategories,keyword:f.extractKeywords,color:f.extractColors,custom:f.extractCustomAffinities}[e]}});let c={};const l=(e,t)=>{c[e]&&c[e]>=t||(c[e]=t)};if("recent"===n){if(o.custom){const e=dal.session.getOne("customAffinityTimestamps")||{};Object.entries(e).forEach(([e,t])=>{const i=e.split("||")[1],r=customAffinity.idToDisplayNameMapping[i];l(r.toLowerCase(),t)})}if(o.brand||o.category||o.keyword){const e=dal.session.getOne("affinityTimestamps")||{affinityToBrands:{},affinityToCategories:{}};if(["brand","category"].forEach(t=>{if(o[t]){const i=e["brand"===t?"affinityToBrands":"affinityToCategories"]||{};Object.entries(i).forEach(([e,t])=>{const i=(e.split("||")[1]||e).toLowerCase();l(i,t)})}}),o.keyword){const t=e.affinityToCategories||{};Object.entries(t).forEach(([e,t])=>{const i=e.split("||")[0].toLowerCase();l(i,t)})}}if(o.color){const e=dal.session.getOne("colorPreferencesFrequencies")||{};Object.entries(e).forEach(([e,t])=>{l(e.toLowerCase(),t)})}}else{const e=wdl.getAccumulatedAffinities();if(e&&Object.keys(e).length){const t=(e,t)=>{const i=coreUtils.featureToAffinityName(e.replace("accumulatedAffinityTo",""));l(i,t)};Object.keys(o).forEach(i=>{Object.entries(e[{brand:"accumulatedAffinityToBrands",category:"accumulatedAffinityToCategories",keyword:"accumulatedKeywords",color:"accumulatedAffinityToColors",custom:"accumulatedCustomAffinity"}[i]]||{}).forEach(([e,i])=>{t(e,i)})})}}return e.sort((e,t)=>{const r={},n={};Object.values(o).forEach(({extractedValueKey:s,wasExtractedKey:a,extractor:o})=>{e[a]||(e[s]=o(i(e).toLowerCase()).map(e=>e.toLowerCase()),e[a]=!0),(e[s]||[]).forEach(e=>r[e]=1),t[a]||(t[s]=o(i(t).toLowerCase()).map(e=>e.toLowerCase()),t[a]=!0),(t[s]||[]).forEach(e=>n[e]=1)});const l=Object.keys(r),d=Object.keys(n);if(!l.length&&!d.length)return 0;const u=Math.max(0,...l.map(e=>c[e]||0)),g=Math.max(0,...l.map(e=>a[e]||0)),h=Math.max(0,...d.map(e=>c[e]||0)),f=Math.max(0,...d.map(e=>a[e]||0));return(u||h||g||f)&&(s=!0),u||h?h-u:g||f?f-g:0}),[s,e]},async simulateTyping(e,t,i=100,r=!1){e.value="",e.dispatchEvent(new InputEvent("input",{bubbles:!0,inputType:"deleteContentBackward",data:null}));for(const r of t)e.dispatchEvent(new KeyboardEvent("keydown",{key:r,bubbles:!0})),e.dispatchEvent(new KeyboardEvent("keypress",{key:r,bubbles:!0})),e.value+=r,e.dispatchEvent(new InputEvent("input",{bubbles:!0,inputType:"insertText",data:r})),e.dispatchEvent(new KeyboardEvent("keyup",{key:r,bubbles:!0})),await new Promise(e=>setTimeout(e,i));e.dispatchEvent(new Event("change",{bubbles:!0})),r&&(e.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",code:"Enter",bubbles:!0})),e.dispatchEvent(new KeyboardEvent("keypress",{key:"Enter",code:"Enter",bubbles:!0})),e.dispatchEvent(new KeyboardEvent("keyup",{key:"Enter",code:"Enter",bubbles:!0})))}},p=e=>{const t={[e]:1},i=/https?:\/\/[^\s]+|\/[^\s]+/g,r=e.match(i)||[],n=e.replace(i,"").trim();r.forEach(e=>m(e,t));const s=n.replace(/\s+-+\s+/g," ").replace(/(!)|(\. )/g," ").trim().split(/\s+/);return y(s,t),Object.keys(t)},m=(e,t)=>{!e.startsWith("http")&&e.startsWith("/")&&(e=`${window.location.origin}${e}`);const i=coreUtils.parseUrl(e);i.pathname.split("/").forEach(e=>{e.length>2&&(e.includes("-")?T(e.split("-"),t):t[e]=1)}),i.search&&Array.from(new URLSearchParams(i.search).values()).forEach(e=>{e.length>2&&(t[e]=1)})},y=(e,t)=>{T(e,t)},T=(e,t)=>{for(let i=0,r=e.length;r>i;i++){const[r,n,s,a,o]=[e[i],e[i+1],e[i+2],e[i+3],e[i+4]];r.length>2&&(t[r]=1),n&&(t[`${r} ${n}`]=1),s&&(t[`${r} ${n} ${s}`]=1),a&&(t[`${r} ${n} ${s} ${a}`]=1),o&&(t[`${r} ${n} ${s} ${a} ${o}`]=1)}},w=e=>e?e.replace(/[^a-zA-Z]/g,"").trim():"";return{calculateScore:(e,t,i)=>{if(null==e)return{};const r={};let n=[];const s=i&&i!==BOT_DEVICE&&Object.values(Devices).includes(i)?i:Devices.PC,a=(configurationsGetters.configurations.aiFeaturesBuckets||{})[t];if(a){let t;return n=a.d[s[0]]||a.d.p,t=n.length?((e,t)=>{for(let i=1;i<e.length;i++)if(t<e[i])return i;return e.length})(n,e):null,null===e&&(t=null),r[a.n]=t,r}return aiLoggerManager.warn(`No bucket for [${t}] found!`,"utils.calculateScore"),{}},getPermissionStatus:async e=>{try{return await navigator.permissions.query({name:e})}catch(e){return{}}},getDeviceSettings:()=>({doNotTrack:"1"===window.doNotTrack||"1"===navigator.doNotTrack,darkMode:window.matchMedia("(prefers-color-scheme: dark)").matches}),getSelfFetchTime:()=>{if(null!==e)return e;if(!window.performance||!performance.getEntries)return null;let t=performance.getEntries().filter(function(e){return e.transferSize>0&&e.responseEnd-e.requestStart>30&&e.responseEnd-e.startTime>30});if(!t||!t.length)return 0;let i=0;for(let e=0;e<t.length;e++){const r=t[e],n=Math.abs(r.responseEnd-r.startTime);i+=Math.round(r.transferSize/n)}return e=Math.round(i/t.length),e},purchaseHasMade:()=>{let e=wdl.storageManager.getItem(WDLStorageKeys.PURCHASE_MADE,!0);return e=e?""+(parseInt(e)+1):"1",wdl.storageManager.setItem(WDLStorageKeys.PURCHASE_MADE,e,!0),{numOfPurchases:parseInt(e)}},secondsDiffFromNow:e=>Math.round((Date.now()-e)/1e3),getScreenAttributes:()=>{const e={},t=window.devicePixelRatio||(window.matchMedia&&window.matchMedia("(min-resolution: 2dppx), (-webkit-min-device-pixel-ratio: 1.5),(-moz-min-device-pixel-ratio: 1.5),(min-device-pixel-ratio: 1.5)").matches?2:1)||1,i=window.screen.width,r=window.screen.height,n=window.matchMedia?window.matchMedia("(orientation: landscape)").matches:window.innerHeight<window.innerWidth;return e.pxWidth=Math.round(i*t),e.pxHeight=Math.round(r*t),e.deviceLayout=n?"landscape":"portrait",e},getLanguage:()=>{let e=navigator.language||navigator.languages&&navigator.languages[0]||"";return e&&/^[a-zA-Z]{2,3}(-[a-zA-Z]{4})?(-[a-zA-Z]{2}|\d{3})?(-[a-zA-Z\d]{5,8})*(-[a-zA-Z\d]{1,8})*$/.test(e)||(aiLoggerManager.warn(e,"getLanguage: Invalid language tag:"),e="en"),e.split("-")[0].toLowerCase()},orBunch:(e,t)=>{for(let i=0,r=e.length;r>i;i++)if(e[i](t))return!0;return!1},andBunch:(e,t)=>{if(!e.length)return!1;for(let i=0,r=e.length;r>i;i++)if(!e[i](t))return!1;return!0},checkForAll:t,checkForIn:i,checkForAnyAiFeature:r,checkForTarget:e=>{const n=wdl.device.toLowerCase(),s=dataCollector.traffic_source,a=s.replaceAll(" ","");let o=t(e.d)||i(e.d,n);return o&&(o=t(e.c)||i(e.c,s)||s!==a&&i(e.c,a)),o&&(o=t(e.a)?t(e.ca)||r(e.ca,"audience"):t(e.ca)?r(e.a,"audience"):r(e.a,"audience")||r(e.ca,"audience")),o},getOuterHtml:n,hasOpenShadowRoot:e=>!(!e.shadowRoot||!e.shadowRoot.children),hasClosedShadowRoot:e=>{if(null===e.shadowRoot)try{(t=e).attachShadow({mode:"open"}).innerHTML="<slot></slot>",1===configurationsGetters.params.revertShadowDomAfterCheck&&(t.outerHTML=n(t))}catch(e){return!0}var t;return!1},wordInText:(e,t)=>t.includes(e)&&RegExp(`(?:^|\\s|\\W|\\b|_)${e}(?:$|\\s|\\W|\\b|_)`).test(t),singularToPlural:s,pluralToSingular:a,removePlurals:o,getPageScrollPercentage:()=>{const e=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,t=document.documentElement.scrollHeight-document.documentElement.clientHeight;return t>0?0===e?0:e/t*100:100},getComparator:e=>{switch(e){case"is":case"equals":case StringComparisonOperators.EXACT_MATCH:return(e,t)=>(e=e&&e.toLowerCase?e.toLowerCase():e)===(t&&t.toLowerCase?t.toLowerCase():t);case"isNot":case"notEquals":return(e,t)=>e!==t;case StringComparisonOperators.STARTS_WITH:return(e,t)=>e&&t&&e.toLowerCase().startsWith(t.toLowerCase());case StringComparisonOperators.ENDS_WITH:return(e,t)=>e&&t&&e.toLowerCase().endsWith(t.toLowerCase());case StringComparisonOperators.CONTAINS:return(e,t)=>e&&t&&e.toLowerCase().includes(t.toLowerCase());case StringComparisonOperators.NOT_CONTAINS:return(e,t)=>!e||e&&t&&!(e+"").toLowerCase().includes(t.toLowerCase());case"greaterThan":return(e,t)=>+e>+t;case"lessThan":return(e,t)=>+t>+e;case"greaterThanOrEqualTo":return(e,t)=>+e>=+t;case"lessThanOrEqualTo":return(e,t)=>+t>=+e;case"inBetween":return(e,t)=>+t[0]<=+e&&+e<=+t[1];case"isIn":return(e,t)=>e&&e.toLowerCase?t.includes(e)||t.includes(e.toLowerCase()):t.includes(e);case"isNotIn":return(e,t)=>!t.includes(e);case StringComparisonOperators.HAS_VALUE:return(e,t,i)=>!!e&&e!==i;case StringComparisonOperators.HAS_NO_VALUE:return(e,t,i)=>!e||e===i;case StringComparisonOperators.REGEX_MATCH:return(e,t)=>RegExp(t,"gi").test(e);case"averageValue":return()=>!1;default:return aiLoggerManager.warn(`[${e}] Comparison rule does not defined!`),()=>!1}},calculateDPR:()=>Math.round(window.outerWidth/window.innerWidth*100)/100,sUtils:f,tokenizeWords:p,tokenizePreparedWords:e=>{const t={[e]:1};return y(e.split(" "),t),Object.keys(t)},onlyLetters:w,onlyLettersAndSpace:e=>e?e.replace(/[^a-zA-Z\s]/g,"").trim():""}})(),hookWriter=new class{constructor(){this.ready=!1,this.notAllowedTestModeMessages={},this.notAllowedTargetMessages={}}init(e){this.resetLocals(),this.storageManager=storageManagers.getStorageManager();const t=configurationsGetters.mappedDomain,i=configurationsGetters.domain;this.hookWriterConf=[],t&&t!==i&&e[t]&&e[t].length&&(this.hookWriterConf=e[t]),e[i]&&e[i].length&&(this.hookWriterConf=[...this.hookWriterConf,...e[i]]),e._&&e._.length&&(this.hookWriterConf=[...this.hookWriterConf,...e._]),this.setHooksListeners(),this.ready=!0}resetLocals(){this.hookWriterConf=null,this.ready=!1,this.notAllowedTestModeMessages={},this.notAllowedTargetMessages={}}isReady(){return this.ready}setHooksListeners(){this.hookWriterConf&&this.hookWriterConf.length&&this.setListeners(this.hookWriterConf)}setListeners(e){const t={dal:dal,utils:coreUtils,aiUtils:aiUtils,sUtils:aiUtils.sUtils,wdl:wdl,conf:configurationsGetters,fire:notifier.fire.bind(notifier),calculationsCycle:calculationsCycle},i=liveQA.isTestingMode,r=liveQA.forceShow;let n=liveQA.guid;n&&(e.some(e=>e.id===n)?coreLoggerManager.info("Force GUID is set to "+n,"HookWriter"):n=""),e.forEach(e=>{const s=e.write_to,a=e.write_value&&configurationsGetters.getCode(e.write_value)||"";let o;if(a)try{o=Function("context","...args",`const {dal,utils,aiUtils,sUtils,wdl,conf,fire,calculationsCycle}=context;return (${a})(...args);`)}catch(t){coreLoggerManager.error(t,`HookWriter (${e.write_value}): ${a}`)}else o=null;const c=e.write_as,l=(...l)=>{(()=>{if((n!==e.id||!r)&&e.is_test){if(!i)return void(this.notAllowedTestModeMessages[e.id]||(this.notAllowedTestModeMessages[e.id]=!0,coreLoggerManager.info("Test mode is off\n"+(a||"!!! no code !!!").slice(0,100),"HookWriter")));coreLoggerManager.info("Test mode is on\n"+(a||"!!! no code !!!").slice(0,100),"HookWriter")}if(e.t){if(!(n===e.id&&r||aiUtils.checkForTarget(e.t)))return void(this.notAllowedTargetMessages[e.id]||(this.notAllowedTargetMessages[e.id]=!0,coreLoggerManager.info(`Targeting failed for hook writer ${e.id}\n${(a||"!!! no code !!!").slice(0,100)}`,"HookWriter")));coreLoggerManager.info(`Targeting passed for hook writer ${e.id}\n${(a||"!!! no code !!!").slice(0,100)}`,"HookWriter")}switch(s){case"cookie":document.cookie=`${c}=${o?o(t,...l):l}; path=/`;break;case"localStorage":window.localStorage.setItem(c,o?o(t,...l):l);break;case"sessionStorage":window.sessionStorage.setItem(c,o?o(t,...l):l);break;case"memory":case"window":window[c]=o?o(t,...l):l;break;case"exec":case"jsExpression":o&&o(t,...l)}})()},d=(...t)=>{try{l(...t)}catch(t){coreLoggerManager.error(t,`HookWriter Runtime (${e.write_value}): ${a}`)}};notifier.retroBind(e.write_event,d),e.write_event_extra&&e.write_event_extra.length&&e.write_event_extra.forEach(t=>{t!==e.write_event&&notifier.retroBind(t,d)})})}},performanceMeasurer=(()=>{const e=window.performance&&performance.now?()=>performance.now():()=>Date.now(),t=new class{isActive=!1;init(){this.methods={},this.dataToSend={},this.isActive=!0,notifier.bind("session-ready",()=>{const e=dal.session.getOne("performanceTimingEnable");coreUtils.isUndefined(e)||(t.isActive=!!e)})}start(t){this.isActive&&(this.methods[t]||(this.methods[t]={calls:0,time:0}),this.methods[t].startTime=e())}end(t){this.isActive&&(this.methods[t].time+=e()-this.methods[t].startTime,this.methods[t].calls++,this.dataToSend[t]=this.methods[t].time)}getDataToSend(){const e={};return Object.entries(this.dataToSend).forEach(([t,i])=>{e[t]=Math.round(1e3*i)/1e3||0}),this.dataToSend={},e}};return t})(),dataCollector=new class{constructor(){this.config={},this.commonReportFields=null,this.ready=!1,this.traffic_source="",this._dateTimeFormat=null}init(e){this.resetLocals(),this.config=e,this.traffic_source="",this.ready=!0}resetLocals(){this.config={},this.commonReportFields=null,this.ready=!1}isReady(){return this.ready}calculateJsChannel(){let e;const t=[this.getChannelByBrowser,this.getChannelByUtm,this.getChannelByReferrer];for(let i=0,r=t.length;r>i;i++){const r=t[i];try{if(e=r.apply(this),e){e=e.slice(0,89);break}}catch(e){break}}return coreUtils.normalizeJsChannel(e||"Direct")}getChannel(){const e=dal.session.getOne("traffic_source");if(e)return e;const t=this.calculateJsChannel();return dal.session.set({traffic_source:t}),dataCollector.traffic_source=t,t}getEachCycleData(e){const t=dal.session.get(),i={};if(t.performanceTimingEnable){const e=performanceMeasurer.getDataToSend();Object.keys(e).length&&(i.js_perf=e)}return{client_tag:this.config.tag,domain:configurationsGetters.mappedDomain||configurationsGetters.domain,user_id:t.user_id,session_id:t.session_id,page_cb:t.pvst,page_cb_timestamp:coreUtils.timestampToUtc(t.pvst),cycle:e.cycle,cycle_timestamp:coreUtils.timestampToUtc(e.cycleTimestamp),etag_user_id:t.etag_user_id||"",etag_session_id:t.etag_session_id||"",pv:t.pv,...i}}getEachSessionData(){let e=coreUtils.getDevice(),t=this.traffic_source||dal.session.getOne("traffic_source")||"",i=dal.session.getOne("app_referrer")||"",r=wdl.get("inAppBrowsingPackage","aiFeature")||"";if(r&&!i){const e=(configurationsGetters.configurations.appMapping||{})[r];e?(i=e.r,t=e.t,dal.session.set({traffic_source:t,app_referrer:i}),this.traffic_source=t):(coreLoggerManager.warn(`inAppBrowsingPackage [${r}] has no mapping!`,"DataCollector"),i=r,dal.session.set({app_referrer:r}))}return wdl.set({channel:t}),{os:coreUtils.getOS(),device:coreUtils.getDeviceName()||e,device_type:e,browser:coreUtils.getBrowser(),user_agent:navigator.userAgent.slice(0,1024),referrer:wdl.get("referrer","aiFeature")||coreUtils.getDomainFromUrl(document.referrer||""),app_referrer:i,traffic_source:t,affiliate:this.calculateJsChannel(),...configurationsGetters.versions}}getEachPageData(){let e={};dal.session.getOne("performanceTimingEnable")&&(e={load_time:wdl.get("pageLoadValue","aiFeature"),dom_interactive:wdl.get("domInteractive","aiFeature"),dom_contentloaded:wdl.get("domContentLoadedTime","aiFeature"),dom_complete:Math.max(performance.timing.domComplete-performance.timing.domContentLoadedEventEnd,-1),on_load:Math.max(performance.timing.loadEventEnd-performance.timing.loadEventStart,-1)});const t={};Object.entries(wdl.getBranch(EVENT_PATH)).forEach(([e,i])=>{i&&wdl.userEventNameToIdMapping[e]&&(t.accumulated_events||(t.accumulated_events={}),t.event_ids||(t.event_ids=[]),t.accumulated_events[wdl.userEventNameToIdMapping[e]]=i,t.event_ids.push(wdl.userEventNameToIdMapping[e]))});const i={section:wdl.get("pageType","aiFeature"),category:wdl.get("pageCategory","aiFeature")||"Unknown",page_title:(document.title||"").slice(0,2e3)};return i.section===SiteSections.orderConfirmation&&(i.is_conversion=1),wdl.set({pageTitle:i.page_title||null}),{href:decodeURI(window.location.href).slice(0,4e3),ai_features:wdl.getTotallyAllFeatures(),...i,...e,...t,...interactions.getActiveInteractionData()}}getMMCChannelName(e){if(!e)return null;let t="Unspecified MMC";if(0>e.indexOf("email")){const i=e.split("-_-");if(i.length>1){let e=!1;const r=("cpc"===i[0]||"affiliate"===i[0]?i[1]:i[0])||"",n=this.config.refUrlParams||[];for(let i=0,s=n.length;s>i;i++){const s=n[i];if(s.v===r.toLowerCase()){t=s.d,e=!0;break}}e||(t=coreUtils.beautifyChannel(r))}}else t=Channels.EMAIL;return t}getChannelByBrowser(){const e=navigator.userAgent.toLowerCase();for(let t=0,i=browsers.length;i>t;t++){const i=browsers[t];if(i.values.some(t=>e.includes(t)))return i.displayName}}getChannelByUtm(){const e=coreUtils.getQueryParamsAsObject();if(e){const t=this.config.refUrlParams||[];for(let i=0,r=t.length;r>i;i++){const r=t[i];if(e.hasOwnProperty(r.k)&&(!r.v||this.isUrlParam((e[r.k]||"").toLowerCase(),(r.v||"").toLowerCase())))return r.d}let i=e.utm_source;return["utm_source","utm_medium"].some(t=>e.hasOwnProperty(t))&&(i="b2b"===e.utm_source&&e.partner?e.partner:e.utm_source),i?coreUtils.getUTMChannelName(i):this.getMMCChannelName(e.cm_mmc||e.cm_sp)}return null}isUrlParam(e,t){if(!e)return!1;const i=t.indexOf("*");if(-1===i)return e===t;if(0===i)return e.endsWith(t.replace("*",""));if(i===t.length-1)return e.startsWith(t.replace("*",""));const r=t.split("*");return e.startsWith(r[0])&&e.endsWith(r[1])}getChannelByReferrer(){const e=document.referrer&&coreUtils.parseUrl(document.referrer);if(!e)return null;const t=coreUtils.extractDomain(e.hostname);if(!t)return null;if(window.location.hostname.indexOf(t)>=0)return"Direct";if(this.config.refTrans){let i=this.config.refTrans[t];if(!i){const t=Object.keys(this.config.refTrans).sort((e,t)=>t.length-e.length);for(let r=0,n=t.length;n>r;r++){const n=t[r];if(-1!==e.hostname.indexOf(n)){i=this.config.refTrans[n];break}}}if(i)return i}return coreUtils.beautifyChannel(t)}get dateTimeFormat(){if(!this._dateTimeFormat)try{this._dateTimeFormat=Intl.DateTimeFormat().resolvedOptions()}catch(e){this._dateTimeFormat=null}return this._dateTimeFormat}getAffinitiesToSend(){return brandAndCategoryAffinity.getAffinitiesToSend()}getCustomAffinitiesToSend(){return customAffinity.getAffinitiesToSend()}getDetectedColors(){return getDetectedColors()}getInteractionsChanges(){return interactions.getChanges()}getCollectedFeatures(){return wdl.getCollectedFeatures()}getCollectedCustomFeatures(){return{...customAiFeatures.getCollectedFeatures(),...wdl.getCollectedCustomFeatures()}}getAudiencesToSend(){return audienceDetector.getAudiencesToSend()}getCustomAudiencesToSend(){return audienceDetector.getCustomAudiencesToSend()}getPredictionsToSend(){return predictions.getPredictionsToSend()}getPredictionsScoreToSend(){return predictions.getPredictionsScoreToSend()}getModelTargets(){return predictions.getModelTargets()}getSuggestionsStateToSend(){return aiUtils.sUtils.getSuggestionsStateToSend()}},abTests=new class{constructor(){this.testsToSend={},this.tests={},this.activeTests={},this.probes={},this.secondaryTargetProbes={},this.logMessages={},this.ready=!1}init(e){if(this.resetLocals(),!e)return;const t=configurationsGetters.domain,i=configurationsGetters.mappedDomain;e[t]&&e[t].length&&e[t].forEach(e=>{this.tests[e.guid]=e}),i&&i!==t&&e[i]&&e[i].length&&e[i].forEach(e=>{this.tests[e.guid]=e}),e._&&e._.length&&e._.forEach(e=>{this.tests[e.guid]=e}),this.loadStoredTests(),this.storeActiveTests(),this.startWaitingForTargetReached(),this.bindEvents(),this.ready=!0}resetLocals(){this.testsToSend={},this.tests={},this.activeTests={},this.probes={},this.secondaryTargetProbes={},this.logMessages={},this.ready=!1}isReady(){return this.ready}getStoredConfigs(){return dal.session.getOne("abTestsConf")}storeActiveTests(){Object.keys(this.activeTests).forEach(e=>{const t=this.tests[e];t&&(this.activeTests[e].name=t.name)}),dal.session.set({abTestsConf:this.activeTests}),wdl.isReady?wdl.storeAbTests(this.activeTests):notifier.bind("wdl-ready",abTests.storeActiveTests.bind(abTests))}loadStoredTests(){const e=liveQA.isTestingMode,t=liveQA.forceShow,i=this.getForceGuid(),r=this.getStoredConfigs();if(r){const n=dal.session.getOne("pv");Object.keys(r).forEach(s=>{if(this.tests[s]){if(i&&i!==s)return;const a=r[s],o=this.tests[s];if(o.isTest!==a.isTest)return;if(o.isTest&&!e&&(!i||!t))return;if(o.ct&&o.ct.tg&&o.ct.tg!==a.testGroupSize)return;if(!o.storedToUser&&1===n)return;1===n&&a.isAbTestInteracted&&(a.isAbTestInteracted=0,a.abTestInteractedValue=""),this.activeTests[s]=a}})}Object.keys(this.tests).forEach(r=>{if(!this.activeTests[r]){if(i&&i!==r)return;const n=this.tests[r];if(n.isTest&&!e&&(!i||!t))return;this.activeTests[r]={guid:r,name:n.name,isTest:n.isTest,isAbTestTarget:0,targetValue:null,isAbTestSecondaryTarget:0,secondaryTargetValue:null,testGroup:"not_set",testGroupSize:n.ct.tg,storedToUser:n.storedToUser,isAbTestInteracted:0,abTestInteractedValue:""}}}),Object.keys(this.activeTests).forEach(e=>{this.testsToSend[e]=this.extractDataToSend(this.activeTests[e])})}extractDataToSend(e){const t={group:e.testGroup,isLiveQA:e.isTest};return["isAbTestTarget","isAbTestSecondaryTarget","targetValue","secondaryTargetValue"].forEach(i=>{coreUtils.isNullish(e[i])||(t[i]=e[i])}),e.isAbTestInteracted&&(t.isAbTestInteracted=e.isAbTestInteracted,t.abTestInteractedValue=e.abTestInteractedValue||""),t}getForceGuid(){const e=liveQA.guid||"";return e&&this.tests[e]?e:""}set(e,t,i){const r=this.activeTests[e];if(r){r.testGroup=null===t?r.testGroup:t,i&&Object.keys(i).forEach(e=>{const t=i[e];e.includes("Value")?r[e]=t:r[e]=coreUtils.isNullish(t)?t:+t}),this.storeActiveTests(),this.testsToSend[e]=this.extractDataToSend(r);const n=`Test ${e}. Set group ${r.testGroup} and changes ${JSON.stringify(i)}`;this.logMessages[n]||(this.logMessages[n]=!0,coreLoggerManager.info(n,"AbTests.set"))}else coreLoggerManager.error(`Test ${e} not found (or not active), can't set group ${t} and changes ${JSON.stringify(i)}`,"AbTests.set")}setInteracted(e,t){const i=this.activeTests[e];if(!i)return void coreLoggerManager.error(`Test ${e} not found (or not active), can't set interacted term to [${t}]`,"AbTests.setInteracted");i.isAbTestInteracted=1,i.abTestInteractedValue=t||"",this.storeActiveTests(),this.testsToSend[e]=this.extractDataToSend(i);const r=`Test ${e}. Trigger interacted state and set term to [${t}]`;this.logMessages[r]||(this.logMessages[r]=!0,coreLoggerManager.info(r,"AbTests.setInteracted")),coreReports.updateStack(!0)}getTestsToSend(){const e={...this.testsToSend};return this.testsToSend={},e}startWaitingForTargetReached(){this.initProbes(),calculationsCycle.add("abTestsWaitForTargetReached",function(){Object.keys(this.activeTests).forEach(e=>{(!this.activeTests[e].isAbTestTarget||!this.activeTests[e].isAbTestSecondaryTarget&&this.secondaryTargetProbes[e])&&this.checkTargetReached(e)})}.bind(this))}checkTargetReached(e){if(!this.activeTests[e])return;const t={};let i=!1;const r=this.probes[e];if(r&&!this.activeTests[e].isAbTestTarget){const e=r();t.isAbTestTarget=e.isReached,t.targetValue=e.targetValue,(e.isReached||e.targetValue)&&(i=!0)}const n=this.secondaryTargetProbes[e];if(n&&!this.activeTests[e].isAbTestSecondaryTarget){const e=n();t.isAbTestSecondaryTarget=e.isReached,t.secondaryTargetValue=e.targetValue,(e.isReached||e.targetValue)&&(i=!0)}i&&this.set(e,null,t)}initProbes(){Object.keys(this.activeTests).forEach(e=>{this.activeTests[e].isAbTestTarget||this.tests[e].ct&&this.tests[e].ct.rule&&(this.probes[e]=generateTargetReachedProbe(this.tests[e].ct.rule,!1)),this.activeTests[e].isAbTestSecondaryTarget||this.tests[e].ct&&this.tests[e].ct.secRule&&(this.secondaryTargetProbes[e]=generateTargetReachedProbe(this.tests[e].ct.secRule,!1))})}bindEvents(){const e={dal:dal,utils:coreUtils,aiUtils:aiUtils,sUtils:aiUtils.sUtils,wdl:wdl,conf:configurationsGetters,fire:notifier.fire.bind(notifier)},t=liveQA.forceShow,i=this.getForceGuid();Object.keys(this.activeTests).forEach(r=>{const n=this.tests[r];n.code=configurationsGetters.getCode(n.code);const s=this.activeTests[r];let a;try{a=Function("args","context",`const {dal,utils,aiUtils,sUtils,wdl,conf,fire,informInteracted}=context;return (${n.code})(args);`)}catch(e){return void coreLoggerManager.error(e,"AbTests.bindEvents: Unable to parse code for test "+r)}notifier.retroBind(n.evt,o=>{(()=>{if(n.t){if(!(i===r&&t||aiUtils.checkForTarget(n.t,wdl.device.toLowerCase(),(dal.session.getOne("traffic_source")||"").toLowerCase())))return void coreLoggerManager.info(`Targeting failed for AB test [${n.name}]\n${(n.code||"!!! no code !!!").slice(0,100)}`,"AbTests.bindEvents");if(coreLoggerManager.info(`Targeting passed for AB test [${n.name}]\n${(n.code||"!!! no code !!!").slice(0,100)}`,"AbTests.bindEvents"),"not_set"===s.testGroup){let e=100*Math.random()<s.testGroupSize?"test":"control";s.testGroup=e,abTests.set(r,e,null)}if(i===r&&t&&(s.testGroup="test"),"control"===s.testGroup)return;const c=e=>{abTests.setInteracted(r,e)};try{a(o,{...e,informInteracted:c})}catch(e){coreLoggerManager.error(e,`AbTests.bindEvents: Error in code for test ${r} [${n.name}]`)}}})()})})}},adaptiveCarousel=(()=>{const e=new class{constructor(){this.dataToSend={},this.tests={},this.activeTests={},this.probes={},this.secondaryTargetProbes={},this.logMessages={},this.checkForViewableMap={},this.topAffinities=[],this.ready=!1}init(e){if(this.resetLocals(),!e)return;const t=configurationsGetters.domain,i=configurationsGetters.mappedDomain;e[t]&&e[t].length&&e[t].forEach(e=>{this.tests[e.guid]=e}),i&&i!==t&&e[i]&&e[i].length&&e[i].forEach(e=>{this.tests[e.guid]=e}),e._&&e._.length&&e._.forEach(e=>{this.tests[e.guid]=e}),this.loadStoredTests(),this.storeActiveTests(),notifier.bind("pageDataCollected",this.start.bind(this))}start(){this.startWaitingForTargetReached(),this.bindEvents(),calculationsCycle.add("adaptive-carousel-visibility",this.performVisibilityCheck.bind(this)),this.ready=!0}resetLocals(){this.dataToSend={},this.tests={},this.activeTests={},this.probes={},this.secondaryTargetProbes={},this.logMessages={},this.checkForViewableMap={},this.topAffinities=[],this.ready=!1}isReady(){return this.ready}getStoredConfigs(){return dal.session.getOne("adaptiveCarouselConf")}storeActiveTests(){Object.keys(this.activeTests).forEach(e=>{const t=this.tests[e];t&&(this.activeTests[e].name=t.name)}),dal.session.set({adaptiveCarouselConf:this.activeTests}),wdl.isReady?wdl.storeAdaptiveCarousel(this.activeTests):notifier.bind("wdl-ready",e.storeActiveTests.bind(e))}loadStoredTests(){const e=liveQA.isTestingMode,t=liveQA.forceShow,i=this.getForceGuid(),r=this.getStoredConfigs();if(r){const n=dal.session.getOne("pv");Object.keys(r).forEach(s=>{if(this.tests[s]){if(i&&i!==s)return;const a=r[s],o=this.tests[s];if(o.isTest!==a.isTest)return;if(o.isTest&&!e&&(!i||!t))return;if(o.ct&&o.ct.tg&&o.ct.tg!==a.testGroupSize)return;if(!o.storedToUser&&1===n)return;1===n&&(a.isPrimaryTarget=0,a.isSecondaryTarget=0,a.targetValue=null,a.secondaryTargetValue=null,a.isViewed=0,a.isReordered=0,a.isClicked=0,a.clickedItemIdx=null,a.clickedItemType=null,a.clickedItemTerms=null),this.activeTests[s]=a}})}Object.keys(this.tests).forEach(r=>{if(!this.activeTests[r]){if(i&&i!==r)return;const n=this.tests[r];if(n.isTest&&!e&&(!i||!t))return;this.activeTests[r]={guid:r,name:n.name,isTest:n.isTest,testGroup:"not_set",testGroupSize:n.ct.tg,storedToUser:n.storedToUser,isPrimaryTarget:0,isSecondaryTarget:0,targetValue:null,secondaryTargetValue:null,isViewed:0,isReordered:0,isClicked:0,clickedItemIdx:null,clickedItemType:null,clickedItemTerms:null}}}),Object.keys(this.activeTests).forEach(e=>{this.dataToSend[e]=this.extractDataToSend(this.activeTests[e])})}extractDataToSend(e){const t={group:e.testGroup,isLiveQA:e.isTest};return["isPrimaryTarget","isSecondaryTarget","targetValue","secondaryTargetValue","isViewed","isReordered","isClicked","clickedItemIdx","clickedItemType","clickedItemTerms"].forEach(i=>{coreUtils.isNullish(e[i])||(t[i]=e[i])}),t}getForceGuid(){const e=liveQA.guid||"";return e&&this.tests[e]?e:""}set(e,t,i){const r=this.activeTests[e];if(r){r.testGroup=null===t?r.testGroup:t,i&&Object.keys(i).forEach(e=>{const t=i[e];e.includes("Value")?r[e]=t:r[e]=coreUtils.isNullish(t)?t:+t}),this.storeActiveTests(),this.dataToSend[e]=this.extractDataToSend(r);const n=`Test ${e}. Set group ${r.testGroup} and changes ${JSON.stringify(i)}`;this.logMessages[n]||(this.logMessages[n]=!0,coreLoggerManager.info(n,"AdaptiveCarousel.set"))}else coreLoggerManager.error(`Test ${e} not found (or not active), can't set group ${t} and changes ${JSON.stringify(i)}`,"AdaptiveCarousel.set")}setClicked(e,t,i,r){const n=this.activeTests[e];if(!n)return void coreLoggerManager.error(`Test ${e} not found (or not active), can't set clicked terms to [${r}]`,"AdaptiveCarousel.setClicked");n.isClicked=1,n.isViewed=1,n.clickedItemIdx=0===t?t:t||null,n.clickedItemType=i||null,n.clickedItemTerms=""===r?r:r||null,this.storeActiveTests(),this.dataToSend[e]=this.extractDataToSend(n);const s=`Test ${e}. Trigger clicked (and viewed) state and set term to [${r}], index to [${t}] and type to [${i}]`;this.logMessages[s]||(this.logMessages[s]=!0,coreLoggerManager.info(s,"AdaptiveCarousel.setClicked")),coreReports.updateStack(!0)}setViewed(t,i=!0){const r=this.activeTests[t];if(!r)return void coreLoggerManager.error(`Test ${t} not found (or not active), can't set the Viewed state`,"AdaptiveCarousel.setViewed");r.isViewed=1,this.storeActiveTests(),delete e.checkForViewableMap[t],this.dataToSend[t]=this.extractDataToSend(r);const n=`Test ${t}. Trigger Viewed state`;this.logMessages[n]||(this.logMessages[n]=!0,coreLoggerManager.info(n,"AdaptiveCarousel.setInteracted")),i&&coreReports.updateStack(!0)}performVisibilityCheck(){let e=!1;Object.keys(this.checkForViewableMap).forEach(t=>{const i=this.checkForViewableMap[t];if(!i||!i.length)return void delete this.checkForViewableMap[t];let r=!1;i.forEach(e=>{!r&&coreUtils.isElementVisible(e)&&(coreUtils.isElementWithinViewport(e)||coreUtils.isElementPartiallyInViewport(e))&&(r=!0)}),r&&(e=!0,this.setViewed(t,!1),delete this.checkForViewableMap[t])}),e&&coreReports.updateStack(!0)}getDataToSend(){const e={...this.dataToSend};return this.dataToSend={},e}startWaitingForTargetReached(){this.initProbes(),calculationsCycle.add("adaptiveCarouselWaitForTargetReached",function(){Object.keys(this.activeTests).forEach(e=>{(!this.activeTests[e].isPrimaryTarget||!this.activeTests[e].isSecondaryTarget&&this.secondaryTargetProbes[e])&&this.checkTargetReached(e)})}.bind(this))}checkTargetReached(e){if(!this.activeTests[e])return;const t={};let i=!1;const r=this.probes[e];if(r&&!this.activeTests[e].isPrimaryTarget){const e=r();t.isPrimaryTarget=e.isReached,t.targetValue=e.targetValue,(e.isReached||e.targetValue)&&(i=!0)}const n=this.secondaryTargetProbes[e];if(n&&!this.activeTests[e].isSecondaryTarget){const e=n();t.isSecondaryTarget=e.isReached,t.secondaryTargetValue=e.targetValue,(e.isReached||e.targetValue)&&(i=!0)}i&&this.set(e,null,t)}initProbes(){Object.keys(this.activeTests).forEach(e=>{this.activeTests[e].isPrimaryTarget||this.tests[e].ct&&this.tests[e].ct.rule&&(this.probes[e]=generateTargetReachedProbe(this.tests[e].ct.rule,!1)),this.activeTests[e].isSecondaryTarget||this.tests[e].ct&&this.tests[e].ct.secRule&&(this.secondaryTargetProbes[e]=generateTargetReachedProbe(this.tests[e].ct.secRule,!1))})}bindEvents(){const t={dal:dal,utils:coreUtils,aiUtils:aiUtils,sUtils:aiUtils.sUtils,wdl:wdl,conf:configurationsGetters,fire:notifier.fire.bind(notifier),adaptiveCarousel:e,guid:"",isTest:null,sortAndBind:()=>{}},i=liveQA.forceShow,r=this.getForceGuid();let n=!1;Object.keys(this.activeTests).forEach(s=>{n||(n=!0,this.topAffinities=configurationsGetters.getFallbackList({}).fallbackList);const a=this.tests[s];if(a.u&&!("or"===a.u.op?aiUtils.orBunch:aiUtils.andBunch)(interactions.getUrlCheckers(a.u.r)))return;a.code=configurationsGetters.getCode(a.code);const o=this.activeTests[s];let c;try{c=Function("args","context",`const {dal,utils,aiUtils,sUtils,wdl,conf,fire,adaptiveCarousel,guid,isTest,sortAndBind}=context;return (${a.code})(args);`)}catch(e){return void coreLoggerManager.error(e,"AdaptiveCarousel.bindEvents: Unable to parse code for test "+s)}notifier.retroBind(a.evt,n=>{(()=>{if(a.t){if(!(r===s&&i||aiUtils.checkForTarget(a.t,wdl.device.toLowerCase(),(dal.session.getOne("traffic_source")||"").toLowerCase())))return void coreLoggerManager.info(`Targeting failed for Carousel [${a.name}]\n${(a.code||"!!! no code !!!").slice(0,100)}`,"AdaptiveCarousel.bindEvents");if(coreLoggerManager.info(`Targeting passed for Carousel [${a.name}]\n${(a.code||"!!! no code !!!").slice(0,100)}`,"AdaptiveCarousel.bindEvents"),"not_set"===o.testGroup){let t=100*Math.random()<o.testGroupSize?"test":"control";o.testGroup=t,e.set(s,t,null)}r===s&&i&&(o.testGroup="test");const l="test"===o.testGroup,d=(t,i,r,n,a,o,c,l)=>e._sortAndBind(s,t,i,r,n,a,o,c,l);try{c(n,{...t,guid:s,isTest:l,sortAndBind:d})}catch(e){coreLoggerManager.error(e,`AdaptiveCarousel.bindEvents: Error in code for test ${s} [${a.name}]`)}}})()})})}_sortAndBind(t,i,r,n,s,a,o,c,l){const d=e.tests[t],u=e.activeTests[t],g="test"===u.testGroup;u.isViewed||(e.checkForViewableMap[t]||(e.checkForViewableMap[t]=[]),e.checkForViewableMap[t].includes(i)||e.checkForViewableMap[t].push(i));const h=Object.entries(g&&d.at||{}).filter(([e,t])=>t).map(([e])=>({c:"category",b:"brand",k:"keyword",col:"color",ca:"custom"}[e]));let f,p,m=[],y=[];if(g){const t=a&&a.length?[...a,...e.topAffinities]:e.topAffinities;[f,p]=aiUtils.sUtils.sortElementsByFewTypes(r,h,n,t,d.p||"recent")}else f=!1,p=r;return e.set(t,null,{isReordered:+f}),p.forEach((i,r)=>{const n=i=>{const n=i.currentTarget,a=g?Object.keys(h.map(e=>{const t="__affinityExtracted_"+e;return n[t]&&n[t].length?n[t]:null}).filter(e=>null!==e).reduce((e,t)=>(t.forEach(t=>{e[t]=!0}),e),{})):[];if(e.setClicked(t,r+1,"item",a),s)try{s(n,a,r)}catch(i){coreLoggerManager.error(i,`AdaptiveCarousel.sortAndBind: Error in clickedExtraCallback for test ${t} [${d.name}]`)}};l?(m.push(n),g&&y.push(h.map(e=>{const t="__affinityExtracted_"+e;return i[t]&&i[t].length?i[t]:null}))):i.addEventListener("click",n,!0)}),o&&o.addEventListener("click",()=>{e.setClicked(t,0,"arrowPrev",null)},!0),c&&c.addEventListener("click",()=>{e.setClicked(t,0,"arrowNext",null)},!0),l?[f,p,m,y]:[f,p]}};return e})(),coreReports=(()=>{const e=new class{init(){this.cycle=0,this.cyclesAreActive=!0,this.maxCyclesToCheckAiFeatures=configurationsGetters.params.maxCyclesToCheckAiFeatures||0,this.cycleTimestamp=Date.now(),this.shouldSend=!1,this.sessionDataCollected=!1,this.pageDataCollected=!1,this.deltaToSend={},this.interval=0,this.loopIntervals=configurationsGetters.params.loopIntervals||[1e3],this.started=!1,notifier.retroBind("pageTypeComputed",()=>{this.started||(this.started=!0,this.updateStack())}),beforeunloadHandler.addSendReportHandler(()=>{e.shouldSend&&e.updateStack(!0,!0)})}reportEvent(e,t=!1){const i=this.getReportData();if(dynamicTracker.ready){i.client_attr1="1";try{dynamicTracker.reportEventsStack("sendGetEventViaWebWorker",{...i,...e||{}})}catch(e){coreLoggerManager.error("Error while using dynamicTracker: "+e,"reportEvent"),i.client_attr2="dynamicTrackerError: "+(e.message||e)}}coreTracker.reportEventsStack("sendGetEventViaWebWorker",{...i,...e||{}})}extendDelta(e){this.deltaToSend={...this.deltaToSend,...e},this.shouldSend=!0}updateStack(e=!1,t=!1){(this.started||e)&&(this.cycle+=1,this.cycleTimestamp=Date.now(),(e||this.cyclesAreActive)&&(performanceMeasurer.start("hook-cycle"),notifier.fireSync("hook-cycle",this.cycle),performanceMeasurer.end("hook-cycle"),(1===this.cycle||this.shouldSend||Object.keys(this.deltaToSend).length)&&(this.reportEvent(null,t),this.shouldSend=!1),coreLoggerManager.log(`**** Cycle ${this.cycle} ****`,"coreUpdateStack"),e)||(this.cyclesAreActive=!this.maxCyclesToCheckAiFeatures||this.maxCyclesToCheckAiFeatures&&this.cycle<this.maxCyclesToCheckAiFeatures,setTimeout(()=>{this.interval<this.loopIntervals.length-1&&(this.interval+=1),this.updateStack()},this.loopIntervals[this.interval])))}getReportData(){const t=dataCollector.getEachCycleData(e);let i={},r={};this.pageDataCollected||(this.pageDataCollected=!0,r=dataCollector.getEachPageData(),i=dataCollector.getEachSessionData(),notifier.fire("pageDataCollected"));const n=dataCollector.getAffinitiesToSend(),s=dataCollector.getCustomAffinitiesToSend(),a=dataCollector.getDetectedColors(),o={...this.deltaToSend,...dataCollector.getInteractionsChanges(),ai_features:dataCollector.getCollectedFeatures(),custom_ai_features:dataCollector.getCollectedCustomFeatures(),audiences:dataCollector.getAudiencesToSend(),custom_audiences:dataCollector.getCustomAudiencesToSend()};Object.entries(n).forEach(([e,t])=>{t.length&&(o[e]=t)}),s.length&&(o.custom_affinities=s),a.length&&(o.colors=a),this.deltaToSend={};const c={action:"wandz_stack",...t,...r,...i},l=dataCollector.getPredictionsToSend();Object.keys(l).length&&(c.predictions=l);const d=dataCollector.getPredictionsScoreToSend();Object.keys(d).length&&(c.predictions_score=d);const u=dataCollector.getModelTargets();if(Object.keys(u).length&&(c.model_targets=u),c.accumulated_events&&o.accumulated_events&&(Object.entries(o.accumulated_events).forEach(([e,t])=>{c.accumulated_events[e]=t}),delete o.accumulated_events),c.event_ids&&o.event_ids&&(c.event_ids=coreUtils.uniqueArray([...c.event_ids,...o.event_ids]),delete o.event_ids),c.ai_features&&o.ai_features&&(c.ai_features={...c.ai_features,...o.ai_features},delete o.ai_features),c.ai_features&&c.ai_features.pageCategory&&c.ai_features.pageCategory!==c.category&&(c.category=c.ai_features.pageCategory),configurationsGetters.params.sendTabId){o.client_attr_json=o.client_attr_json||{};let e=window.sessionStorage.getItem("__wandz_tabId");e||(e=coreUtils.generateUUID(),window.sessionStorage.setItem("__wandz_tabId",e)),o.client_attr_json.tabId=e}if(configurationsGetters.params.sendStackStatus){const e=dal.session.getOne("stack_obj");e&&Object.keys(e).length&&(o.client_attr_json=o.client_attr_json||{},o.client_attr_json.stack_obj=e)}const g=dataCollector.getSuggestionsStateToSend();c.adaptive_search_is_live_qa=g.adaptive_search_is_live_qa,g.suggestionsShown.length&&(c.adaptive_search_shown=g.suggestionsShown),g.clickedSuggestionTerm&&(c.adaptive_search_clicked_term=g.clickedSuggestionTerm),g.adaptiveSearchGroup&&(c.adaptive_search_group=g.adaptiveSearchGroup),g.adaptiveSearchId&&g.adaptiveSearchGroup&&"not_set"!==g.adaptiveSearchGroup&&(c.adaptive_search_id=g.adaptiveSearchId);const h=abTests.getTestsToSend();Object.keys(h).length&&(c.ab_tests=h);const f=adaptiveCarousel.getDataToSend();Object.keys(f).length&&(c.carousels=f);const p=affinityAccumulator.getDataToSend();Object.keys(p).length&&(c.accumulated_affinities=p);const m={...c,...o};return m.categories&&m.categories.length&&(m.categories=coreUtils.asNumbers(m.categories,!0).filter(e=>void 0!==e)),m.brands&&m.brands.length&&(m.brands=coreUtils.asNumbers(m.brands,!0).filter(e=>void 0!==e)),m.custom_affinities&&m.custom_affinities.length&&(m.custom_affinities=coreUtils.asNumbers(m.custom_affinities,!0).filter(e=>void 0!==e)),m}};return e})(),pageTypeDetector=(()=>{const e=[StringComparisonOperators.CONTAINS,StringComparisonOperators.NOT_CONTAINS,StringComparisonOperators.EXACT_MATCH,StringComparisonOperators.REGEX_MATCH,StringComparisonOperators.STARTS_WITH,StringComparisonOperators.ENDS_WITH];return new class{constructor(){this.clientSections=null,this.criteriaRegex=null}async init(){if(this.clientSections&&this.clientSections.length)return;this.clientSections=[];const t=e.join("|");this.criteriaRegex=RegExp(`(${t})\\('([^']*)'\\)`);const i=configurationsGetters.configurations.sectionsMapping||{},r=configurationsGetters.domain,n=configurationsGetters.mappedDomain;i[r]&&(this.clientSections=i[r].map(this.prepareSection.bind(this))),n&&n!==r&&i[n]&&(this.clientSections=[...this.clientSections,...i[n].map(this.prepareSection.bind(this))]),r&&i[""]&&(this.clientSections=[...this.clientSections,...i[""].map(this.prepareSection.bind(this))])}prepareSection(e){if(e.s&&e.p)return{section:e.n,probe:this.parseDetectors(e.p,e.o,e.s)};if(e.r&&e.r.length){const t=e.r.map(t=>this.parseDetectors(t.p,e.o,t.s));return{section:e.n,probe:i=>"or"===e.o?aiUtils.orBunch(t,i):aiUtils.andBunch(t,i)}}}detect(e,t=!1){let i,r,n,s;if(e){const t=new URL(e);i=t.href.toLowerCase(),r=t.hostname.toLowerCase(),n=t.pathname.toLowerCase(),s=(t.search+t.hash).toLowerCase()}else i=(window.location.href||"").toLowerCase(),r=(window.location.hostname||"").toLowerCase(),n=(window.location.pathname||"").toLowerCase(),s=(window.location.search||"").toLowerCase()+(window.location.hash||"").toLowerCase();for(let e=0,a=this.clientSections.length;a>e;e++){const a=this.clientSections[e];if(a.probe([i,r,n,s]))return t||notifier.fire("pageType",a.section),a.section}const a=this.extractPageTypeFromMeta();t||notifier.fire("pageType",a||null)}parseDetectors(e,t,i){const r=e.split(" , ").map(e=>e.trim()),n="p"===i,s=this.getUrlParser(i),a=[];return r.forEach(e=>{const t=e.match(this.criteriaRegex);if(!t)return;const i=t[1];let r=t[2];n&&[StringComparisonOperators.STARTS_WITH,StringComparisonOperators.EXACT_MATCH].includes(i)&&!r.startsWith("/")&&(r="/"+r);const o=aiUtils.getComparator(i);a.push(e=>{const[t,i,n,a]=e;return o(s(t,i,n,a),r)})}),"or"===t?e=>aiUtils.orBunch(a,e):e=>aiUtils.andBunch(a,e)}getUrlParser(e){switch(e=e||"a"){case"a":default:return e=>e;case"d":return(e,t)=>t;case"p":return(e,t,i)=>i;case"s":return(e,t,i,r)=>r}}extractPageTypeFromMeta(){let e="";const t=document.getElementsByTagName("meta");return Array.from(t).forEach(t=>{if(e)return;const i=t.getAttribute("property");if(!i)return;const r=t.content;"og:type"!==i||"og:product"!==r&&"product"!==r?(i.startsWith("product:price")||i.startsWith("og:price"))&&(e=SiteSections.product):e=SiteSections.product}),e}}})(),{checkExtensionGroup:checkExtensionGroup,checkExtension:checkExtension}=(()=>{const e={accessibilityExtensions:{readWriteForGoogleChrome:"inoeonmfapjbbkmdafoankkfajkcphgd/gdocs.page.bundle.js",appWriterCloud:"lokadhdaghfjbmailhhenifjejpokche/menu.html",colorContrastAnalyzer:"dagdlcijhfbmgkjokkjicnnfimlebcll/style.css",intoWords:"nopjifljihndhkfeogabcclpgpceapln/stt.html",myViewBoardExtension:"bflolcmnokpcochfhappdfipeficedjf/icon.png",nightEye:"alncdjedloppbablonallfbkeiknmkdi/css/home.css"},cryptoExtensions:{coinbaseWalletExtension:"hnfanknocfeofbddgcijnmhnfnkdnaad/siteWarning.html",nami:"lpfcbjknijpeeillifnkikgncikgfhdo/icon-128.png",phantom:"bfnaelmomeimhlpmgjnjophhpkkoljpa/ethAlwaysAsk.js",enkrpt:"kkpllkodjeloidieedojogacfhpaihoh/scripts/inject.js"}},t={isPinterestInstalled:"gpdjojdkbbmdfjfahjcgigfpmkopogic/style.css",isBitmojiInstalled:"bfgdeiadkckfbkeigkoncpdieiiefpig/popup.html",isTubeBlockInstalled:"maekfnoeejhpjfkfmdlckioggdcdofpg/css/content.css",isTiktokPixelHelperInstalled:"aelgobmabdmlfmiblddjfnjodalhidnn/inject.js",isInssistInstalled:"bcocdbombenodlegijagbhdjbifpiijp/app/nj.js",isZoomInstalled:"kgjfgplpablkjnlkjmjdecgdpfankdle/images/loading_24.gif",isSkypeInstalled:"lifbcibllhkdhoafpjfnlhfpfgnpldfl/skypelogo_16.png",isWebexInstalled:"jlhmfgmfgeifomenelglieieghnjghma/cwcsf-nativemsg-iframe-43c85c0d-d633-af5e-c056-32dc7efc570b.html",isGoogleMeetAttendanceListInstalled:"appcnhiefcidclcdjeahgklghghihfok/shims.js",isWeherebyInstalled:"bbpjcfkgapecndkanjcojnldopjlnmjk/index.html"},i=(e,t,i)=>{if(!e)return i(t,0);const r=new NmgWorker(e=>{const t=e.url;fetch("chrome-extension://"+t,{method:"GET",body:null}).then(e=>postMessage(200===e.status),()=>{postMessage(!1)}).catch(()=>postMessage(!1))},e=>{i(t,+e)},{fallbackToMainThread:!0});r.run({url:e})};return{checkExtensionGroup:async t=>{const r=Object.keys(e[t]).length,n={},s=(e,i)=>{n[e]=i,Object.keys(n).length===r&&notifier.fire("extensions-detected",t,Object.keys(n).filter(e=>n[e]))};for(let r in e[t])i(e[t][r],r,s)},checkExtension:async(e,r=null)=>{i((r=r||t)[e],e,(e,t)=>{notifier.fire("extensions-detected",e,t)})}}})(),shoppingExtensions=new class{constructor(){this.handleList=[]}async start(e,t){this.handleList=t,await this.detectInstalled(e),await this.initHandlers(t)}async detectInstalled(e){if(!e.length)return;const t=window.chrome&&-1!==navigator.userAgent.indexOf("Edg"),i=Object.keys(configurationsGetters.configurations.ext);for(let r=0,n=i.length;n>r;r++){const n=i[r];if(-1===e.indexOf(n))continue;const s=configurationsGetters.configurations.ext[n],a=t?s.eurl:s.url;await checkExtension(n,{[n]:a||s.url})}}async initHandlers(e){e.length&&(notifier.bind("popped-extension",e=>{wdl.setShoppingExtensions({popped:{[e]:1}})}),notifier.bind("interacted-extension",e=>{wdl.setShoppingExtensions({interacted:{[e]:1}})}),calculationsCycle.add("detect-popped-extensions",this.detectPopped.bind(this)))}detectPopped(){const e=wdl.getBranch(INSTALLS_SHOPPING_FEATURES_PATH);e.installed=e.installed||{},e.popped=e.popped||{},Object.entries(configurationsGetters.configurations.ext).forEach(([t,i])=>{if(-1!==this.handleList.indexOf(t)&&e.installed[t]&&!e.popped[t])for(let e=0,r=i.r.length;r>e;e++){const r=i.r[e],n=this.checkRule(r);if(n.length>0)return aiLoggerManager.info(`${t}: ${JSON.stringify(r)}`,"detectPopped"),notifier.fire("popped-extension",t),void this.bindClickEventListener(n,t)}})}checkRule(e){let t=this.filterByCss(e.c);return t=this.filterByProbe(t,e.p),t=this.filterByProbe(t,e.e),t}filterByCss(e){return Array.from(document.querySelectorAll(e))}filterByProbe(e,t){if(!e.length||!t)return e;const i=this.parseProbe(t);if(!i)return e;const r=[],n=i.length;return e.forEach(e=>{for(let t=0;n>t;t++)if(!this.checkProbe(e,i[t]))return;r.push(e)}),r}parseProbe(e){try{return JSON.parse(e)}catch(t){aiLoggerManager.error(`Error during parse probe [ ${e} ]!`,"shoppingExtensions.parseProbe")}return null}checkProbe(e,t){const i=Object.keys(t)[0];return this.getProbe(i).call(this,e,t[i])}getProbe(e){switch(e){case"id":return this.checkId;case"style":return this.checkStyle;case"outerHTML":return this.checkOuterHTML;case"shadowRoot":return this.checkShadowRoot;case"detectCapitalOneDataAttr":return this.detectCapitalOneDataAttr;case"detectKarmaSiblings":return this.detectKarmaSiblings;case"detectCoupertStyle":return this.detectCoupertStyle;case"shadowRootCssExists":return this.shadowRootCssExists;case"detectBravoBestPrice":return this.detectBravoBestPrice;default:return aiLoggerManager.error(`Unknown probeType: [ ${e} ] !`,"shoppingExtensions.getProbe"),()=>!1}}checkId(e,t){const i=e.id||"";return this.checkProbeOrAnd(i,t,e)}checkStyle(e,t){const i=e.getAttribute("style")||"";return this.checkProbeOrAnd(i,t,e)}checkOuterHTML(e,t){const i=aiUtils.getOuterHtml(e);return this.checkProbeOrAnd(i,t,e)}checkShadowRoot(e,t){return"closed"===t?aiUtils.hasClosedShadowRoot(e):"open"===t?aiUtils.hasOpenShadowRoot(e):"any"===t?null!==e.shadowRoot||aiUtils.hasClosedShadowRoot(e):void 0}detectCapitalOneDataAttr(e,t){const i=aiUtils.getOuterHtml(e).toLocaleLowerCase();return(/data-\w{8}-\w{4}-\w{4}-\w{4}-\w{12}="true"/.test(i)||/data-\w{12}-\w{4}-\w{16}="true"/.test(i)||/data\w{32}="true"/.test(i.replace(/-/g,"")))&&"all: initial !important;"===e.style.cssText}detectKarmaSiblings(e,t=3){let i=!1;const r=e.parentElement;return r.id&&32===r.id.length&&["previousElementSibling","nextElementSibling"].forEach(e=>{if(i)return;let n=r;for(let r=0;t>r;r++){if(n=n[e],!n)return;if(n.src&&n.src.indexOf("/emalgedpdlghbkikiaeocoblajamonoh/")>=0)return void(i=!0)}}),i}detectBravoBestPrice(e,t=6){let i=!1;const r=e.parentElement;if(r.id&&r.id.length===t){let e=0;i=!0,r.querySelectorAll("[id]").forEach(r=>{e++,i=i&&r.id.length===t}),i=i&&e>10}return i}detectCoupertStyle(e,t=!0){let i=!1;return"HTML"===e.parentElement.tagName&&document.querySelectorAll("head > style[id]").forEach(e=>{0>e.innerHTML.indexOf("/mfidniedemcgceagapgdekdbmanojomk/")||(i=!0)}),i}shadowRootCssExists(e,t){const i=e.shadowRoot;let r=!1;if(!i||!i.children)return r;if(t.or)for(let e=0,n=t.or.length;n>e;e++)r||(r=!!i.querySelectorAll(t.or[e]).length);if(t.and)for(let e=0,n=t.and.length;n>e;e++)r&&(r=!!i.querySelectorAll(t.and[e]).length);return r}checkProbeOrAnd(e,t,i){let r=!1;if(t.or)for(let n=0,s=t.or.length;s>n;n++)if(!r){const s=t.or[n];r=s.startsWith("#_")&&s.endsWith("_#")?this.getProbe(s.slice(2,-2)).call(this,i,t):RegExp(s,"i").test(e)}if(t.and)for(let n=0,s=t.and.length;s>n;n++)if(r){const s=t.and[n];r=s.startsWith("#_")&&s.endsWith("_#")?this.getProbe(s.slice(2,-2)).call(this,i,t):RegExp(s,"i").test(e)}return r}bindClickEventListener(e,t){const i=()=>{notifier.fire("interacted-extension",t)};e.forEach(e=>{try{e.addEventListener("click",function(){i(),e.removeEventListener("click",i)},!0)}catch(e){aiLoggerManager.error(`Unable to add EventListener for ${t} extension: ${e}`,"shoppingExtensions.bindClickEventListener")}})}},checkThirdPartyCookies=(()=>{const e=new class{detect(){e.cdnUrl=globals.cdnUrl,e.cookieTestPageName=configurationsGetters.params.cookieTestPageFilename||"cookie-test.html",e.cdnUrl&&e.cookieTestPageName?(e.addListener(),e.injectIframe()):aiLoggerManager.error(`cdnUrl: ${e.cdnUrl}, cookieTestPageName: ${e.cookieTestPageName}`,"CheckThirdPartyCookies: incomplete configuration!")}storeResult(e){wdl.set({blockThirdPartyCookies:e})}injectIframe(){e.iframe=document.createElement("iframe"),e.iframe.src=`${e.cdnUrl}${e.cookieTestPageName}`,e.iframe.style.display="none",document.body.appendChild(e.iframe)}messageHandler(t){0===e.cdnUrl.indexOf(t.origin)&&(e.storeResult(+("enabled"===t.data)),e.iframe.remove(),setTimeout(()=>window.removeEventListener("message",e.messageHandler,!1),100))}addListener(){window.removeEventListener("message",e.messageHandler,!1),window.addEventListener("message",e.messageHandler,!1)}};return e})(),cloudFeatures=(()=>{const e={sunny:"Clear/Sunny",clear:"Clear/Sunny",mist:"Fog/Mist",fog:"Fog/Mist","freezing fog":"Fog/Mist","patchy freezing drizzle possible":"Ice/Freezing","freezing drizzle":"Ice/Freezing","heavy freezing drizzle":"Ice/Freezing","light freezing rain":"Ice/Freezing","moderate or heavy freezing rain":"Ice/Freezing","ice pellets":"Ice/Freezing","light showers of ice pellets":"Ice/Freezing","moderate or heavy showers of ice pellets":"Ice/Freezing","partly cloudy":"Cloudy",cloudy:"Cloudy",overcast:"Cloudy","patchy rain possible":"Rainy","patchy light drizzle":"Rainy","light drizzle":"Rainy","patchy light rain":"Rainy","light rain":"Rainy","moderate rain at times":"Rainy","moderate rain":"Rainy","heavy rain at times":"Rainy","heavy rain":"Rainy","light rain shower":"Rainy","moderate or heavy rain shower":"Rainy","torrential rain shower":"Rainy","patchy snow possible":"Snow","light snow":"Snow","patchy light snow":"Snow","patchy moderate snow":"Snow","moderate snow":"Snow","patchy heavy snow":"Snow","heavy snow":"Snow",blizzard:"Snow","patchy sleet possible":"Snow","light sleet":"Snow","moderate or heavy sleet":"Snow","light sleet showers":"Snow","moderate or heavy sleet showers":"Snow","light snow showers":"Snow","moderate or heavy snow showers":"Snow","blowing snow":"Snow","thundery outbreaks possible":"Thunderstorms","patchy light rain with thunder":"Thunderstorms","moderate or heavy rain with thunder":"Thunderstorms","patchy light snow with thunder":"Thunderstorms","moderate or heavy snow with thunder":"Thunderstorms"},t=new class{perform(){const e=configurationsGetters.params.cloudFeaturesServerHost;if(!e)return void aiLoggerManager.warn("No host provided - unable to calculate!","CloudFeatures.perform");const i=configurationsGetters.params.cloudFeatures||0;if(i<=Math.random())return aiLoggerManager.warn("CloudFeatures are not allowed: "+i,"CloudFeatures.perform"),this.processCloudFeaturesServerResponse({});const r={clienttag:configurationsGetters.configurations.tag,domain:configurationsGetters.domain,timezone:wdl.get("timeZone","aiFeature")||dataCollector.dateTimeFormat&&dataCollector.dateTimeFormat.timeZone||""};wdl.needToRecalculate(["city","continent","country","stateProvince","zipcode"])&&(r.geo=!0),wdl.needToRecalculate(["tempCValue","tempFValue","weatherCondition"])&&(r.geo=!0,r.weather=!0),"ios"===(wdl.get("os","aiFeature")||"").toLowerCase()&&r.geo&&(r.geo=!1),aiLoggerManager.info("Sending the request to the CloudFeatures server: "+JSON.stringify(r),"CloudFeatures.perform"),fetch(e,{...FetchConfigs.POST,body:JSON.stringify(r)}).then(function(e){return e.json()},()=>{}).then(t.processCloudFeaturesServerResponse.bind(t)).catch(()=>{})}processCloudFeaturesServerResponse(e){aiLoggerManager.info(e,"Processing the response from the CloudFeatures server: "),wdl.set({...this.extractVpnData(e),...this.extractInAppBrowsingData(e),...this.extractLocationData(e),...this.extractWeatherData(e)})}extractVpnData(e){let t=1,i=function(){const e=dataCollector.dateTimeFormat;if(e)return e.timeZone}(),r=e.timeZone||"";return r&&(r===i?(t=1,navigator.connection&&navigator.connection.rtt&&navigator.connection.rtt>800&&(t=2)):r!==i&&(t=3)),{vpnProbability:t,isVpn:+(3===t),isProxy:+(e.isProxy||!1),isBot:wdl.get("isBot","aiFeature")||+(e.isMIPBot||!1)}}extractInAppBrowsingData(e){const t=e.appPackage||"";let i=wdl.get("inAppBrowsing","aiFeature")||0;if(t){i=1;const e=(configurationsGetters.configurations.appMapping||{})[t];e?(dal.session.set({traffic_source:e.t,app_referrer:e.r}),dataCollector.traffic_source=e.t):(aiLoggerManager.warn(`inAppBrowsingPackage [${t}] has no mapping!`,"CloudFeatures.extractInAppBrowsingData"),dal.session.set({app_referrer:t}))}return{inAppBrowsing:i,inAppBrowsingPackage:wdl.get("inAppBrowsingPackage","aiFeature")||t}}extractLocationData(e){return e.city?{city:e.city,country:e.country||"",stateProvince:e.region||"",continent:e.continent||"",zipcode:e.code||""}:{}}extractWeatherData(t){return t.condition?{tempCValue:t.tempC,...aiUtils.calculateScore(t.tempC,"tempCValue",wdl.device),tempFValue:t.tempF,...aiUtils.calculateScore(t.tempF,"tempFValue",wdl.device),weatherCondition:e[t.condition.toLowerCase()]||t.condition||""}:{}}};return t})(),detectAdBlocker=()=>{let e=0;const t=document.createElement("div");t.id="adbox",t.className="banner_ads ads ad adsbox doubleclick ad-placement carbon-ads pub_300x250 pub_300x250m pub_728x90 text-ad textAd text_ad text_ads text-ads text-ad-links",t.setAttribute("style","position: absolute !important;width: 100px !important;height: 100px !important;z-index: -1 !important;top: -1000px !important;left: -1000px !important;"),t.setAttribute("aria-label","Advertisement"),t.setAttribute("title","3rd party ad content");const i=document.body;i&&i.appendChild&&i.appendChild(t),setTimeout(function(){let i=document.querySelector("#adbox");if(i){const t=window.getComputedStyle(i);0!==i.offsetHeight&&"none"!==t.getPropertyValue("display")&&"hidden"!==t.getPropertyValue("visibility")||(e=1)}else e=1;e||null===document.body.getAttribute("abp")||(e=1),notifier.fire("is-adstyleblocker",e),t.remove()},1500)},detectAutotranslate=(()=>{const e=(e,t="")=>{notifier.fire("detect-autotranslate",+e),e&&t&&mutationObserverHandler.remove(t)};return()=>{"Edge"===wdl.browser&&mutationObserverHandler.add("setAutoTranslateByEdgeObserver",()=>{const t=document.getElementsByTagName("title")[0],i=t.getAttribute("_msthash")&&"149916"===t.getAttribute("_msthash");e(!!i,"setAutoTranslateByEdgeObserver")}),mutationObserverHandler.add("setAutoTranslateByGoogleObserver",()=>{const t=document.getElementsByTagName("html")[0],i=!!Array.from(t.classList).filter(e=>e.match(/translated/)).length;e(i,"setAutoTranslateByGoogleObserver")}),(()=>{let t=document.documentElement,i=["goog-te-combo","goog-te-banner","notranslate"].some(e=>t.classList.contains(e));const r=navigator.language||navigator.userLanguage,n=document.documentElement.lang,s=new URLSearchParams(window.location.search);n&&r===n&&(i=!0),!s.has("lang")||s.get("lang")===r&&r.split("-")[0]===s.get("lang")||(i=!0),e(i)})()}})(),detectIncognitoMode=(()=>{let e=1,t=[];const i=i=>{t.push(i?1:0),t.length<e||notifier.fire("detectedIncognitoMode",Math.max(0,...t))},r=()=>{new Promise(e=>{const t=()=>e(!0),i=()=>e(!1);if(window.webkitRequestFileSystem)window.webkitRequestFileSystem(window.TEMPORARY,1,i,t);else{const e="test"+coreUtils.generateRandomString(5);try{localStorage.setItem(e,"1"),localStorage.removeItem(e),i()}catch(e){t()}}}).then(e=>{i(e)})},n=()=>{void 0!==navigator.maxTouchPoints?void 0!==window.safari&&void 0===window.DeviceMotionEvent?(()=>{let e=!1;try{window.safari.pushNotification.requestPermission("https://mjca-yijws.global.ssl.fastly.net","private",{},function(){})}catch(t){/gesture/.test(t)||(e=!0,i(!0))}e||i(!1)})():(()=>{let e=!1;const t=document.createElement("iframe");t.style.display="none",document.body.appendChild(t),t.contentWindow.applicationCache.addEventListener("error",function(){e=!0,i(!0)}),setTimeout(function(){e||i(!1),document.body.removeChild(t)},100)})():(()=>{try{window.openDatabase(null,null,null,null)}catch(e){return void i(!0)}try{const e="test"+coreUtils.generateRandomString(5);window.localStorage.setItem(e,"1"),window.localStorage.removeItem(e)}catch(e){return void i(!0)}i(!1)})()},s=()=>{const e=Math.random()+"";try{window.indexedDB.open(e,1).onupgradeneeded=function(t){const r=t.target.result;try{r.createObjectStore("test",{autoIncrement:!0}).put(new Blob),i(!1)}catch(e){let t=e;if(e instanceof Error&&(t=e.message||e),"string"!=typeof t)return void i(!1);const r=t.includes("BlobURLs are not yet supported");i(r)}finally{r.close(),window.indexedDB.deleteDatabase(e)}}}catch(e){i(!1)}},a=()=>{Promise&&void 0!==Promise.allSettled?navigator.webkitTemporaryStorage.queryUsageAndQuota(function(e,t){const r=Math.round(t/1048576),n=2*Math.round((window.performance&&window.performance.memory&&void 0!==window.performance.memory.jsHeapSizeLimit?performance.memory.jsHeapSizeLimit:1073741824)/1048576);i(n>r)},function(e){aiLoggerManager.error(e.message,"detectIncognito somehow failed to query storage quota: "),i(!1)}):window.webkitRequestFileSystem(0,1,function(){i(!1)},function(){i(!0)})},o=()=>{i(void 0===navigator.serviceWorker)},c=()=>{i(void 0===window.indexedDB)};return()=>{t=[];const l=[r,n,s,a,o,c],d=l.length;e=d;try{for(let e=0;d>e;e++)try{l[e]()}catch(e){i(!1)}}catch(e){aiLoggerManager.error("Incognito detection failed: "+e,"detectIncognitoMode")}}})(),locationFromTimezone=(()=>{const e=(e,t,i)=>{let r;return Object.entries(i).forEach(([i,n])=>{var s;!r&&RegExp(n.replace(/,\s*/g,"|")).test(e)&&(r={city:(s=e,s.split("_").map(coreUtils.toTitleCase).join(" ")),country:i,continent:t})}),r||null};return t=>{let i;if(!t||!configurationsGetters.configurations.cityCountryMapping)return{};try{const r=t.split("/");if(2!==r.length)return aiLoggerManager.warn(`Unsupported timeZone: [${t}]`,"locationFromTimezone"),{};const[n,s]=r;configurationsGetters.configurations.cityCountryMapping[n]&&(i=e(s,n,configurationsGetters.configurations.cityCountryMapping[n])),i||Object.entries(configurationsGetters.configurations.cityCountryMapping).forEach(([t,r])=>{i=i||e(s,t,r)})}catch(e){aiLoggerManager.error(e,"locationFromTimezone")}return i||{}}})(),pagePerformance=(()=>{const e=e=>0>e?0:e;return{getAll(){const t=window.performance.memory&&void 0!==window.performance.memory.jsHeapSizeLimit?window.performance.memory.jsHeapSizeLimit:1073741824,i=window.performance.timing;let r=i.connectEnd,n=i.connectStart,s=i.domContentLoadedEventEnd,a=i.domContentLoadedEventStart,o=i.domInteractive,c=i.domLoading,l=i.domainLookupEnd,d=i.domainLookupStart,u=i.fetchStart,g=i.loadEventEnd,h=i.loadEventStart,f=i.navigationStart,p=i.redirectEnd,m=i.redirectStart,y=i.requestStart,T=i.responseEnd,w=i.responseStart,b=i.secureConnectionStart,v=i.unloadEventEnd,S=i.unloadEventStart;const A=window.performance.navigation.type,C=window.performance.navigation.redirectCount,_=e(s-f),E=e(o-c);return{pageLoadValue:_,...aiUtils.calculateScore(_,"pageLoadValue",wdl.device),timeToInteractionValue:E,...aiUtils.calculateScore(E,"timeToInteractionValue",wdl.device),connectStart:n,connectEnd:r,connectionTime:e(r-n),contentLoadTime:e(s-f),domainLookupStart:d,domainLookupEnd:l,dnsResolutionTime:e(l-d),domContentLoadedEventEnd:s,domContentLoadedEventStart:a,domContentLoadedTime:e(s-a),domInteractive:o,domLoading:c,DOMProcessingTime:e(o-T),fetchStart:u,jsHeapSizeLimit:t,loadEventStart:h,loadEventEnd:g,navigationStart:f,navigationType:A,pageDownloadTime:e(T-w),pageLoadTime:e(g-f),pageRenderTime:e(g-c),redirectStart:m,redirectEnd:p,redirectionTime:e(p-m),redirectCount:C,requestStart:y,responseStart:w,responseEnd:T,secureConnectionStart:b,serverResponseTime:e(w-y),TimeToFirstByte:e(u-f),unloadEventStart:S,unloadEventEnd:v,unloadEventTime:e(v-S)}}}})(),passwordSaverDetector=(()=>{const e=()=>{notifier.fire("has-password-saver",1)};return()=>{document.querySelector("body").insertAdjacentHTML("afterbegin",'<div class="pwd-detect-check" style="opacity:0.001; height: 0;" >\n                <form style="height:0">\n                    <input style="height:0;width:0;border:0" type="password" name="password" />\n                <form>\n            </div>');let t=document.querySelector(".pwd-detect-check form");setTimeout(function(){let i=0;t.childElementCount>1&&(i=1,e()),t.parentElement.remove(),0===i&&document.querySelectorAll('[type="password"]').forEach(t=>{t.addEventListener("keyup",function(t){t.keyCode||(i=1,e())}),t.addEventListener("click",function(){const t=document.querySelector("body").lastElementChild;t&&t.outerHTML&&t.outerHTML.includes("password")&&(i=1,e())},!1)})},1500)}})(),propertyCounts=(()=>{const e={collectAll:()=>({numOfCookieKeys:document.cookie.split(";").length,numOfDomProperties:Object.keys(document).length,numOfWindowObjectKeys:Object.keys(window).length,numOfLocalStorageKeys:localStorage.length,numOfSessionStorageKeys:sessionStorage.length}),collectAndSetAll(){wdl.set(e.collectAll())}};return e})(),{featureCollector:featureCollector,getActiveFeatureCollectorMethods:getActiveFeatureCollectorMethods}=(()=>{const e=function(){function e(e,t){return function(e,t){return t.get?t.get.call(e):t.value}(e,i(e,t,"get"))}function t(e,t,r){return function(e,t,i){if(t.set)t.set.call(e,i);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=i}}(e,i(e,t,"set"),r),r}function i(e,t,i){if(!t.has(e))throw new TypeError("attempted to "+i+" private field on non-instance");return t.get(e)}function r(e,t,i){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return i}function n(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function s(e,t,i){n(e,t),t.set(e,i)}function a(e,t){n(e,t),t.add(e)}function o(){t(this,u,RegExp(e(this,d).join("|"),l))}function c(t){return e(this,d).indexOf(t.toLowerCase())}var l,d,u,g,h,f,p=[" daum[ /]"," deusu/","(?:^| )site","@[a-z]","\\(at\\)[a-z]","\\(github\\.com/","\\[at\\][a-z]","^12345","^<","^[\\w \\.]+/v?\\d+(\\.\\d+)?(\\.\\d{1,10})?$","^[\\w]+$","^[^ ]{50,}$","^ace explorer","^acoon","^active","^ad muncher","^anglesharp/","^anonymous","^apple-pubsub/","^astute srm","^avsdevicesdk/","^axios/","^bidtellect/","^biglotron","^blackboard safeassign","^blocknote.net","^braze sender","^captivenetworksupport","^castro","^cf-uc ","^clamav[ /]","^cobweb/","^coccoc","^dap ","^ddg[_-]android","^discourse","^dispatch/\\d","^downcast/","^duckduckgo","^email","^enigma browser","^evernote clip resolver","^facebook","^faraday","^fdm[ /]\\d","^getright/","^gozilla/","^hatena","^hobbit","^hotzonu","^hwcdn/","^infox-wisg","^invision","^jeode/","^jetbrains","^jetty/","^jigsaw","^linkdex","^lwp[-: ]","^mailchimp\\.com$","^metauri","^microsoft bits","^microsoft data","^microsoft office existence","^microsoft office protocol discovery","^microsoft windows network diagnostics","^microsoft-cryptoapi","^microsoft-webdav-miniredir","^movabletype","^mozilla/\\d\\.\\d \\(compatible;?\\)$","^mozilla/\\d\\.\\d \\w*$","^my browser$","^navermailapp","^netsurf","^node-superagent","^octopus","^offline explorer","^pagething","^panscient","^perimeterx","^php","^postman","^postrank","^python","^read","^reed","^request-promise$","^restsharp/","^shareaza","^shockwave flash","^snapchat","^space bison","^sprinklr","^svn","^swcd ","^t-online browser","^taringa","^test certificate info","^the knowledge ai","^thinklab","^thumbor/","^traackr.com","^tumblr/","^vbulletin","^venus/fedoraplanet","^w3c","^webbandit/","^webcopier","^wget","^whatsapp","^www-mechanize","^xenu link sleuth","^yahoo","^yandex","^zdm/\\d","^zeushdthree","^zoom marketplace/","adbeat\\.com","appinsights","archive","ask jeeves/teoma","bit\\.ly/","bluecoat drtr","bot","browsex","burpcollaborator","capture","catch","check","chrome-lighthouse","chromeframe","client","cloud","crawl","daemon","dareboost","datanyze","dataprovider","dejaclick","dmbrowser","download","evc-batch/","feed","fetch","firephp","freesafeip","ghost","gomezagent","google","headlesschrome/","http","httrack","hubspot marketing grader","hydra","ibisbrowser","images","index","ips-agent","java","library","mail\\.ru/","manager","monitor","morningscore/","neustar wpm","news","nutch","offbyone","optimize","pagespeed","parse","perl","phantom","pingdom","powermarks","preview","probe","proxy","ptst[ /]\\d","reader","rexx;","rigor","rss","scan","scrape","search","server","sogou","sparkler/","spider","statuscake","stumbleupon\\.com","supercleaner","synapse","synthetic","taginspector/","toolbar","torrent","tracemyfile","transcoder","trendsmapresolver","twingly recon","url","valid","virtuoso","wappalyzer","webglance","webkit2png","websitemetadataretriever","whatcms/","wordpress","zgrab"];return function(e){try{RegExp("(?<! cu)bot").test("dangerbot")}catch(t){return e}e.splice(e.lastIndexOf("bot"),1),e.push("(?<! cu)bot"),e.splice(e.lastIndexOf("google"),1),e.push("(?<! (channel\\/|google\\/))google(?!(app|\\/google))"),e.splice(e.lastIndexOf("search"),1),e.push("(?<! (ya|yandex))search"),e.splice(e.lastIndexOf("http"),1),e.push("(?<!(lib))http"),e.splice(e.lastIndexOf("java"),1),e.push("java(?!;)"),e.splice(e.lastIndexOf("fetch"),1),e.push("(?<!(mozac))fetch")}(p),l="i",d=new WeakMap,u=new WeakMap,g=new WeakSet,h=new WeakSet,f=function(){function i(e){var n=this;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),a(this,h),a(this,g),s(this,d,{writable:!0,value:void 0}),s(this,u,{writable:!0,value:void 0}),t(this,d,e||p.slice()),r(this,g,o).call(this),Object.defineProperties(function(e){return n.test(e)},Object.getOwnPropertyNames(i.prototype).filter(function(e){return!["constructor"].includes(e)}).reduce(function(e,t){return Object.assign(e,(s={get:function(){return n[t].bind(n)}},(r=t)in(i={})?Object.defineProperty(i,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):i[r]=s,i));var i,r,s},{}))}var n,f;return n=i,f=[{key:"test",value:function(t){return!!t&&e(this,u).test(t)}},{key:"find",value:function(t){var i=(arguments.length>0&&void 0!==t?t:"").match(e(this,u));return i&&i[0]}},{key:"matches",value:function(t){var i=arguments.length>0&&void 0!==t?t:"";return e(this,d).filter(function(e){return RegExp(e,l).test(i)})}},{key:"clear",value:function(e){var t=arguments.length>0&&void 0!==e?e:"";this.exclude(this.matches(t))}},{key:"extend",value:function(t){var i=this,n=arguments.length>0&&void 0!==t?t:[];[].push.apply(e(this,d),n.filter(function(e){return-1===r(i,h,c).call(i,e)}).map(function(e){return e.toLowerCase()})),r(this,g,o).call(this)}},{key:"exclude",value:function(t){for(var i,n=arguments.length>0&&void 0!==t?t:[],s=n.length;s--;)(i=r(this,h,c).call(this,n[s]))>-1&&e(this,d).splice(i,1);r(this,g,o).call(this)}},{key:"spawn",value:function(t){return new i(t||e(this,d))}}],f&&function(e,t){var i,r;for(i=0;i<t.length;i++)(r=t[i]).enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}(n.prototype,f),Object.defineProperty(n,"prototype",{writable:!1}),i}(),new f}(),t={accessibilityExtensions:["accessibilityExtensions","cryptoExtensions",...SOCIAL_MEDIA_EXTENSIONS,...VIDEO_CONFERENCING_EXTENSIONS,"isTubeBlockInstalled"],affinityInteractionsWithBlack:["affinityInteractionsWithRed","affinityInteractionsWithGreen","affinityInteractionsWithBlue","affinityInteractionsWithWhite","affinityInteractionsWithBlack","affinityInteractionsWithPurple","affinityInteractionsWithPink","affinityInteractionsWithOrange","affinityInteractionsWithYellow","affinityInteractionsWithBrown","affinityInteractionsWithGrey","affinityInteractionsWithGold","affinityInteractionsWithSilver"],areMultipleTabsOpen:["numOfOpenTabsValue","numOfOpenTabsScore","areMultipleTabsOpen"],areNotificationsApproved:["hasLocationApproved","areNotificationsApproved","hasCameraApproved"],batteryIsCharging:["batteryIsCharging","batteryPercentageValue","batteryPercentageScore"],blockThirdPartyCookies:["blockThirdPartyCookies"],browser:["os","browser","browserVersion","deviceType"],browsingWithShoppingAffiliate:["browsingWithShoppingAffiliate"],browsingWithSocialMediaAffiliate:["browsingWithSocialMediaAffiliate"],browsingWithVideoConferencingAffiliate:["browsingWithVideoConferencingAffiliate"],channel:["channel"],clickOnAcceptCookies:["clickOnAcceptCookies"],clickOnOuterUrl:["clickOnOuterUrl"],clicksInSessionValue:["clicksInSessionValue","clicksInSessionScore"],cpuStrengthValue:["cpuStrengthValue","cpuStrengthScore"],deviceLayout:["pxWidth","pxHeight","deviceLayout"],hasAdBlocker:["hasAdBlocker"],hasForceDarkModeExtensions:["hasForceDarkModeExtensions"],hasPasswordSaver:["hasPasswordSaver"],inAppBrowsing:["inAppBrowsing"],isBot:["isBot"],isBotEnhanced:["isBotEnhanced"],isCopiedText:["isCopiedText","isUserInteractionOccurred"],isDarkMode:["isDarkMode","doNotTrackEnabled"],isDay:["isDay","dayOfSession","hourInDay"],isForceDarkMode:["isForceDarkMode"],isIncognitoSession:["isIncognitoSession"],isPageAutoTranslated:["isPageAutoTranslated"],isTabInFocus:["isTabInFocus","timeOffTabValue","timeOffTabScore"],networkStrengthValue:["networkStrengthValue","networkStrengthScore"],numOfCookieKeys:["numOfCookieKeys","numOfDomProperties","numOfWindowObjectKeys","numOfLocalStorageKeys","numOfSessionStorageKeys"],numOfCategoryPageViews:["numOfCategoryPageViews"],numOfProductViews:["numOfProductViews"],numOfSessions:["numOfSessions"],pageAccessibilityValue:["pageAccessibilityValue","pageAccessibilityScore"],pageCount:["pageCount","totalPageCountForVisitor"],pageLanguage:["pageLanguage"],pageLoadValue:["pageLoadValue","pageLoadScore","timeToInteractionValue","timeToInteractionScore","connectStart","connectEnd","connectionTime","contentLoadTime","domainLookupStart","domainLookupEnd","dnsResolutionTime","domContentLoadedEventEnd","domContentLoadedEventStart","domContentLoadedTime","domInteractive","domLoading","DOMProcessingTime","fetchStart","jsHeapSizeLimit","loadEventStart","loadEventEnd","navigationStart","navigationType","pageDownloadTime","pageLoadTime","pageRenderTime","redirectStart","redirectEnd","redirectionTime","redirectCount","requestStart","responseStart","responseEnd","secureConnectionStart","serverResponseTime","TimeToFirstByte","unloadEventStart","unloadEventEnd","unloadEventTime"],pageType:["pageType","inCart","inCheckout","inConfirmationPage","purchase","numOfPurchases","reachedBottomOfFunnel","landingSection"],pagesUntilReachedSite:["pagesUntilReachedSite"],pageZoom:["pageZoom","innerWidth","innerHeight","outerWidth","outerHeight","devicePixelRatio"],prefLanguage:["prefLanguage","numberOfBrowserLanguages","browserLanguages","isOtherBrowserLanguage","chineseBrowserLanguage","dutchBrowserLanguage","englishBrowserLanguage","frenchBrowserLanguage","germanBrowserLanguage","italianBrowserLanguage","polishBrowserLanguage","russianBrowserLanguage","spanishBrowserLanguage","ukrainianBrowserLanguage","hebrewBrowserLanguage","arabicBrowserLanguage"],referrer:["referrer"],scrollBelowTheFold:["scrollBelowTheFold"],scrollSpeed:["scrollSpeed"],timeOnPageValue:["timeOnPageValue","timeOnPageScore","timeOnSiteValue","timeOnSiteScore"],timeSinceLastVisitValue:["timeSinceLastVisitValue","timeSinceLastVisitScore"],timeZone:["timeZone","locale","city","continent","country"],utm_source:["utm_source","utm_campaign","utmContent"],vpnProbability:["vpnProbability","isVpn","isProxy","inAppBrowsingPackage","city","continent","country","stateProvince","zipcode","tempCValue","tempFValue","weatherCondition"]},i=["affinityInteractionsWithBlack","areMultipleTabsOpen","batteryIsCharging","isCopiedText","isTabInFocus","numOfCookieKeys","numOfProductViews","pageType","scrollBelowTheFold","scrollSpeed","timeOnPageValue","pageZoom","innerWidth","innerHeight","outerWidth","outerHeight","devicePixelRatio","numOfCategoryPageViews"];return{featureCollector:new class{cpuStrengthValue(){let e=0,t=Date.now(),i=t;for(;i-t===0;)i=Date.now();for(t=i;2>i-t;)e++,i=Date.now();return e=Math.round(e/1),wdl.set({cpuStrengthValue:e,...aiUtils.calculateScore(e,"cpuStrengthValue",wdl.device)}),e}networkStrengthValue(){const e=globals.cdnUrl,t=new NmgWorker(e=>{const t=e.cdnUrl;if(!t)return;const i=Date.now();fetch(t+"5kLogo.png").then(e=>e.body,e=>{throw Error("Unable to fetch: "+e)}).then(e=>{const t=e.getReader();let r=0;return new ReadableStream({start(e){const n=()=>{t.read().then(({done:t,value:s})=>{if(t)return e.close(),void terminateWorker();r+=s.byteLength;const a=Date.now();postMessage(r?Math.round(r/(a-i||.5)):null),e.enqueue(s),n()})};n()}})},()=>{}).catch(()=>{})},e=>{e instanceof Error?aiLoggerManager.info(e):wdl.set({networkStrengthValue:e,...aiUtils.calculateScore(e,"networkStrengthValue",wdl.device)})},{fallbackToMainThread:!0,waitForTerminate:!0});t.run({cdnUrl:e},[])}browser(){wdl.set({os:coreUtils.getOS(),browser:coreUtils.getBrowser(),browserVersion:coreUtils.bowser.getBrowserVersion(),deviceType:wdl.device})}areNotificationsApproved(){const e={};Object.values(BrowserPermissions).forEach(async t=>{try{const i=await aiUtils.getPermissionStatus(t),r=BrowserPermissionToDataPoint[t],n="granted"===i.state;e[r]=+n,3===Object.keys(e).length&&wdl.set(e),"addEventListener"in i&&i.addEventListener("change",e=>{const i=e.currentTarget,r=BrowserPermissionToDataPoint[t],n="granted"===i.state;wdl.set({[r]:+n})})}catch(e){aiLoggerManager.error(e)}})}isDarkMode(){const e=aiUtils.getDeviceSettings();wdl.set({isDarkMode:+e.darkMode,doNotTrackEnabled:+e.doNotTrack})}pageAccessibilityValue(){let e=aiUtils.getSelfFetchTime();e&&e>=0||(e=null),null!==e?wdl.set({pageAccessibilityValue:e,...aiUtils.calculateScore(e,"pageAccessibilityValue",wdl.device)}):aiLoggerManager.warn("No SelfFetchTime calculated!","pageAccessibilityValue")}areMultipleTabsOpen(){const e=e=>{wdl.set({numOfOpenTabsValue:e,...aiUtils.calculateScore(e,"numOfOpenTabsValue",wdl.device),areMultipleTabsOpen:+(e&&e>1)})};let t=0;if("BroadcastChannel"in window){const i=new BroadcastChannel("wandz-tab-tracker"),r=coreUtils.generateUUID(),n=3e3;let s={};i.postMessage({type:"heartbeat",tabId:r,timestamp:Date.now()}),calculationsCycle.add("areMultipleTabsOpenHeartbeat",()=>{i.postMessage({type:"heartbeat",tabId:r,timestamp:Date.now()})}),i.onmessage=e=>{const{type:t,tabId:i,timestamp:r}=e.data;"heartbeat"===t&&(s[i]=r)},calculationsCycle.add("areMultipleTabsOpen",()=>{const i=Date.now();for(const[e,t]of Object.entries(s))i-t>n&&delete s[e];const r=Object.keys(s).length+1;r!==t&&(e(r),t=r)})}else{aiLoggerManager.warn("BroadcastChannel not supported, using localStorage for tab tracking","areMultipleTabsOpen");const t=()=>wdl.storageManager.getItem(WDLStorageKeys.OPEN_TABS,!0)||{},i=e=>{wdl.storageManager.setItem(WDLStorageKeys.OPEN_TABS,e,!0)},r="wndz_tab_key";let n=sessionStorage.getItem(r);n||(n=coreUtils.generateUUID(),sessionStorage.setItem(r,n));const s=t();s[n]=Date.now(),i(s);const a="wndz_openTabs",o=()=>{let t=+wdl.storageManager.getItem(a);t&&!isNaN(t)||(t=1),e(t)};let c=+wdl.storageManager.getItem(a);c=(+c||0)+1,wdl.storageManager.setItem(a,c.toString()),o(),beforeunloadHandler.addRegular("numOfOpenTabs",()=>{let e=+wdl.storageManager.getItem(a);if(e){e--,wdl.storageManager.setItem(a,e.toString());const r=t();delete r[n],i(r)}}),window.addEventListener("storage",e=>{if(e&&e.key===storageManagers.sharedStorageItemName)try{JSON.parse(e.oldValue)[a]!==JSON.parse(e.newValue)[a]&&o()}catch(e){aiLoggerManager.warn("Unable to check numOpenTabs: "+e,"areMultipleTabsOpen")}}),calculationsCycle.add("areMultipleTabsOpen",()=>{const e=t(),r=Date.now();e[n]=r,Object.keys(e).forEach(t=>{r-+e[t]>3e4&&delete e[t]}),i(e);const s=Object.keys(e).length;s!==parseInt(wdl.storageManager.getItem(a))&&(wdl.storageManager.setItem(a,s.toString()),o())})}}isTabInFocus(){const e=e=>{notifier.fire("isTabInFocus-calculated",e)};let t=0;const i=+document.hasFocus();wdl.set({isTabInFocus:i,timeOffTabValue:0,timeOffTabScore:1}),e(i),notifier.bind("isTabInFocus",i=>{i?(wdl.set({isTabInFocus:1,timeOffTabValue:0,timeOffTabScore:1}),calculationsCycle.remove("isTabInFocus")):(wdl.set({isTabInFocus:0}),t=Date.now(),calculationsCycle.add("isTabInFocus",()=>{const e=Math.round((Date.now()-t)/1e3);return{timeOffTabValue:e,...aiUtils.calculateScore(e,"timeOffTabValue",wdl.device)}})),e(i)}),window.addEventListener("blur",()=>{notifier.fire("isTabInFocus",0)},!0),window.addEventListener("focus",()=>{notifier.fire("isTabInFocus",1)},!0),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState?notifier.fire("isTabInFocus",0):"visible"===document.visibilityState&&notifier.fire("isTabInFocus",1)})}pageCount(){wdl.set({pageCount:dal.session.getOne("pv")||0,totalPageCountForVisitor:dal.session.getOne("pv_counter")||0})}pagesUntilReachedSite(){window.history&&window.history.length&&wdl.set({pagesUntilReachedSite:window.history.length-1})}inAppBrowsing(){wdl.set({inAppBrowsing:+coreUtils.isInAppView(window.navigator.userAgent)||+!!wdl.get("inAppBrowsingPackage","aiFeature")})}pageType(){notifier.retroBind("pageType",e=>{let t={pageType:e,inCart:0,inCheckout:0,inConfirmationPage:0,purchase:0};switch(e){case SiteSections.cart:t.inCart=1;break;case SiteSections.checkout:t.inCheckout=1;break;case SiteSections.orderConfirmation:t={...t,inConfirmationPage:1,purchase:1,...aiUtils.purchaseHasMade()}}0>[SiteSections.cart,SiteSections.checkout,SiteSections.orderConfirmation].indexOf(e)||(t.reachedBottomOfFunnel=1),wdl.set(t),1===dal.session.getOne("pv")&&wdl.set({landingSection:wdl.get("pageType","aiFeature")}),notifier.fire("pageTypeComputed")})}referrer(){wdl.set({referrer:coreUtils.getDomainFromUrl(document.referrer)})}timeOnPageValue(){let e=Date.now(),t=0,i=0,r=0,n=dal.session.getOne("tos")||0;0>n&&(n=0,dal.session.set({tos:0}));const s=()=>{i=t+aiUtils.secondsDiffFromNow(e),r=n+i,wdl.set({timeOnPageValue:i,timeOnSiteValue:r,...aiUtils.calculateScore(i,"timeOnPageValue",wdl.device),...aiUtils.calculateScore(r,"timeOnSiteValue",wdl.device)}),dal.session.set({tos:r})};s(),document.hasFocus()&&calculationsCycle.add("updatePageAndSiteTiming",s),beforeunloadHandler.addRegular("timeOnSite",()=>{dal.session.set({tos:n+t+aiUtils.secondsDiffFromNow(e)})}),notifier.bind("isTabInFocus",r=>{r?(e=Date.now(),t=i,calculationsCycle.add("updatePageAndSiteTiming",s)):calculationsCycle.remove("updatePageAndSiteTiming"),s()})}clicksInSessionValue(){setClickedPerSessionsListener()}clickOnOuterUrl(){if(!wdl.needToRecalculate(["clickOnOuterUrl"]))return;const e=document.querySelectorAll("[href]"),t=Array.from(e),i=window.location.hostname.replace(/^www\./,""),r=t.filter(e=>coreUtils.isString(e.href)&&!e.href.startsWith("/")&&!e.href.startsWith("#")&&!e.href.includes(i)&&!e.href.includes("javascript"));let n="mousedown";("ontouchstart"in window||navigator.maxTouchPoints>0)&&(n="touchstart"),r.forEach(e=>e.addEventListener(n,e=>{try{const t=e.target.closest("a");t&&t.href&&wdl.set({clickOnOuterUrl:1})&&coreReports.shouldSend&&0!==coreReports.cycle&&!coreReports.cyclesAreActive&&(coreReports.cyclesAreActive=!0)}catch(e){aiLoggerManager.error(e)}}))}clickOnAcceptCookies(){notifier.bind("accept-cookies",()=>{wdl.set({clickOnAcceptCookies:1})});const e=t=>{let i=t.target,r=i.innerText.trim().toLowerCase()||i.textContent.trim().toLowerCase();const n=["agree","allow","accept"].some(e=>r.includes(e));if(30>r.length&&n){let t=!1;const r=e=>{if(e&&e.outerHTML){const t=e.outerHTML.slice(0,1e4);return/cookie/gi.test(t)}};for(let e=0;5>e&&(t=r(i.parentElement),!t);e++)i=i.parentElement;t&&(notifier.fire("accept-cookies"),coreUtils.removeClickHandler(document,e))}};coreUtils.removeClickHandler(document,e),coreUtils.addClickHandler("clickOnAcceptCookies",document,e)}utm_source(){const e=coreUtils.getQueryParamsAsObject()||{};wdl.set({utm_source:e.utm_source?e.utm_source.toLowerCase():null,utm_campaign:e.utm_campaign?e.utm_campaign:null,utmContent:e.utm_content?e.utm_content:null})}scrollBelowTheFold(){wdl.set({scrollBelowTheFold:0}),document.addEventListener("scroll",()=>{window.pageYOffset<window.innerHeight||wdl.set({scrollBelowTheFold:1})})}scrollSpeed(){wdl.set({scrollSpeed:0}),notifier.bind("set-scroll-speed",e=>{wdl.set({scrollSpeed:e})}),setScrollSpeedObserver()}isDay(){const e=new Date,t=e.getHours(),i=6>t||t>17?0:1;wdl.set({isDay:i,hourInDay:t,dayOfSession:DAYS_OF_WEEK[e.getDay()]})}isBot(){wdl.set({isBot:+(e(navigator.userAgent)||wdl.device===BOT_DEVICE)})}isBotEnhanced(){let t=e(navigator.userAgent)||wdl.device===BOT_DEVICE;if(!t){const e=[()=>wdl.device.toLowerCase().indexOf("bot")>=0,()=>(wdl.browser||"").toLowerCase().indexOf("bot")>=0],i=[()=>1!==wdl.get("areMultipleTabsOpen","aiFeature"),()=>1>=wdl.get("clicksInSessionValue","aiFeature"),()=>1>=wdl.get("numOfProductViews","aiFeature"),()=>5===wdl.get("batteryPercentageScore","aiFeature"),()=>1===wdl.get("numOfSessions","aiFeature"),()=>0===(wdl.get("prefLanguage","aiFeature")||"").indexOf("en"),()=>1===wdl.get("pagesUntilReachedSite","aiFeature"),()=>"Direct"===wdl.get("channel","aiFeature"),()=>1!==wdl.get("scrollBelowTheFold","aiFeature"),()=>1!==wdl.get("hasPasswordSaver","aiFeature"),()=>1!==wdl.get("inAppBrowsing","aiFeature")],r=[()=>wdl.get("isCopiedText","aiFeature")>0,()=>wdl.get("numOfInstalled","aiFeature")>0||wdl.get("numOfPopped","aiFeature")>0,()=>wdl.get("hasForceDarkModeExtensions","aiFeature")>0||wdl.get("browsingWithSocialMediaAffiliate","aiFeature")>0||wdl.get("browsingWithVideoConferencingAffiliate","aiFeature")>0||wdl.get("isTubeBlockInstalled","aiFeature")>0,()=>(wdl.get("cryptoExtensions","aiFeature")||[]).length>0||(wdl.get("accessibilityExtensions","aiFeature")||[]).length>0];t=(aiUtils.orBunch(e)||aiUtils.andBunch(i))&&!aiUtils.orBunch(r)}wdl.set({isBotEnhanced:+t})}numOfSessions(){wdl.set({numOfSessions:dal.session.getOne("session_counter")})}timeZone(){const e=dataCollector.dateTimeFormat;e&&wdl.set({timeZone:e.timeZone,locale:e.locale,...locationFromTimezone(e.timeZone)})}deviceLayout(){wdl.set(aiUtils.getScreenAttributes())}timeSinceLastVisitValue(){const e=dal.session.getOne("lset"),t=dal.session.getOne("pvst");let i=-1;if(e){let r=Math.floor((t-e)/6e4)/60;i=Number.isInteger(r)?r:.1>parseFloat(r.toFixed(1))?0:parseFloat(r.toFixed(1))}wdl.set({timeSinceLastVisitValue:i,...aiUtils.calculateScore(i,"timeSinceLastVisitValue",wdl.device)})}batteryIsCharging(){const e=e=>{wdl.set({batteryIsCharging:+e})},t=e=>{const t=Math.round(100*(e||0));wdl.set({batteryPercentageValue:t,...aiUtils.calculateScore(t,"batteryPercentageValue",wdl.device)})};"getBattery"in navigator?navigator.getBattery().then(function(i){i?(e(i.charging),t(i.level),i.addEventListener?(i.addEventListener("chargingchange",function(){e(i.charging)}),i.addEventListener("levelchange",function(){t(i.level)})):aiLoggerManager.warn("Battery API has no addEventListener function.","batteryIsCharging")):aiLoggerManager.warn("Battery API returned None.","batteryIsCharging")}):"webkitBatteryInfo"in navigator?navigator.webkitBatteryInfo(function(i){i?(e(i.charging),t(i.level)):aiLoggerManager.warn("Battery API returned None.","batteryIsCharging")}):aiLoggerManager.warn("Battery API not supported in this browser.","batteryIsCharging")}hasAdBlocker(){let e=0,t=!1;const i=i=>{t&&e||(!t||e||i)&&(t=!0,e=i,wdl.set({hasAdBlocker:i}))};notifier.bind("is-adblocker",i),notifier.bind("is-adstyleblocker",i),detectAdBlocker()}isIncognitoSession(){notifier.bind("detectedIncognitoMode",e=>{wdl.set({isIncognitoSession:e})}),detectIncognitoMode()}isCopiedText(){document.addEventListener("copy",()=>{window.getSelection().toString()&&wdl.set({isCopiedText:1,isUserInteractionOccurred:1})})}isPageAutoTranslated(){let e=0,t=!1;const i=i=>{t&&e||(!t||e||i)&&(t=!0,e=i,wdl.set({isPageAutoTranslated:i}))};i(0),notifier.bind("detect-autotranslate",i),detectAutotranslate()}pageLoadValue(){wdl.set(pagePerformance.getAll())}vpnProbability(){cloudFeatures.perform()}hasPasswordSaver(){notifier.bind("has-password-saver",e=>{wdl.set({hasPasswordSaver:e})}),passwordSaverDetector()}prefLanguage(){let e,t={};if(navigator.languages&&navigator.languages.length>0)e=[...navigator.languages];else{const t=(navigator.language||"").toLowerCase();if(!t)return;e=[t]}e.forEach(e=>{if(e.includes("-")){const i=e.split("-");t[i[0].toLowerCase()]=1}else t[e.toLowerCase()]=1});const i={};Object.entries(LanguageToFeatureName).forEach(([e,r])=>{i[r]=+(t[e]||0)}),Object.keys(t).forEach(e=>{LanguageToFeatureName[e]||(i.isOtherBrowserLanguage=1)}),wdl.set({prefLanguage:aiUtils.getLanguage(),numberOfBrowserLanguages:Object.keys(t).length,browserLanguages:Object.keys(t),...i})}affinityInteractionsWithBlack(){setColorAffinities()}accessibilityExtensions(){["accessibilityExtensions","cryptoExtensions"].forEach(e=>{wdl.needToRecalculate([e],!0)&&checkExtensionGroup(e).then(()=>{}).catch(()=>{})}),[...SOCIAL_MEDIA_EXTENSIONS,...VIDEO_CONFERENCING_EXTENSIONS,"isTubeBlockInstalled"].forEach(e=>{wdl.needToRecalculate([e],!0)&&checkExtension(e).then(()=>{}).catch(()=>{})})}numOfCookieKeys(){propertyCounts.collectAndSetAll(),calculationsCycle.add("propertyCount",propertyCounts.collectAll)}numOfProductViews(){notifier.retroBind("pageType",e=>{const t=dal.session.getOne("productPageViews")||{};e===SiteSections.product&&(t[(document.title||window.location.href||"").slice(0,2e3)]=1,dal.session.set({productPageViews:t},!0)),wdl.set({numOfProductViews:Object.keys(t).length})})}numOfCategoryPageViews(){notifier.retroBind("pageType",e=>{let t=dal.session.getOne("categoryPageViewCount")||0;e===SiteSections.category&&(t++,dal.session.set({categoryPageViewCount:t},!0)),wdl.set({numOfCategoryPageViews:t})})}channel(){wdl.needToRecalculate(["channel"])&&wdl.set({channel:dataCollector.getChannel()})}blockThirdPartyCookies(){checkThirdPartyCookies.detect()}browsingWithShoppingAffiliate(){notifier.bind("inAppBrowsingPackageChanged",e=>{if(e){e=e.toLowerCase();const t=["afterpay","ebates","rakuten","honey","paypal","capitalone","klarna","karma"];for(let i=0,r=t.length;r>i;i++)if(e.indexOf(t[i])>=0)return void wdl.set({browsingWithShoppingAffiliate:1})}})}browsingWithSocialMediaAffiliate(){notifier.bind("inAppBrowsingPackageChanged",e=>{if(e){e=e.toLowerCase();const t=["facebook","tiktok","instagram","pinterest","whatsapp","youtube","snapchat","twitter","reddit","linkedin","tumblr"];for(let i=0,r=t.length;r>i;i++)if(e.indexOf(t[i])>=0)return void wdl.set({browsingWithSocialMediaAffiliate:1})}})}browsingWithVideoConferencingAffiliate(){notifier.bind("inAppBrowsingPackageChanged",e=>{if(e){e=e.toLowerCase();const t=["skype","zoom","googlemeet","wehereby"];for(let i=0,r=t.length;r>i;i++)if(e.indexOf(t[i])>=0)return void wdl.set({browsingWithVideoConferencingAffiliate:1})}})}isForceDarkMode(){const e=document.createElement("div");e.style.height="0",document.body.appendChild(e);const t=window.getComputedStyle(e),i=t.backgroundColor,r=t.color;document.body.removeChild(e);let n=0,s=0;const a={};0>["rgb(0, 0, 0)","rgba(0, 0, 0, 1)"].indexOf(i)&&0>["rgb(255, 255, 255)","rgba(255, 255, 255, 1)"].indexOf(r)||(n=1),!n&&document.querySelector("html").getAttribute("data-darkreader-mode")&&(n=1,s=1),!n&&document.querySelector('link#dark-mode[href*="bkmemecbbfhmgcmfhkjlmdkodfbfponb"], link[id^="dark-mode"][href*="dmghijelimhndkbmpgbldicpogfkceaj"]')&&(n=1,s=1),n||""!==document.querySelector("html").getAttribute("native-dark-active")||(n=1,s=1),!n&&document.querySelector('style[id^="dark-mode-"]')&&document.querySelectorAll('style[id^="dark-mode-"]').forEach(e=>{e.innerText.trim().length&&(n=1,s=1)}),n||"active"!==document.querySelector("html").getAttribute("nighteye")||(n=1,s=1),n||"complete"!==document.querySelector("html").getAttribute("ml-stage")||(n=1,s=1),!n&&document.querySelector("style#csstotlpseudo")&&(n=1,s=1),a.isForceDarkMode=n,s&&(a.hasForceDarkModeExtensions=1),wdl.set(a)}hasForceDarkModeExtensions(){if(!wdl.needToRecalculate(["hasForceDarkModeExtensions"],!0))return;let e=Object.keys(DARK_MODE_EXTENSIONS).length,t=0;notifier.bind("extensions-detected",(i,r)=>{DARK_MODE_EXTENSIONS[i]&&(r||(t++,e>t||wdl.set({hasForceDarkModeExtensions:0})))}),Object.keys(DARK_MODE_EXTENSIONS).forEach(i=>{const r=DARK_MODE_EXTENSIONS[i];switch(r.mode){case"url":checkExtension(i,{[i]:r.value()}).then();break;case"probe":try{r.value()?notifier.fire("extensions-detected",i,1):(t++,e>t||wdl.set({hasForceDarkModeExtensions:0}))}catch(e){aiLoggerManager.error(e,`hasForceDarkModeExtensions: Unable to check the [${i}]:`)}}})}pageZoom(){const e=()=>{const e=Math.round(100*(window.devicePixelRatio||1))/100;return{innerWidth:window.innerWidth,innerHeight:window.innerHeight,outerWidth:window.outerWidth,outerHeight:window.outerHeight,devicePixelRatio:e,pageZoom:(()=>{const t=aiUtils.calculateDPR();let i=t;return wdl.device===Devices.PC&&"macos"!==wdl.get("os","aiFeature")&&t!==e&&(i=1===e?t:e),i})()}};wdl.set(e()),window.__wndz_pageZoom_event_bound||(window.__wndz_pageZoom_event_bound=1,window.addEventListener("resize",coreUtils.throttle(()=>{wdl.set(e())},300)))}pageLanguage(){wdl.set({pageLanguage:document.documentElement.lang||""})}},getActiveFeatureCollectorMethods:()=>{const e=Object.keys(t).reduce((e,i)=>(t[i].forEach(t=>{e[t]=i}),e),{}),r=Object.keys(configurationsGetters.aiFeatures).reduce((t,i)=>(e[i]&&(t[e[i]]=!0),t),{});return Object.keys(r).filter(e=>!!i.includes(e)||wdl.needToRecalculate(t[e].filter(e=>!e.endsWith("Score"))))}}})(),adaptiveSearch=(()=>{const e=new class{constructor(){this.groupLocalStorageKey="adaptiveSearchExperienceGroup",this.groupSizeLocalStorageKey="adaptiveSearchExperienceGroupSize",this.adaptiveSearchConf=null,this.currentConfig=null,this.isAbTest=null,this.notAllowedTestModeMessages={},this.notAllowedTargetMessages={},this.ready=!1,this.wasDisplayedFired=!1,this.forceGuid="",this.forceShow=!1}init(e){if(this.resetLocals(),!e||!Object.keys(e).length)return;this.groupLocalStorageKey=configurationsGetters.params.adaptiveSearchLocalStorageKey||"adaptiveSearchExperienceGroup",this.groupSizeLocalStorageKey=this.groupLocalStorageKey+"Size";const t=configurationsGetters.mappedDomain,i=configurationsGetters.domain;this.adaptiveSearchConf={},e[i]&&e[i].length&&e[i].forEach(e=>{this.adaptiveSearchConf[e.id]=e}),t&&t!==i&&e[t]&&e[t].length&&e[t].forEach(e=>{this.adaptiveSearchConf[e.id]=e}),this.forceGuid=this.getForceGuid(),this.forceShow=this.forceGuid&&liveQA.forceShow||!1,Object.keys(this.adaptiveSearchConf).length&&(notifier.retroBind("reset-adaptive-search",this.resetActiveSearchConf.bind(this)),notifier.retroBind("wdl-ready",this.start.bind(this))),this.ready=!0}resetLocals(){this.adaptiveSearchConf=null,this.currentConfig=null,this.isAbTest=null,this.ready=!1,this.notAllowedTestModeMessages={},this.notAllowedTargetMessages={},this.wasDisplayedFired=!1,this.forceGuid="",this.forceShow=!1}isReady(){return this.ready}start(){const e=dal.session.getOne("adaptiveSearchConf");this.checkStoredConfig(e),this.currentConfig||this.chooseConfig(),this.currentConfig?(calculationsCycle.remove("adaptiveSearchStart"),this.performAdaptiveSearch()):(calculationsCycle.add("adaptiveSearchStart",this.start.bind(this)),wdl.storeSearch(null,""))}resetActiveSearchConf(){this.currentConfig=null,dal.session.set({adaptiveSearchConf:null}),this.setGroup(""),this.setGroupSize(""),aiUtils.sUtils.storeGroup(""),wdl.storeSearch(null,""),this.wasDisplayedFired=!1}checkStoredConfig(e){let t=!1;if(e&&Object.keys(e).length){let i=this.adaptiveSearchConf[e.id];i?(i.testGroupSize&&i.testGroupSize!==e.testGroupSize&&(coreLoggerManager.warn(i.id,"adaptiveSearch: checkStoredConfig: Stored config test group size is different from the config:"),t=!0),i.abTestGroupSize&&i.abTestGroupSize!==e.abTestGroupSize&&(coreLoggerManager.warn(i.id,"adaptiveSearch: checkStoredConfig: Stored config AB test group size is different from the config:"),t=!0),i.isTest!==e.isTest&&(coreLoggerManager.warn(i.id,"adaptiveSearch: checkStoredConfig: Stored config LiveQA flag is different from the config:"),t=!0),t||!i.isTest||liveQA.isTestingMode||(coreLoggerManager.warn(i.id,"adaptiveSearch: checkStoredConfig: Stored config is for a test, but it's no LiveQA runtime:"),t=!0),t||this.forceGuid&&this.forceGuid!==i.id&&(coreLoggerManager.warn(i.id,"adaptiveSearch: checkStoredConfig: Stored config is not the forced one:"),t=!0),t||!1!==i.storedToUser||1!==dal.session.getOne("pv")||(coreLoggerManager.warn(i.id,"adaptiveSearch: checkStoredConfig: Stored config is sticky to the session:"),t=!0),this.currentConfig=i,this.isAbTest=e.isAbTest):t=!0}t&&this.resetActiveSearchConf()}getForceGuid(){const e=liveQA.guid||"";return e&&this.adaptiveSearchConf[e]?e:null}chooseConfig(){const e=Object.values(this.adaptiveSearchConf).filter(e=>{if(e.code=configurationsGetters.getCode(e.code),this.forceGuid){if(e.id!==this.forceGuid)return this.notAllowedTestModeMessages[e.id]||(this.notAllowedTestModeMessages[e.id]=!0,coreLoggerManager.info(`Adaptive search forced to use ${this.forceGuid} instead of ${e.id}`,"AdaptiveSearch")),!1;if(this.forceShow)return coreLoggerManager.info(`Adaptive search forced to use ${this.forceGuid} (forceShow)`,"AdaptiveSearch"),!0;coreLoggerManager.info(`Adaptive search forced to use ${this.forceGuid} (but with the target checks)`,"AdaptiveSearch")}if(e.isTest){if(!liveQA.isTestingMode)return this.notAllowedTestModeMessages[e.id]||(this.notAllowedTestModeMessages[e.id]=!0,coreLoggerManager.info("Test mode is off\n"+(e.code||"!!! no code !!!").slice(0,100),"AdaptiveSearch")),!1;coreLoggerManager.info("Test mode is on\n"+(e.code||"!!! no code !!!").slice(0,100),"AdaptiveSearch")}if(e.t){const t=e.t;if(!aiUtils.checkForTarget(t))return this.notAllowedTargetMessages[e.id]||(this.notAllowedTargetMessages[e.id]=!0,coreLoggerManager.info(`Targeting failed for AdaptiveSearch ${e.id}\n${(e.code||"!!! no code !!!").slice(0,100)}`,"AdaptiveSearch")),!1;coreLoggerManager.info(`Targeting passed for AdaptiveSearch ${e.id}\n${(e.code||"!!! no code !!!").slice(0,100)}`,"AdaptiveSearch")}return!0});if(!e.length)return this.notAllowedTestModeMessages["no-eligible-adaptive-search"]||(this.notAllowedTestModeMessages["no-eligible-adaptive-search"]=!0,coreLoggerManager.warn("No eligible adaptive search found","AdaptiveSearch")),void(this.currentConfig=null);1===e.length?this.currentConfig=e[0]:this.currentConfig=e[Math.floor(Math.random()*e.length)],coreLoggerManager.info("Chosen adaptive search: "+this.currentConfig.id,"AdaptiveSearch")}performAdaptiveSearch(){if(!this.currentConfig)return;if(!this.currentConfig.fallbackList){const{fallbackList:e,fallbackListByLanguage:t}=configurationsGetters.getFallbackList(this.currentConfig.affinityTypes);this.currentConfig.fallbackList=e,this.currentConfig.fallbackListByLanguage=t}const t=this.currentConfig.abTestGroupSize||100;this.isAbTest=100*Math.random()<t,this.storeCurrentConfig();const i={dal:dal,utils:coreUtils,aiUtils:aiUtils,sUtils:aiUtils.sUtils,wdl:wdl,conf:configurationsGetters,fire:notifier.fire.bind(notifier),adaptiveSearch:e};try{Function("context",`const {dal,utils,aiUtils,sUtils,wdl,conf,fire,adaptiveSearch}=context;return (${configurationsGetters.getCode(this.currentConfig.code)})();`)(i)}catch(e){coreLoggerManager.error(e,"AdaptiveSearch"),coreLoggerManager.error(this.currentConfig,"AdaptiveSearch - unable to perform!")}}storeCurrentConfig(){dal.session.set({adaptiveSearchConf:{id:this.currentConfig.id,isTest:this.currentConfig.isTest,isAbTest:this.isAbTest,abTestGroupSize:this.currentConfig.abTestGroupSize,testGroupSize:this.currentConfig.testGroupSize,storedToUser:this.currentConfig.storedToUser}},!0),wdl.storeSearch(this.currentConfig,this.getGroup()||"not_set")}isEligibleToRun(t=!1,i=null,r=null){const n=e.currentConfig.testGroupSize||100;if((()=>{if(e.getGroupSize()!==n.toString())return!1;const t=e.getGroup();return t&&"not_set"!==t})()){if(e.storeGroup(e.getGroup()),i)try{i()}catch(e){coreLoggerManager.error(e,"AdaptiveSearch - error on alreadyCalculatedCallback: ")}return e.isTestGroup()}if(t){if((()=>{const t=100*Math.random()<n?"test":"control";e.setGroup(t),e.setGroupSize(n),e.storeGroup(e.getGroup())})(),r)try{r()}catch(e){coreLoggerManager.error(e,"AdaptiveSearch - error on afterCalculationCallback: ")}return e.isTestGroup()}return e.setGroup("not_set"),e.setGroupSize(""),e.storeGroup(e.getGroup()),!0}setGroupSize(t){localStorage.setItem(e.groupSizeLocalStorageKey,t.toString())}getGroupSize(){return localStorage.getItem(e.groupSizeLocalStorageKey)||""}setGroup(t){localStorage.setItem(e.groupLocalStorageKey,t)}getGroup(){return localStorage.getItem(e.groupLocalStorageKey)||""}isTestGroup(){return e.forceShow||"test"===e.getGroup()}getSuggestions(t,i=null,r=null,n=!1,s="English",a=null,o=null){if(t=(t||"").trim().toLowerCase(),-1!==e.currentConfig.numCharactersStopShowing&&t&&t.trim().length>=e.currentConfig.numCharactersStopShowing)return[];e.currentConfig.promoteExclude&&e.currentConfig.promoteExclude.promote&&(r=[...e.currentConfig.promoteExclude.promote,...r||[]]),e.currentConfig.promoteExclude&&e.currentConfig.promoteExclude.exclude&&(i=[...e.currentConfig.promoteExclude.exclude,...i||[]]),!0===s&&(s="English");const c=(configurationsGetters.configurations.colorTranslations||{})[s]||{};let l,d=aiUtils.sUtils.collectAffinities(100,e.currentConfig.affinityTypes,s,c);return r&&r.length&&(d=[...d,...r]),t&&(d=d.filter(e=>e.indexOf(t)>=0)),l=e.currentConfig.fallbackListByLanguage&&e.currentConfig.fallbackListByLanguage[s]||e.currentConfig.fallbackList,i&&i.length&&(d=d.filter(e=>!i.includes(e)),l=l.filter(e=>!i.includes(e))),aiUtils.sUtils.addTopAffinities(d,r&&r.length&&n?r:l,e.currentConfig.suggestionsMaxQty,e.currentConfig.prioritizeBy,a,o)}generateItems(t,i,r="&",n=null){return aiUtils.sUtils.generateItems(t,i,e.currentConfig.addUrlParam,configurationsGetters.params.adaptiveSearchUrlParamName||"search_type",r||"&",n)}storeSuggestions(t){aiUtils.sUtils.storeSuggestions(t),e.wasDisplayedFired||(notifier.fire("adaptive-search-displayed",e.currentConfig.id,t),e.wasDisplayedFired=!0)}storeClicked(t){notifier.fire("adaptive-search-term-clicked",e.currentConfig.id,t),aiUtils.sUtils.storeClicked(t)}storeGroup(t){aiUtils.sUtils.storeGroup(t,e.currentConfig.id,e.currentConfig.isTest),wdl.storeSearch(e.currentConfig,t)}waitAndPerform(e,t,i){return aiUtils.sUtils.waitAndPerform(e,t,i)}debounce(e,t,...i){return aiUtils.sUtils.debounce(e,t,...i)}addClickedListener(t,i){document.querySelectorAll(t).forEach(t=>{coreUtils.addClickHandler("adaptiveSearch.clickedTerm",t,t=>{e.storeClicked(t.target.innerText),i&&i(t)},!0)})}};return e})(),{initAiFeatures:initAiFeatures}=(()=>{const e=async()=>{notifier.bind("extensions-detected",(e,t)=>{if(DARK_MODE_EXTENSIONS[e])t&&wdl.set({hasForceDarkModeExtensions:1});else{if(wdl.set({[e]:t}),SHOPPING_EXTENSIONS.indexOf(e)>=0){const e=wdl.getBranch(INSTALLS_SHOPPING_FEATURES_PATH),t=Object.keys(e.installed).filter(t=>e.installed[t]).length;wdl.set({numOfInstalled:t,browsingWithShoppingAffiliate:+!!t})}t&&SOCIAL_MEDIA_EXTENSIONS.indexOf(e)>=0&&wdl.set({browsingWithSocialMediaAffiliate:1}),t&&VIDEO_CONFERENCING_EXTENSIONS.indexOf(e)>=0&&wdl.set({browsingWithVideoConferencingAffiliate:1})}}),await brandAndCategoryAffinity.init(),customAffinity.init(),affinityAccumulator.init(),userEvents.init(),await coreUtils.yieldToMain(),await t();let e=0;for(const t of getActiveFeatureCollectorMethods()){try{featureCollector[t]()}catch(e){aiLoggerManager.error(e,`featureCollector: [${t}] calculation error!`)}e++,10===e&&(await coreUtils.yieldToMain(),e=0)}await coreUtils.yieldToMain(),pageTypeDetector.detect()},t=async()=>{const e=SHOPPING_EXTENSIONS.filter(e=>wdl.needToRecalculate([e],!0)),t=SHOPPING_EXTENSIONS.filter(e=>!!wdl.aiNameToObjMapping[e]);aiLoggerManager.info(`\nextensionsToDetect: ${JSON.stringify(e)}\nextensionsToHandle: ${JSON.stringify(t)}`,"detectShoppingExtensions"),await shoppingExtensions.start(e,t)};return{initAiFeatures:async t=>{aiLoggerManager.info("Start to init","Main Init"),notifier.bind("wdl-ready",e),await pageTypeDetector.init(),await audienceDetector.init(),await predictions.init(),await customAiFeatures.init(),activations.init(),await interactions.init(),await wdl.init(t)}}})(),liveQA=(()=>{const e={isTestingMode:{key:"wandz_testing",isBoolean:!0},guid:{key:"wandz_guid",isBoolean:!1},forceShow:{key:"wandz_force_show",isBoolean:!0}};return new class{constructor(){this.isTestingMode=!1,this.guid="",this.forceShow=!1}init(){const t=new URLSearchParams(window.location.search);Object.keys(e).forEach(e=>{this.extractValue(e,t)})}extractValue(t,i){const r=e[t];let n=i.get(r.key),s=window.sessionStorage.getItem(r.key);(n&&n!==s||""===n&&!r.isBoolean)&&(window.sessionStorage.setItem(r.key,n),""===n&&(s=""));let a=n||s||"";r.isBoolean&&(a="1"===a),this[t]=a}}})(),{initCore:initCore}={initCore:async(e,t)=>{t||domUtils.firePageLoadWhenReady(),t||"String"in window&&!"".each&&[].forEach&&(String.prototype.each=[].forEach);const i=[()=>{storageManagers.init()},()=>{beforeunloadHandler.init()},()=>{session.init(e)},()=>{liveQA.init()},()=>{!t&&hookReader.isReady()||hookReader.init(e.hookReader)},()=>{!t&&hookWriter.isReady()||hookWriter.init(e.hookWriter)},()=>{!t&&abTests.isReady()||abTests.init(e.abTests)},()=>{!t&&adaptiveCarousel.isReady()||adaptiveCarousel.init(e.adaptiveCarousel)},()=>{!t&&adaptiveSearch.isReady()||adaptiveSearch.init(e.adaptiveSearch)},()=>{performanceMeasurer.init()},()=>{!t&&dataCollector.isReady()||dataCollector.init(e)},()=>{coreReports.init()},()=>{calculationsCycle.init()},()=>{window.__dbn_on__&&(coreLoggerManager.info("Expose some modules to the global context (window.wndz object) because of window.__dbn_on__="+window.__dbn_on__,"Init Core"),window.wndz={notifier:notifier,snapshot:e,dal:dal,coreReports:coreReports,coreTracker:coreTracker,calculationsCycle:calculationsCycle,adaptiveSearch:adaptiveSearch,abTests:abTests,adaptiveCarousel:adaptiveCarousel})}];for(let e=0;i.length>e;e++){const t=i[e];try{t()}catch(t){throw coreLoggerManager.error(t,"Init Core Error:"),Error(`Failed in Init Core at function ${e} Error: ${t}`)}await coreUtils.yieldToMain()}calculationsCycle.add("persistStorages",storageManagers.persistAll.bind(storageManagers)),notifier.bind("isTabInFocus-calculated",e=>{coreLoggerManager.info(e,"isFocus"),e?(storageManagers.reloadAll(),calculationsCycle.add("persistStorages",storageManagers.persistAll.bind(storageManagers))):(storageManagers.persistAll(),calculationsCycle.remove("persistStorages"))}),beforeunloadHandler.addPersistStorageHandler(()=>{storageManagers.persistAll.call(storageManagers,!0),storageManagers.markAllForce.apply(storageManagers)}),coreLoggerManager.info("Started","CORE"),await initAiFeatures(t)}};class IndexWandz{constructor(){this.isDev=!1}async init(){const{url:e,clientTag:t}=this.getUrlWithClientTagFromScriptElement(),i=__INJECTIONS__.isDemo?"wandz_demo_tag_loaded":"wandz_tag_loaded";if(window[i]){const e=`Wandz ${__INJECTIONS__.isDemo?"DEMO":""} tag already loaded, skipping initialization`;throw coreLoggerManager.error(e,"Duplicate Tag:"),Error("Duplicate Tag, exiting")}if(window[i]=1,coreTracker.init(__INJECTIONS__.stackHost,"jdldata/"),coreLoggerManager.info(__INJECTIONS__,"Tag configurations:"),this.snapshot=await prepareSnapshot(t,e,this.isDev),!this.snapshot)throw Error("No snapshot, exiting");configurationsGetters.init(this.snapshot),coreLoggerManager.info(this.snapshot,"snapshot:")}async run(e=!1){try{const t=(configurationsGetters.snapshot.params._tag||{}).domainIdentificationMethod||(configurationsGetters.snapshot.params._||{}).domainIdentificationMethod,i=coreUtils.findRelevantDomain(t,this.snapshot.domains);i?configurationsGetters.currentDomain=i:configurationsGetters.runningDomain=coreUtils.getCurrentDomain(),configurationsGetters.recalculateMappedDomain(),e?(coreLoggerManager.info("ForceInit - no wait for PageLoad and scriptDelay","Run"),await this.postScriptDelayRun(e)):(configurationsGetters.params.post_pageload?(coreLoggerManager.info("Wait for page-load event...","Run"),notifier.retroBind("page-load",async()=>this.postPageLoadRun(e))):await this.postPageLoadRun(e),domUtils.firePageLoadWhenReady())}catch(e){try{coreLoggerManager.error(e,"Run error"),!this.isDev&&coreTracker.isReady()&&coreTracker.reportEventsError("sendGetEventViaWebWorker",{message:e.message,stack:e.stack})}catch(e){}}}async postPageLoadRun(e){const t=configurationsGetters.params.script_delay;coreLoggerManager.info(`Wait ${t} ms...`,"postPageLoadRun"),t?setTimeout(()=>this.postScriptDelayRun(e).then(()=>{}),t):await this.postScriptDelayRun(e)}async postScriptDelayRun(e){await initCore(this.snapshot,e),configurationsGetters.params.is_spa&&spaHandler.listenToUrlChanges(()=>{notifier.fire("beforeunload"),storageManagers.persistAll(),setTimeout(()=>{notifier.clear(),indexWandz.run(!0)},100)})}getUrlWithClientTagFromScriptElement(){try{let e=document.currentScript.src.split(".js")[0];const t=e.split("/");let i=t[t.length-1],r=e.split(i)[0];r.startsWith("https:")||r.startsWith("http:")||r.startsWith("chrome-extension")||(r="https:"+r),i.endsWith(scriptLetter)&&(i=i.slice(0,-scriptLetter.length));const n=r.includes("localhost");return this.isDev=i.startsWith("dev_")||i.startsWith("stg_")||n,{url:r,clientTag:i}}catch(e){return coreLoggerManager.error(e,"Failed to getUrlWithClientTagFromScriptElement with error"),{url:"",clientTag:""}}}}let indexWandz=new IndexWandz;indexWandz.init().then(()=>{indexWandz.run().catch(coreLoggerManager.error.bind(coreLoggerManager))}).catch(coreLoggerManager.error.bind(coreLoggerManager))})();